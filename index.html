<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ultimate Solar System Explorer - Complete Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Space Mono', monospace; touch-action: none; }
        
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: linear-gradient(180deg, rgba(10, 10, 30, 0.8) 0%, rgba(20, 20, 50, 0.8) 100%); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(59, 130, 246, 0.8) 0%, rgba(139, 92, 246, 0.8) 100%); border-radius: 10px; border: 2px solid rgba(10, 10, 30, 0.5); }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, rgba(59, 130, 246, 1) 0%, rgba(139, 92, 246, 1) 100%); box-shadow: 0 0 10px rgba(59, 130, 246, 0.8); }
        * { scrollbar-width: thin; scrollbar-color: rgba(59, 130, 246, 0.8) rgba(10, 10, 30, 0.8); }
        
        #info-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 20, 40, 0.9) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6); max-height: 90vh; overflow-y: auto; }
        .planet-button { transition: all 0.3s ease; border-left: 3px solid transparent; }
        .planet-button:hover { transform: scale(1.05) translateX(5px); background: rgba(59, 130, 246, 0.3); border-left-color: #60a5fa; }
        .planet-button.active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.6) 0%, rgba(59, 130, 246, 0.2) 100%); border-left: 4px solid #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
        .title { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 15px rgba(59, 130, 246, 0.7); }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #000000 0%, #1a1a2e 50%, #0f3460 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.5s ease; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid rgba(59, 130, 246, 0.2); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .control-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 20, 40, 0.9) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); }
        .toggle-btn { padding: 8px 16px; border-radius: 6px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); transition: all 0.3s ease; cursor: pointer; }
        .toggle-btn:hover { background: rgba(59, 130, 246, 0.4); transform: scale(1.05); }
        .toggle-btn.active { background: rgba(59, 130, 246, 0.7); border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .fun-fact { background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2)); border-left: 3px solid #8b5cf6; padding: 12px; margin: 8px 0; border-radius: 4px; }
        .event-notification { position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(59, 130, 246, 0.95)); padding: 20px 40px; border-radius: 10px; box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); z-index: 100; display: none; animation: slideIn 0.5s ease; }
        @keyframes slideIn { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
        .search-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 40, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); }
        .comparison-view { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px); border: 2px solid rgba(100, 150, 255, 0.6); border-radius: 10px; padding: 20px; z-index: 200; display: none; max-width: 80vw; max-height: 80vh; overflow-y: auto; }
        .achievement-popup { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9)); color: #000; padding: 15px 25px; border-radius: 8px; box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); z-index: 150; display: none; animation: bounceIn 0.6s ease; }
        @keyframes bounceIn { 0% { transform: scale(0); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @media (max-width: 768px) { #info-panel { max-width: 90vw; font-size: 0.875rem; } .control-panel { font-size: 0.75rem; } }
        .eclipse-shadow { position: absolute; width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, rgba(0,0,0,0.8), transparent); pointer-events: none; }
        
        .tooltip { position: absolute; background: rgba(0, 0, 0, 0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; pointer-events: none; z-index: 10000; white-space: nowrap; opacity: 0; transition: opacity 0.2s ease; box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); border: 1px solid rgba(59, 130, 246, 0.5); max-width: 250px; white-space: normal; }
        .tooltip.show { opacity: 1; }
        .tooltip::before { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid rgba(0, 0, 0, 0.9); }
        .tooltip.below::before { bottom: auto; top: -6px; border-top: none; border-bottom: 6px solid rgba(0, 0, 0, 0.9); }
        
        .calculator-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 40, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); }
        
        /* Mission Planning Mode */
        .mission-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 40, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 100, 150, 0.4); }
        .mission-trajectory { stroke-dasharray: 5, 5; animation: dash 20s linear infinite; }
        @keyframes dash { to { stroke-dashoffset: -1000; } }
        .transfer-orbit { stroke: #ff6b6b; stroke-width: 2; fill: none; opacity: 0.7; }
        .gravity-assist-arrow { fill: #ffd93d; opacity: 0.8; }
    </style>
</head>
<body class="bg-black">
    <div id="loading-screen">
        <div class="loading-spinner mb-4"></div>
        <h2 class="text-white text-2xl font-bold title">Loading Ultimate Solar System...</h2>
        <p class="text-blue-300 text-sm mt-2">Initializing 3,531+ Objects...</p>
        <div class="w-64 h-2 bg-gray-800 rounded-full mt-4 overflow-hidden">
            <div id="loading-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
        </div>
        <p class="text-gray-400 text-xs mt-2" id="loading-text">Loading stars...</p>
    </div>

    <div id="event-notification" class="event-notification">
        <h3 class="text-white text-xl font-bold title mb-2">üåü Cosmic Event!</h3>
        <p class="text-white" id="event-text"></p>
    </div>

    <div id="achievement-popup" class="achievement-popup">
        <h3 class="font-bold text-lg mb-1">üèÜ Achievement Unlocked!</h3>
        <p id="achievement-text"></p>
    </div>

    <div id="search-panel" class="absolute top-20 left-4 text-white search-panel p-4 rounded-lg max-w-xs z-10" style="display:none;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold title">üîç Search Objects</h3>
            <button onclick="toggleSearch()" class="text-white text-xl hover:text-red-400">&times;</button>
        </div>
        <input type="text" id="search-input" placeholder="Type planet or moon name..." class="w-full p-2 rounded bg-gray-800 text-white border border-blue-500 mb-3 focus:border-purple-400 focus:outline-none" autocomplete="off">
        <div id="search-results" class="space-y-1 max-h-80 overflow-y-auto"></div>
        <div id="search-help" class="text-xs text-gray-400 mt-3 border-t border-gray-700 pt-2">
            <p class="mb-1">üí° Try searching for:</p>
            <div class="grid grid-cols-2 gap-1">
                <button onclick="searchFor('Earth')" class="text-left hover:text-blue-400">‚Ä¢ Earth</button>
                <button onclick="searchFor('Jupiter')" class="text-left hover:text-blue-400">‚Ä¢ Jupiter</button>
                <button onclick="searchFor('Titan')" class="text-left hover:text-blue-400">‚Ä¢ Titan</button>
                <button onclick="searchFor('Halley')" class="text-left hover:text-blue-400">‚Ä¢ Halley</button>
            </div>
        </div>
    </div>

    <div id="comparison-view" class="comparison-view">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold title text-white">üìä Planet Comparison</h2>
            <button onclick="closeComparison()" class="text-white text-2xl hover:text-red-400">&times;</button>
        </div>
        <div id="comparison-content" class="text-white"></div>
    </div>

    <div id="calculator-panel" class="absolute top-20 right-4 text-white calculator-panel p-4 rounded-lg max-w-xs z-10" style="display:none;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold title">üßÆ Science Calculator</h3>
            <button onclick="toggleCalculator()" class="text-white text-xl hover:text-red-400">&times;</button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="text-xs text-gray-400">Your Weight (kg):</label>
                <input type="number" id="user-weight" value="70" class="w-full p-2 rounded bg-gray-800 text-white border border-blue-500 focus:outline-none" min="1" max="500">
            </div>
            <div id="calc-results" class="text-xs space-y-2 border-t border-gray-700 pt-2">
                <p class="text-gray-400">Select a planet to see calculations...</p>
            </div>
        </div>
    </div>

    <div id="mission-panel" class="absolute bottom-20 right-4 text-white mission-panel p-4 rounded-lg max-w-md z-10" style="display:none;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold title">üöÄ Mission Planning</h3>
            <button onclick="toggleMissionPlanner()" class="text-white text-xl hover:text-red-400">&times;</button>
        </div>
        <div class="space-y-3">
            <div class="grid grid-cols-2 gap-2 text-xs">
                <div>
                    <label class="text-gray-400">From:</label>
                    <select id="mission-from" class="w-full p-2 rounded bg-gray-800 text-white border border-pink-500 focus:outline-none">
                        <option value="earth">Earth</option>
                        <option value="mars">Mars</option>
                        <option value="venus">Venus</option>
                        <option value="mercury">Mercury</option>
                        <option value="jupiter">Jupiter</option>
                        <option value="saturn">Saturn</option>
                    </select>
                </div>
                <div>
                    <label class="text-gray-400">To:</label>
                    <select id="mission-to" class="w-full p-2 rounded bg-gray-800 text-white border border-pink-500 focus:outline-none">
                        <option value="mars">Mars</option>
                        <option value="jupiter">Jupiter</option>
                        <option value="saturn">Saturn</option>
                        <option value="venus">Venus</option>
                        <option value="mercury">Mercury</option>
                        <option value="earth">Earth</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="text-xs text-gray-400">Spacecraft Mass (kg):</label>
                <input type="number" id="spacecraft-mass" value="1000" class="w-full p-2 rounded bg-gray-800 text-white border border-pink-500 focus:outline-none" min="100" max="100000">
            </div>

            <button onclick="calculateMission()" class="w-full toggle-btn text-sm bg-pink-600 hover:bg-pink-700">üéØ Calculate Transfer</button>
            
            <div id="mission-results" class="text-xs space-y-2 border-t border-pink-700 pt-2 mt-3">
                <p class="text-gray-400">Configure your mission above...</p>
            </div>

            <div class="border-t border-pink-700 pt-2 mt-2">
                <p class="text-xs font-semibold text-pink-300 mb-2">üéÆ Gravity Assist Options:</p>
                <div class="space-y-1">
                    <label class="flex items-center text-xs">
                        <input type="checkbox" id="assist-venus" class="mr-2">
                        <span>Use Venus flyby</span>
                    </label>
                    <label class="flex items-center text-xs">
                        <input type="checkbox" id="assist-jupiter" class="mr-2">
                        <span>Use Jupiter flyby</span>
                    </label>
                </div>
            </div>

            <button onclick="visualizeMission()" class="w-full toggle-btn text-sm mt-2">üëÅÔ∏è Visualize Trajectory</button>
        </div>
    </div>

    <div id="info-panel" class="absolute top-4 left-4 text-white p-6 rounded-lg max-w-sm z-10">
        <h1 class="text-2xl font-bold mb-2 title">üåå Solar System Ultimate</h1>
        <p class="text-sm text-gray-300 mb-4">üöÄ Click | üéÆ Drag | üîç Scroll | ‚è±Ô∏è Time Travel</p>
        
        <div class="mb-4 p-3 bg-gradient-to-r from-blue-900 to-purple-900 bg-opacity-40 rounded">
            <p class="text-xs text-gray-400">Simulation Date & Time</p>
            <p class="text-lg font-semibold" id="current-date">Jan 1, 2024</p>
            <p class="text-xs text-blue-300 mt-1" id="earth-time">Earth Time: 00:00:00</p>
            <p class="text-xs text-yellow-300 mt-1" id="elapsed-years">Elapsed: 0 years</p>
        </div>

        <div id="planet-info" class="mb-4">
            <h2 class="text-xl font-semibold mb-2" id="planet-name">The Sun</h2>
            <p class="text-sm" id="planet-description">The star at the center of our solar system.</p>
            <div class="mt-2 text-xs space-y-1" id="planet-stats"></div>
            <div id="fun-fact" class="fun-fact mt-3 hidden">
                <p class="text-xs font-semibold text-purple-300">üí° Fun Fact</p>
                <p class="text-xs mt-1" id="fact-text"></p>
            </div>
            <div id="mythology" class="fun-fact mt-3 hidden" style="border-left-color: #f59e0b;">
                <p class="text-xs font-semibold text-yellow-300">üìú Mythology</p>
                <p class="text-xs mt-1" id="mythology-text"></p>
            </div>
            <div id="discovery" class="fun-fact mt-3 hidden" style="border-left-color: #10b981;">
                <p class="text-xs font-semibold text-green-300">üî≠ Discovery</p>
                <p class="text-xs mt-1" id="discovery-text"></p>
            </div>
        </div>
        
        <div class="space-y-2">
            <h3 class="text-sm font-semibold text-gray-400">Celestial Bodies:</h3>
            <div id="planet-buttons" class="space-y-1"></div>
        </div>

        <div id="moon-buttons-container" class="mt-4 space-y-2" style="display:none;">
            <h3 class="text-sm font-semibold text-gray-400">Moons of <span id="moon-parent-name"></span>:</h3>
            <div id="moon-buttons" class="space-y-1 pl-2"></div>
        </div>

        <div class="mt-4 p-3 bg-gray-900 bg-opacity-50 rounded text-xs">
            <p class="font-semibold mb-1">üèÜ Achievements: <span id="achievement-count">0/10</span></p>
            <p class="font-semibold mb-1">Quick Stats:</p>
            <p>üìä Total Objects: <span id="total-objects">-</span></p>
            <p>üåç Planets: 8 | üåô Moons: 146+</p>
            <p>‚òÑÔ∏è Asteroids: 3500 | ü™ê Dwarf: 5</p>
            <p>üöÄ Missions: 3 | ‚òÑÔ∏è Comets: 1</p>
            <p>üéØ FPS: <span id="fps-counter">60</span></p>
        </div>
    </div>

    <div class="absolute top-4 right-4 text-white control-panel p-4 rounded-lg z-10 max-w-xs">
        <div class="mb-4">
            <label class="text-sm font-semibold block mb-2">‚ö° Speed: <span id="speed-display">1.0x</span></label>
            <input type="range" id="speed-slider" min="-50" max="100" step="1" value="1" class="w-full">
            <div class="flex justify-between text-xs mt-1">
                <span>‚è™ -50x</span>
                <span>‚è© 100x</span>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">üïê Time Jump</p>
            <div class="grid grid-cols-3 gap-1 text-xs">
                <button onclick="jumpTime(-365)" class="toggle-btn">-1 Year</button>
                <button onclick="jumpTime(-30)" class="toggle-btn">-1 Month</button>
                <button onclick="jumpTime(-1)" class="toggle-btn">-1 Day</button>
                <button onclick="jumpTime(1)" class="toggle-btn">+1 Day</button>
                <button onclick="jumpTime(30)" class="toggle-btn">+1 Month</button>
                <button onclick="jumpTime(365)" class="toggle-btn">+1 Year</button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">üì∑ Camera Views</p>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setCameraPreset('overview')" class="toggle-btn text-xs">üåå Overview</button>
                <button onclick="setCameraPreset('top')" class="toggle-btn text-xs">‚¨ÜÔ∏è Top</button>
                <button onclick="setCameraPreset('side')" class="toggle-btn text-xs">‚û°Ô∏è Side</button>
                <button onclick="startTour()" class="toggle-btn text-xs">üöÄ Tour</button>
                <button onclick="setCameraPreset('inner')" class="toggle-btn text-xs">üîç Inner</button>
                <button onclick="setCameraPreset('outer')" class="toggle-btn text-xs">üå† Outer</button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">üé® Display Options</p>
            <div class="grid grid-cols-2 gap-2 text-xs">
                <button id="toggle-orbits" onclick="toggleOrbits()" class="toggle-btn active">Orbits</button>
                <button id="toggle-trails" onclick="toggleTrails()" class="toggle-btn active">Trails</button>
                <button id="toggle-labels" onclick="toggleLabels()" class="toggle-btn active">Labels</button>
                <button id="toggle-moons" onclick="toggleMoons()" class="toggle-btn active">Moons</button>
                <button id="toggle-asteroids" onclick="toggleAsteroids()" class="toggle-btn active">Asteroids</button>
                <button id="toggle-dwarf" onclick="toggleDwarfPlanets()" class="toggle-btn active">Dwarf</button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">üî¨ Advanced</p>
            <div class="space-y-2 text-xs">
                <button onclick="toggleHabitableZone()" class="toggle-btn w-full">üü¢ Habitable Zone</button>
                <button onclick="toggleLagrangePoints()" class="toggle-btn w-full">‚≠ï Lagrange Points</button>
                <button onclick="toggleAxialTilt()" class="toggle-btn w-full">üåç Axial Tilt</button>
                <button onclick="toggleEclipses()" class="toggle-btn w-full">üåë Eclipses</button>
            </div>
        </div>

        <div class="space-y-2 text-xs">
            <button onclick="toggleSearch()" class="toggle-btn w-full">üîç Search</button>
            <button onclick="showComparison()" class="toggle-btn w-full">üìä Compare</button>
            <button onclick="toggleCalculator()" class="toggle-btn w-full">üßÆ Calculator</button>
            <button onclick="toggleMissionPlanner()" class="toggle-btn w-full">üöÄ Mission Plan</button>
            <button onclick="takeScreenshot()" class="toggle-btn w-full">üì∏ Screenshot</button>
            <button onclick="playSound()" class="toggle-btn w-full" id="sound-btn">üîá Sound OFF</button>
        </div>
    </div>

    <div class="absolute bottom-4 left-4 text-white text-xs bg-black bg-opacity-80 p-4 rounded-lg backdrop-blur-sm">
        <p class="font-semibold mb-1">üéÆ Controls:</p>
        <p>üñ±Ô∏è Left Drag: Rotate | ‚öôÔ∏è Scroll: Zoom</p>
        <p>üì± Touch: Pan & Pinch | üñ±Ô∏è Click: Select</p>
        <p id="distance-indicator" class="mt-2 text-blue-300">Distance: -</p>
        <p id="speed-indicator" class="text-green-300">Orbital Speed: -</p>
        <p id="conjunction-indicator" class="text-purple-300">Next Conjunction: Calculating...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Loading progress simulation
        let loadProgress = 0;
        const loadInterval = setInterval(() => {
            loadProgress += Math.random() * 15;
            if (loadProgress >= 100) {
                loadProgress = 100;
                clearInterval(loadInterval);
            }
            document.getElementById('loading-bar').style.width = loadProgress + '%';
            const stages = ['Loading stars...', 'Creating planets...', 'Adding moons...', 'Populating asteroid belt...', 'Initializing missions...', 'Almost ready...'];
            const stage = Math.floor(loadProgress / 100 * stages.length);
            document.getElementById('loading-text').textContent = stages[Math.min(stage, stages.length - 1)];
        }, 200);

        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.00015);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 15000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        let showOrbits = true, showTrails = true, showLabels = true, showMoons = true, showAsteroids = true;
        let showDwarfPlanets = true, showHabitableZone = false, showLagrangePoints = false;
        let soundEnabled = false, isTourActive = false, tourIndex = 0, showAxialTilt = false, showEclipses = false;
        let simulationDate = new Date(2024, 0, 1, 0, 0, 0);
        let startDate = new Date(2024, 0, 1, 0, 0, 0);
        let achievements = new Set();
        let audioContext = null;
        let visitedPlanets = new Set();
        let startTime = Date.now();

        const ambientLight = new THREE.AmbientLight(0x222222, 0.5);
        scene.add(ambientLight);
        const sunLight = new THREE.PointLight(0xffffff, 2.5, 5000);
        sunLight.castShadow = true;
        scene.add(sunLight);

        const starGeometry = new THREE.BufferGeometry();
        const starVertices = [], starColors = [];
        for (let i = 0; i < 25000; i++) {
            starVertices.push((Math.random() - 0.5) * 10000, (Math.random() - 0.5) * 10000, (Math.random() - 0.5) * 10000);
            const c = Math.random();
            starColors.push(c > 0.9 ? 0.5 : 1, c > 0.9 ? 0.7 : c > 0.7 ? 0.8 : c > 0.5 ? 0.6 : 1, c > 0.9 ? 1 : c > 0.7 ? 0.6 : c > 0.5 ? 0.4 : 1);
        }
        starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
        starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));
        scene.add(new THREE.Points(starGeometry, new THREE.PointsMaterial({ size: 3, vertexColors: true, transparent: true, opacity: 0.9 })));

        const planetData = {
            sun: { name: 'The Sun', radius: 20, color: 0xfdb813, distance: 0, speed: 0, tilt: 0, rotationSpeed: 0.001,
                description: 'The star at the center of our solar system.', stats: { diameter: '1,392,700 km', mass: '1.989 √ó 10¬≥‚Å∞ kg', temperature: '5,778 K' },
                funFact: 'The Sun converts 600 million tons of hydrogen into helium every second!', mythology: 'Helios drove a chariot across the sky.',
                discovery: 'Known since ancient times', escapeVelocity: 617.5, gravity: 274, orbitalPeriod: 0 },
            mercury: { name: 'Mercury', radius: 2.4, color: 0x8c7853, distance: 40, speed: 0.04, tilt: 0.034, rotationSpeed: 0.001,
                description: 'Smallest planet with extreme temperatures.', stats: { diameter: '4,879 km', 'orbital period': '88 days', moons: '0' },
                funFact: 'Mercury\'s day is longer than its year!', mythology: 'Named after the Roman messenger god.',
                discovery: 'Known since ancient times', escapeVelocity: 4.3, gravity: 3.7, orbitalPeriod: 88 },
            venus: { name: 'Venus', radius: 6, color: 0xffc649, distance: 60, speed: 0.015, tilt: 177.4, rotationSpeed: -0.0004,
                description: 'Earth\'s sister planet with toxic atmosphere.', stats: { diameter: '12,104 km', moons: '0' },
                funFact: 'Venus rotates backwards!', mythology: 'Roman goddess of love and beauty.',
                discovery: 'Known since ancient times', escapeVelocity: 10.4, gravity: 8.9, orbitalPeriod: 225 },
            earth: { name: 'Earth', radius: 6.4, color: 0x4a90e2, distance: 80, speed: 0.01, tilt: 23.5, rotationSpeed: 0.01,
                description: 'Our home planet.', stats: { diameter: '12,742 km', population: '8 billion+', moons: '1 (Moon)' },
                funFact: '71% covered in water!', mythology: 'Gaia, Greek goddess of Earth.',
                discovery: 'Our home planet', escapeVelocity: 11.2, gravity: 9.8, hasMoons: true, hasStation: true, orbitalPeriod: 365 },
            mars: { name: 'Mars', radius: 3.4, color: 0xdc4b3e, distance: 100, speed: 0.008, tilt: 25.2, rotationSpeed: 0.01,
                description: 'The Red Planet.', stats: { diameter: '6,779 km', moons: '2 (Phobos, Deimos)' },
                funFact: 'Olympus Mons is 21 km high!', mythology: 'Roman god of war.',
                discovery: 'Known since ancient times', escapeVelocity: 5.0, gravity: 3.7, hasMoons: true, orbitalPeriod: 687 },
            jupiter: { name: 'Jupiter', radius: 11, color: 0xd4a574, distance: 140, speed: 0.002, tilt: 3.1, rotationSpeed: 0.04,
                description: 'Largest planet with Great Red Spot.', stats: { diameter: '139,820 km', moons: '95+ (Io, Europa, Ganymede, Callisto + 91 more)' },
                funFact: 'Great Red Spot has raged for 400+ years!', mythology: 'King of Roman gods.',
                discovery: 'Known since ancient times', escapeVelocity: 59.5, gravity: 24.8, hasMoons: true, orbitalPeriod: 4333 },
            saturn: { name: 'Saturn', radius: 9.5, color: 0xe5c287, distance: 180, speed: 0.0009, tilt: 26.7, rotationSpeed: 0.038,
                description: 'Famous for its ring system.', stats: { diameter: '116,460 km', moons: '146+ (Titan, Rhea, Enceladus + 143 more)' },
                funFact: 'Saturn would float in water!', mythology: 'Roman god of agriculture.',
                discovery: 'Known since ancient times', escapeVelocity: 35.5, gravity: 10.4, hasMoons: true, orbitalPeriod: 10759 },
            uranus: { name: 'Uranus', radius: 4, color: 0x4fd0e7, distance: 220, speed: 0.0004, tilt: 97.8, rotationSpeed: -0.02,
                description: 'Ice giant rotating on its side.', stats: { diameter: '50,724 km', tilt: '97.8¬∞', moons: '27 (Titania, Oberon + 25 more)' },
                funFact: 'Uranus rotates nearly on its side!', mythology: 'Greek god of the sky.',
                discovery: 'Discovered by William Herschel in 1781', escapeVelocity: 21.3, gravity: 8.9, hasMoons: true, orbitalPeriod: 30687 },
            neptune: { name: 'Neptune', radius: 3.9, color: 0x4166f5, distance: 260, speed: 0.0001, tilt: 28.3, rotationSpeed: 0.025,
                description: 'Furthest planet with supersonic winds.', stats: { diameter: '49,244 km', 'wind speed': '2,100 km/h', moons: '14 (Triton + 13 more)' },
                funFact: 'Fastest winds in the solar system!', mythology: 'Roman god of the sea.',
                discovery: 'Discovered by Johann Galle in 1846', escapeVelocity: 23.5, gravity: 11.2, hasMoons: true, orbitalPeriod: 60190 },
            pluto: { name: 'Pluto', radius: 1.2, color: 0xc9a687, distance: 310, speed: 0.00004, tilt: 122.5, rotationSpeed: -0.003,
                description: 'Dwarf planet with heart-shaped glacier.', stats: { diameter: '2,377 km', type: 'Dwarf Planet', moons: '5 (Charon + 4 more)' },
                funFact: 'Charon is so big they orbit each other!', mythology: 'Roman god of the underworld.',
                discovery: 'Discovered by Clyde Tombaugh in 1930', escapeVelocity: 1.2, gravity: 0.6, hasMoons: true, isDwarf: true, orbitalPeriod: 90560 },
            ceres: { name: 'Ceres', radius: 0.6, color: 0x8b8680, distance: 125, speed: 0.0035, tilt: 4, rotationSpeed: 0.02,
                description: 'Largest asteroid belt object.', stats: { diameter: '940 km', location: 'Asteroid Belt', moons: '0' },
                funFact: 'Contains 1/3 of asteroid belt mass!', mythology: 'Roman goddess of agriculture.',
                discovery: 'Discovered by Giuseppe Piazzi in 1801', escapeVelocity: 0.5, gravity: 0.3, isDwarf: true, orbitalPeriod: 1680 },
            eris: { name: 'Eris', radius: 1.2, color: 0xcccccc, distance: 350, speed: 0.00002, tilt: 44, rotationSpeed: 0.005,
                description: 'Most massive dwarf planet beyond Neptune.', stats: { diameter: '2,326 km', type: 'Dwarf Planet', moons: '1 (Dysnomia)' },
                funFact: 'Eris caused Pluto\'s demotion to dwarf planet!', mythology: 'Greek goddess of strife and discord.',
                discovery: 'Discovered by Mike Brown in 2005', escapeVelocity: 1.4, gravity: 0.8, isDwarf: true, orbitalPeriod: 203830 },
            makemake: { name: 'Makemake', radius: 0.75, color: 0xd4a574, distance: 330, speed: 0.000025, tilt: 28.96, rotationSpeed: 0.006,
                description: 'Third largest dwarf planet in Kuiper Belt.', stats: { diameter: '1,430 km', type: 'Dwarf Planet', moons: '1' },
                funFact: 'Named after Rapa Nui creation deity!', mythology: 'Rapa Nui (Easter Island) creator god.',
                discovery: 'Discovered by Mike Brown in 2005', escapeVelocity: 0.8, gravity: 0.5, isDwarf: true, orbitalPeriod: 111845 },
            haumea: { name: 'Haumea', radius: 1.0, color: 0xffeeee, distance: 320, speed: 0.000028, tilt: 28, rotationSpeed: 0.3,
                description: 'Elongated dwarf planet spinning rapidly.', stats: { diameter: '1,632 km', type: 'Dwarf Planet', shape: 'Ellipsoid', moons: '2' },
                funFact: 'Fastest rotating large object in solar system!', mythology: 'Hawaiian goddess of childbirth.',
                discovery: 'Discovered by Mike Brown in 2004', escapeVelocity: 0.84, gravity: 0.44, isDwarf: true, orbitalPeriod: 103410 }
        };

        const moonData = {
            earth: [{ name: 'Moon', distance: 10, radius: 1.7, speed: 0.08, color: 0xcccccc }],
            mars: [
                { name: 'Phobos', distance: 6, radius: 0.5, speed: 0.15, color: 0x999999 }, 
                { name: 'Deimos', distance: 8, radius: 0.4, speed: 0.1, color: 0xaaaaaa }
            ],
            jupiter: [
                { name: 'Io', distance: 18, radius: 1.8, speed: 0.1, color: 0xffcc00 }, 
                { name: 'Europa', distance: 24, radius: 1.6, speed: 0.08, color: 0xddddff }, 
                { name: 'Ganymede', distance: 30, radius: 2.6, speed: 0.06, color: 0x998877 }, 
                { name: 'Callisto', distance: 36, radius: 2.4, speed: 0.04, color: 0x776655 }
            ],
            saturn: [
                { name: 'Titan', distance: 26, radius: 2.6, speed: 0.05, color: 0xffaa66 }, 
                { name: 'Rhea', distance: 20, radius: 0.8, speed: 0.07, color: 0xcccccc },
                { name: 'Enceladus', distance: 16, radius: 0.6, speed: 0.09, color: 0xffffff }
            ],
            uranus: [
                { name: 'Titania', distance: 12, radius: 0.8, speed: 0.09, color: 0xaaccdd }, 
                { name: 'Oberon', distance: 15, radius: 0.7, speed: 0.07, color: 0x99bbcc }
            ],
            neptune: [
                { name: 'Triton', distance: 14, radius: 1.4, speed: 0.07, color: 0xbbccff }
            ],
            pluto: [
                { name: 'Charon', distance: 8, radius: 0.6, speed: 0.1, color: 0xaaaaaa }
            ]
        };

        const celestialBodies = {}, orbits = {}, planetTrails = {}, labels = {}, moons = {};
        let issGroup = null, cometAngle = 0, issAngle = 0;
        let spaceProbes = [];

        function createPlanetTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            if (type === 'sun') {
                const grad = ctx.createRadialGradient(512, 256, 0, 512, 256, 512);
                grad.addColorStop(0, '#FFF8E7'); grad.addColorStop(0.3, '#FFD700'); grad.addColorStop(0.6, '#FFA500'); grad.addColorStop(1, '#FF4500');
                ctx.fillStyle = grad; ctx.fillRect(0, 0, 1024, 512);
                for (let i = 0; i < 400; i++) {
                    ctx.fillStyle = `rgba(255, ${200 + Math.random() * 55}, 0, ${Math.random() * 0.5})`;
                    ctx.beginPath(); ctx.arc(Math.random() * 1024, Math.random() * 512, Math.random() * 50, 0, Math.PI * 2); ctx.fill();
                }
            } else if (type === 'earth') {
                ctx.fillStyle = '#1a4f8f'; ctx.fillRect(0, 0, 1024, 512);
                ctx.fillStyle = '#2a9d4e';
                for (let i = 0; i < 25; i++) {
                    ctx.beginPath();
                    const sx = Math.random() * 1024, sy = Math.random() * 512;
                    ctx.moveTo(sx, sy);
                    for (let j = 0; j < 15; j++) ctx.lineTo(sx + (Math.random() - 0.5) * 300, sy + (Math.random() - 0.5) * 300);
                    ctx.closePath(); ctx.fill();
                }
                ctx.fillStyle = '#ffffff';
                ctx.beginPath(); ctx.arc(512, 100, 60, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(512, 412, 60, 0, Math.PI * 2); ctx.fill();
            } else {
                const colors = { 
                    mercury: '#8C7853', venus: '#ffc649', mars: '#cd5c5c', jupiter: '#d4a574', 
                    saturn: '#e5c287', uranus: '#4fd0e7', neptune: '#4166f5', pluto: '#c9a687', 
                    ceres: '#8b8680', eris: '#cccccc', makemake: '#d4a574', haumea: '#ffeeee'
                };
                ctx.fillStyle = colors[type] || '#888'; ctx.fillRect(0, 0, 1024, 512);
            }
            return new THREE.CanvasTexture(canvas);
        }

        // Enhanced Sun with larger lens flare
        const sunGeo = new THREE.SphereGeometry(planetData.sun.radius, 64, 64);
        const sun = new THREE.Mesh(sunGeo, new THREE.MeshBasicMaterial({ map: createPlanetTexture('sun'), color: 0xfdb813 }));
        scene.add(sun);
        celestialBodies.sun = { mesh: sun, data: planetData.sun, angle: 0 };

        for (let i = 0; i < 6; i++) {
            const glow = new THREE.Mesh(new THREE.SphereGeometry(planetData.sun.radius * (1.1 + i * 0.15), 32, 32),
                new THREE.MeshBasicMaterial({ color: i < 3 ? 0xfdb813 : 0xffffff, transparent: true, opacity: 0.1 / (i + 1), side: THREE.BackSide }));
            sun.add(glow);
        }

        const asteroidBelt = new THREE.Group();
        scene.add(asteroidBelt);
        const asteroids = [], asteroidCount = 3500;
        for (let i = 0; i < asteroidCount; i++) {
            const geo = new THREE.DodecahedronGeometry(0.3 + Math.random() * 0.6, 0);
            const asteroid = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: [0x8B7355, 0x6B5D52, 0x7A6A5A][Math.floor(Math.random() * 3)], roughness: 0.95 }));
            const angle = Math.random() * Math.PI * 2, distance = 115 + Math.random() * 20;
            asteroid.position.set(Math.cos(angle) * distance, (Math.random() - 0.5) * 12, Math.sin(angle) * distance);
            asteroidBelt.add(asteroid);
            asteroids.push({ mesh: asteroid, angle, distance, speed: 0.003 + Math.random() * 0.002, rotSpeed: { x: (Math.random() - 0.5) * 0.02, y: (Math.random() - 0.5) * 0.02 } });
        }

        // Halley's Comet with 76-year elliptical orbit
        const cometGroup = new THREE.Group();
        cometGroup.add(new THREE.Mesh(new THREE.SphereGeometry(1.8, 16, 16), new THREE.MeshStandardMaterial({ color: 0x88CCFF, emissive: 0x4488FF, emissiveIntensity: 0.6 })));
        const tail = new THREE.Mesh(new THREE.ConeGeometry(4, 50, 8), new THREE.MeshBasicMaterial({ color: 0x88CCFF, transparent: true, opacity: 0.5 }));
        tail.rotation.x = Math.PI / 2; tail.position.z = -25;
        cometGroup.add(tail);
        scene.add(cometGroup);

        // Space Missions
        const voyager1 = new THREE.Mesh(
            new THREE.BoxGeometry(1, 1, 2),
            new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8 })
        );
        scene.add(voyager1);
        
        const newHorizons = new THREE.Mesh(
            new THREE.ConeGeometry(0.8, 2, 8),
            new THREE.MeshStandardMaterial({ color: 0x4488ff, metalness: 0.7 })
        );
        scene.add(newHorizons);
        
        const parkerProbe = new THREE.Mesh(
            new THREE.OctahedronGeometry(0.8),
            new THREE.MeshStandardMaterial({ color: 0xff4444, metalness: 0.9, emissive: 0xff4444, emissiveIntensity: 0.3 })
        );
        scene.add(parkerProbe);

        spaceProbes = [
            { mesh: voyager1, name: 'Voyager 1', angle: 0, distance: 500, speed: 0.0001 },
            { mesh: newHorizons, name: 'New Horizons', angle: Math.PI, distance: 300, speed: 0.00005, target: 'pluto' },
            { mesh: parkerProbe, name: 'Parker Solar Probe', angle: 0, distance: 25, speed: 0.05, solar: true }
        ];

        let habitableZoneInner, habitableZoneOuter, lagrangePoints = [];
        habitableZoneInner = new THREE.Mesh(new THREE.RingGeometry(75, 76, 128), new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide, transparent: true, opacity: 0.3 }));
        habitableZoneOuter = new THREE.Mesh(new THREE.RingGeometry(150, 151, 128), new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide, transparent: true, opacity: 0.3 }));
        habitableZoneInner.rotation.x = habitableZoneOuter.rotation.x = Math.PI / 2;
        habitableZoneInner.visible = habitableZoneOuter.visible = false;
        scene.add(habitableZoneInner, habitableZoneOuter);

        [{ x: 79.2, z: 0 }, { x: 80.8, z: 0 }, { x: -80, z: 0 }, { x: 40, z: 69.3 }, { x: 40, z: -69.3 }].forEach(pos => {
            const point = new THREE.Mesh(new THREE.SphereGeometry(1.5, 16, 16), new THREE.MeshBasicMaterial({ color: 0xff00ff, transparent: true, opacity: 0.7 }));
            point.position.set(pos.x, 0, pos.z); point.visible = false;
            scene.add(point); lagrangePoints.push(point);
        });

        Object.keys(planetData).forEach(key => {
            if (key === 'sun') return;
            const data = planetData[key];

            const orbitGeo = new THREE.BufferGeometry();
            const orbitPts = [];
            for (let i = 0; i <= 128; i++) {
                const angle = (i / 128) * Math.PI * 2;
                orbitPts.push(Math.cos(angle) * data.distance, 0, Math.sin(angle) * data.distance);
            }
            orbitGeo.setAttribute('position', new THREE.Float32BufferAttribute(orbitPts, 3));
            const orbit = new THREE.Line(orbitGeo, new THREE.LineBasicMaterial({ color: data.isDwarf ? 0x888888 : 0x4488ff, opacity: data.isDwarf ? 0.2 : 0.35, transparent: true }));
            scene.add(orbit);
            orbits[key] = orbit;

            const trailGeo = new THREE.BufferGeometry();
            trailGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(300), 3));
            const trail = new THREE.Line(trailGeo, new THREE.LineBasicMaterial({ color: data.color, opacity: 0.5, transparent: true }));
            scene.add(trail);
            planetTrails[key] = { line: trail, positions: [], maxLength: 100 };

            const planet = new THREE.Mesh(new THREE.SphereGeometry(data.radius, 64, 64), 
                new THREE.MeshStandardMaterial({ map: createPlanetTexture(key), roughness: key.includes('jupiter') || key.includes('saturn') || key.includes('uranus') || key.includes('neptune') ? 0.3 : 0.85 }));
            planet.position.x = data.distance;
            if (showAxialTilt) planet.rotation.z = (data.tilt || 0) * Math.PI / 180;
            scene.add(planet);
            celestialBodies[key] = { mesh: planet, data: data, angle: Math.random() * Math.PI * 2 };

            const labelCanvas = document.createElement('canvas');
            labelCanvas.width = 256; labelCanvas.height = 64;
            const lctx = labelCanvas.getContext('2d');
            lctx.fillStyle = 'rgba(0,0,0,0.7)'; lctx.fillRect(0, 0, 256, 64);
            lctx.fillStyle = 'white'; lctx.font = 'bold 30px Arial'; lctx.textAlign = 'center';
            lctx.fillText(data.name, 128, 42);
            const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(labelCanvas), transparent: true }));
            label.scale.set(data.radius * 3.5, data.radius * 0.875, 1);
            label.position.set(0, data.radius + 4, 0);
            planet.add(label);
            labels[key] = label;

            if (key === 'earth') {
                const atm = new THREE.Mesh(new THREE.SphereGeometry(data.radius * 1.06, 64, 64), new THREE.MeshPhongMaterial({ color: '#87CEEB', transparent: true, opacity: 0.18, side: THREE.BackSide }));
                planet.add(atm);

                // City lights on night side
                const lightsCanvas = document.createElement('canvas');
                lightsCanvas.width = 1024; lightsCanvas.height = 512;
                const lctx2 = lightsCanvas.getContext('2d');
                lctx2.fillStyle = 'black'; lctx2.fillRect(0, 0, 1024, 512);
                lctx2.fillStyle = '#ffff99';
                for (let i = 0; i < 500; i++) {
                    lctx2.fillRect(Math.random() * 1024, Math.random() * 512, 2, 2);
                }
                const cityLights = new THREE.Mesh(
                    new THREE.SphereGeometry(data.radius * 1.01, 64, 64),
                    new THREE.MeshBasicMaterial({ 
                        map: new THREE.CanvasTexture(lightsCanvas), 
                        transparent: true, 
                        opacity: 0.4, 
                        blending: THREE.AdditiveBlending 
                    })
                );
                planet.add(cityLights);

                // Animated clouds
                const cloudsCanvas = document.createElement('canvas');
                cloudsCanvas.width = 1024; cloudsCanvas.height = 512;
                const cctx = cloudsCanvas.getContext('2d');
                cctx.fillStyle = 'rgba(255,255,255,0.5)';
                for (let i = 0; i < 150; i++) {
                    cctx.beginPath();
                    cctx.arc(Math.random() * 1024, Math.random() * 512, Math.random() * 50 + 20, 0, Math.PI * 2);
                    cctx.fill();
                }
                const clouds = new THREE.Mesh(
                    new THREE.SphereGeometry(data.radius * 1.02, 64, 64),
                    new THREE.MeshPhongMaterial({ 
                        map: new THREE.CanvasTexture(cloudsCanvas), 
                        transparent: true, 
                        opacity: 0.3 
                    })
                );
                planet.add(clouds);
                planet.userData.clouds = clouds;

                issGroup = new THREE.Group();
                issGroup.add(new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.3, 0.5), new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8 })));
                const sp = new THREE.Mesh(new THREE.BoxGeometry(2, 0.05, 0.6), new THREE.MeshStandardMaterial({ color: 0x1a3a5a }));
                sp.position.set(1.2, 0, 0); issGroup.add(sp);
                const sp2 = sp.clone(); sp2.position.set(-1.2, 0, 0); issGroup.add(sp2);
                issGroup.scale.set(0.3, 0.3, 0.3);
                planet.add(issGroup);
            }

            if (key === 'saturn') {
                const ringGeo = new THREE.RingGeometry(data.radius * 1.5, data.radius * 2.6, 128);
                const rings = new THREE.Mesh(ringGeo, new THREE.MeshStandardMaterial({ color: 0xe5c287, side: THREE.DoubleSide, transparent: true, opacity: 0.95 }));
                rings.rotation.x = Math.PI / 2;
                planet.add(rings);
            }

            if (data.hasMoons && moonData[key]) {
                moons[key] = [];
                moonData[key].forEach(moonInfo => {
                    const moonMesh = new THREE.Mesh(new THREE.SphereGeometry(moonInfo.radius, 32, 32), new THREE.MeshStandardMaterial({ color: moonInfo.color, roughness: 0.95 }));
                    planet.add(moonMesh);
                    moons[key].push({ mesh: moonMesh, angle: Math.random() * Math.PI * 2, distance: moonInfo.distance, speed: moonInfo.speed, name: moonInfo.name });
                });
            }
        });

        camera.position.set(150, 150, 250);
        camera.lookAt(0, 0, 0);

        let isDragging = false, previousMouse = { x: 0, y: 0 }, cameraRotation = { x: 0.5, y: 0.5 }, cameraDistance = 350, targetPlanet = null;

        // Touch controls
        let touchStartDistance = 0;
        renderer.domElement.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                touchStartDistance = Math.sqrt(dx * dx + dy * dy);
            } else if (e.touches.length === 1) {
                isDragging = true;
                previousMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        });

        renderer.domElement.addEventListener('touchmove', e => {
            e.preventDefault();
            if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const delta = touchStartDistance - distance;
                cameraDistance += delta * 0.5;
                cameraDistance = Math.max(30, Math.min(2000, cameraDistance));
                touchStartDistance = distance;
            } else if (e.touches.length === 1 && isDragging) {
                cameraRotation.y += (e.touches[0].clientX - previousMouse.x) * 0.005;
                cameraRotation.x += (e.touches[0].clientY - previousMouse.y) * 0.005;
                cameraRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraRotation.x));
                previousMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        });

        renderer.domElement.addEventListener('touchend', () => { isDragging = false; });

        renderer.domElement.addEventListener('mousedown', e => { isDragging = true; previousMouse = { x: e.clientX, y: e.clientY }; });
        renderer.domElement.addEventListener('mousemove', e => {
            if (!isDragging) return;
            cameraRotation.y += (e.clientX - previousMouse.x) * 0.005;
            cameraRotation.x += (e.clientY - previousMouse.y) * 0.005;
            cameraRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraRotation.x));
            previousMouse = { x: e.clientX, y: e.clientY };
        });
        renderer.domElement.addEventListener('mouseup', () => isDragging = false);
        renderer.domElement.addEventListener('wheel', e => {
            e.preventDefault();
            cameraDistance += e.deltaY * 0.15;
            cameraDistance = Math.max(30, Math.min(2000, cameraDistance));
        });

        renderer.domElement.addEventListener('click', e => {
            if (isDragging) return;
            const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const meshes = Object.keys(celestialBodies).map(k => celestialBodies[k].mesh);
            const intersects = raycaster.intersectObjects(meshes);
            if (intersects.length > 0) {
                const planetKey = Object.keys(celestialBodies).find(k => celestialBodies[k].mesh === intersects[0].object);
                if (planetKey) focusPlanet(planetKey);
            }
        });

        function focusPlanet(key) {
            targetPlanet = key;
            const data = celestialBodies[key].data;
            
            if (key !== 'sun') {
                visitedPlanets.add(key);
                if (visitedPlanets.size >= 8 && !['pluto', 'ceres', 'eris', 'makemake', 'haumea'].includes(key)) {
                    checkAchievement('astronomer');
                }
            }
            
            document.getElementById('planet-name').textContent = data.name;
            document.getElementById('planet-description').textContent = data.description;
            const statsDiv = document.getElementById('planet-stats');
            statsDiv.innerHTML = '';
            Object.keys(data.stats).forEach(k => {
                const p = document.createElement('p');
                p.className = 'text-gray-400';
                p.innerHTML = `<strong>${k}:</strong> ${data.stats[k]}`;
                statsDiv.appendChild(p);
            });
            document.getElementById('fun-fact').classList.toggle('hidden', !data.funFact);
            if (data.funFact) document.getElementById('fact-text').textContent = data.funFact;
            document.getElementById('mythology').classList.toggle('hidden', !data.mythology);
            if (data.mythology) document.getElementById('mythology-text').textContent = data.mythology;
            document.getElementById('discovery').classList.toggle('hidden', !data.discovery);
            if (data.discovery) document.getElementById('discovery-text').textContent = data.discovery;
            
            document.querySelectorAll('.planet-button').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById(`btn-${key}`);
            if (btn) btn.classList.add('active');
            
            const moonContainer = document.getElementById('moon-buttons-container');
            const moonButtonsDiv = document.getElementById('moon-buttons');
            moonButtonsDiv.innerHTML = '';
            
            if (moons[key] && moons[key].length > 0) {
                moonContainer.style.display = 'block';
                document.getElementById('moon-parent-name').textContent = data.name;
                
                moons[key].forEach((moon, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'planet-button w-full text-left px-3 py-2 rounded text-xs text-white';
                    btn.style.paddingLeft = '1.5rem';
                    btn.innerHTML = `‚Ü≥ üåô ${moon.name}`;
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        focusMoon(key, idx);
                    });
                    moonButtonsDiv.appendChild(btn);
                });
            } else {
                moonContainer.style.display = 'none';
            }
            
            updateCalculator(data);
            checkAchievement('first_click');
            if (key !== 'sun') checkAchievement('explorer');
        }

        function focusMoon(planetKey, moonIndex) {
            if (!moons[planetKey] || !moons[planetKey][moonIndex]) return;
            
            const moon = moons[planetKey][moonIndex];
            const moonInfo = moonData[planetKey][moonIndex];
            const planet = celestialBodies[planetKey];
            
            targetPlanet = planetKey;
            cameraDistance = (moonInfo.radius || 1) * 20;
            
            document.getElementById('planet-name').textContent = moon.name;
            document.getElementById('planet-description').textContent = `A moon orbiting ${planet.data.name}`;
            
            const statsDiv = document.getElementById('planet-stats');
            statsDiv.innerHTML = '';
            const p = document.createElement('p');
            p.className = 'text-gray-400';
            p.innerHTML = `<strong>Radius:</strong> ${(moonInfo.radius || 1).toFixed(1)} units<br><strong>Orbital Distance:</strong> ${moon.distance.toFixed(1)} units<br><strong>Orbital Speed:</strong> ${moon.speed.toFixed(3)} units/s`;
            statsDiv.appendChild(p);
            
            document.getElementById('fun-fact').classList.add('hidden');
            document.getElementById('mythology').classList.add('hidden');
            document.getElementById('discovery').classList.add('hidden');
            
            document.querySelectorAll('#moon-buttons .planet-button').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === moonIndex);
            });
            
            checkAchievement('moon_hunter');
        }

        function updateCalculator(planetData) {
            const weight = parseFloat(document.getElementById('user-weight').value) || 70;
            const resultsDiv = document.getElementById('calc-results');
            
            if (!planetData.gravity) {
                resultsDiv.innerHTML = '<p class="text-gray-400 text-xs">No gravity data available</p>';
                return;
            }
            
            const weightOnPlanet = (weight * planetData.gravity / 9.8).toFixed(1);
            const lightTime = (planetData.distance * 1.5 / 299792).toFixed(2); // distance in million km / speed of light
            
            resultsDiv.innerHTML = `
                <p class="text-green-400"><strong>Your weight:</strong> ${weightOnPlanet} kg</p>
                <p class="text-blue-400"><strong>Escape velocity:</strong> ${planetData.escapeVelocity} km/s</p>
                <p class="text-yellow-400"><strong>Light travel time:</strong> ${lightTime} s</p>
                <p class="text-purple-400"><strong>Surface gravity:</strong> ${planetData.gravity} m/s¬≤</p>
            `;
        }

        document.getElementById('user-weight').addEventListener('input', () => {
            if (targetPlanet && celestialBodies[targetPlanet]) {
                updateCalculator(celestialBodies[targetPlanet].data);
            }
        });

        const buttonsContainer = document.getElementById('planet-buttons');
        Object.keys(planetData).forEach(key => {
            const btn = document.createElement('button');
            btn.id = `btn-${key}`;
            btn.className = 'planet-button w-full text-left px-3 py-2 rounded text-sm';
            const icon = planetData[key].isDwarf ? 'ü™®' : key === 'sun' ? '‚≠ê' : 'ü™ê';
            btn.textContent = `${icon} ${planetData[key].name}`;
            btn.addEventListener('click', () => focusPlanet(key));
            buttonsContainer.appendChild(btn);
        });

        focusPlanet('sun');

        function setCameraPreset(preset) {
            if (preset === 'overview') { cameraDistance = 600; cameraRotation = { x: Math.PI / 5, y: 0 }; targetPlanet = null; }
            else if (preset === 'top') { cameraDistance = 500; cameraRotation = { x: Math.PI / 2 - 0.1, y: 0 }; targetPlanet = null; }
            else if (preset === 'side') { cameraDistance = 500; cameraRotation = { x: 0, y: 0 }; targetPlanet = null; }
            else if (preset === 'inner') { cameraDistance = 200; targetPlanet = 'earth'; }
            else if (preset === 'outer') { cameraDistance = 800; targetPlanet = 'neptune'; }
        }

        function startTour() {
            isTourActive = true; tourIndex = 0;
            const planets = Object.keys(planetData).filter(k => k !== 'sun');
            focusPlanet(planets[tourIndex]);
            checkAchievement('tour_guide');
        }

        function jumpTime(days) {
            simulationDate.setDate(simulationDate.getDate() + days);
            showEvent(`Time jumped ${days > 0 ? '+' : ''}${days} days`);
            checkAchievement('time_traveler');
        }

        function toggleOrbits() { showOrbits = !showOrbits; Object.values(orbits).forEach(o => o.visible = showOrbits); document.getElementById('toggle-orbits').classList.toggle('active', showOrbits); }
        function toggleTrails() { showTrails = !showTrails; Object.values(planetTrails).forEach(t => t.line.visible = showTrails); document.getElementById('toggle-trails').classList.toggle('active', showTrails); }
        function toggleLabels() { showLabels = !showLabels; Object.values(labels).forEach(l => l.visible = showLabels); document.getElementById('toggle-labels').classList.toggle('active', showLabels); }
        function toggleMoons() { 
            showMoons = !showMoons; 
            Object.values(moons).forEach(ma => ma.forEach(m => m.mesh.visible = showMoons)); 
            if (issGroup) issGroup.visible = showMoons; 
            document.getElementById('toggle-moons').classList.toggle('active', showMoons); 
        }
        function toggleAsteroids() { showAsteroids = !showAsteroids; asteroidBelt.visible = showAsteroids; document.getElementById('toggle-asteroids').classList.toggle('active', showAsteroids); }
        function toggleDwarfPlanets() { 
            showDwarfPlanets = !showDwarfPlanets; 
            ['pluto', 'ceres', 'eris', 'makemake', 'haumea'].forEach(k => { 
                if (celestialBodies[k]) {
                    celestialBodies[k].mesh.visible = showDwarfPlanets; 
                    if (orbits[k]) orbits[k].visible = showDwarfPlanets && showOrbits;
                }
            }); 
            document.getElementById('toggle-dwarf').classList.toggle('active', showDwarfPlanets); 
        }
        function toggleHabitableZone() { 
            showHabitableZone = !showHabitableZone; 
            habitableZoneInner.visible = habitableZoneOuter.visible = showHabitableZone; 
            const btn = document.querySelector('button[onclick="toggleHabitableZone()"]');
            if (btn) btn.classList.toggle('active', showHabitableZone);
        }
        function toggleLagrangePoints() { 
            showLagrangePoints = !showLagrangePoints; 
            lagrangePoints.forEach(p => p.visible = showLagrangePoints); 
            const btn = document.querySelector('button[onclick="toggleLagrangePoints()"]');
            if (btn) btn.classList.toggle('active', showLagrangePoints);
        }
        function toggleAxialTilt() { 
            showAxialTilt = !showAxialTilt; 
            Object.keys(celestialBodies).forEach(k => {
                if (k !== 'sun') celestialBodies[k].mesh.rotation.z = showAxialTilt ? (celestialBodies[k].data.tilt || 0) * Math.PI / 180 : 0;
            });
            const btn = document.querySelector('button[onclick="toggleAxialTilt()"]');
            if (btn) btn.classList.toggle('active', showAxialTilt);
        }
        function toggleEclipses() {
            showEclipses = !showEclipses;
            const btn = document.querySelector('button[onclick="toggleEclipses()"]');
            if (btn) btn.classList.toggle('active', showEclipses);
            if (showEclipses) showEvent('Eclipse detection enabled');
        }
        function toggleSearch() {
            const panel = document.getElementById('search-panel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) document.getElementById('search-input').focus();
            const btn = document.querySelector('button[onclick="toggleSearch()"]');
            if (btn) btn.classList.toggle('active', !isVisible);
        }
        function toggleCalculator() {
            const panel = document.getElementById('calculator-panel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            const btn = document.querySelector('button[onclick="toggleCalculator()"]');
            if (btn) btn.classList.toggle('active', !isVisible);
        }
        function playSound() { 
            soundEnabled = !soundEnabled; 
            document.getElementById('sound-btn').textContent = soundEnabled ? 'üîä Sound ON' : 'üîá Sound OFF'; 
            document.getElementById('sound-btn').classList.toggle('active', soundEnabled);
            if (soundEnabled && !audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        function takeScreenshot() { 
            renderer.render(scene, camera); 
            const link = document.createElement('a'); 
            link.download = `solar-system-${Date.now()}.png`; 
            link.href = renderer.domElement.toDataURL('image/png'); 
            link.click();
            showEvent('Screenshot saved!');
            checkAchievement('photographer');
        }

        function showComparison() {
            const view = document.getElementById('comparison-view');
            view.style.display = 'block';
            const content = document.getElementById('comparison-content');
            content.innerHTML = '<table class="w-full text-sm"><tr><th class="border-b border-blue-800 p-2">Planet</th><th class="border-b border-blue-800 p-2">Diameter</th><th class="border-b border-blue-800 p-2">Gravity</th><th class="border-b border-blue-800 p-2">Escape Vel.</th><th class="border-b border-blue-800 p-2">Orbital Period</th></tr>';
            Object.keys(planetData).forEach(key => {
                if (key === 'sun') return;
                const d = planetData[key];
                content.innerHTML += `<tr class="border-t border-blue-900"><td class="p-2">${d.name}</td><td class="p-2">${d.stats.diameter}</td><td class="p-2">${d.gravity} m/s¬≤</td><td class="p-2">${d.escapeVelocity} km/s</td><td class="p-2">${d.orbitalPeriod} days</td></tr>`;
            });
            content.innerHTML += '</table>';
        }

        function closeComparison() {
            document.getElementById('comparison-view').style.display = 'none';
        }

        function searchFor(query) {
            document.getElementById('search-input').value = query;
            document.getElementById('search-input').dispatchEvent(new Event('input'));
        }

        document.getElementById('search-input').addEventListener('input', e => {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('search-results');
            results.innerHTML = '';
            
            if (query.length === 0) {
                results.innerHTML = '<p class="text-gray-500 text-xs p-2">Start typing to search...</p>';
                return;
            }
            
            if (query.length < 2) return;
            
            let foundCount = 0;
            
            Object.keys(planetData).forEach(key => {
                if (planetData[key].name.toLowerCase().includes(query)) {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-2 hover:bg-blue-900 rounded text-sm border-l-2 border-blue-500';
                    const icon = planetData[key].isDwarf ? 'ü™®' : key === 'sun' ? '‚≠ê' : 'ü™ê';
                    btn.innerHTML = `${icon} <strong>${planetData[key].name}</strong> <span class="text-xs text-gray-400">- ${planetData[key].description.substring(0, 40)}...</span>`;
                    btn.addEventListener('click', () => { focusPlanet(key); });
                    results.appendChild(btn);
                    foundCount++;
                }
            });
            
            Object.keys(moonData).forEach(planetKey => {
                moonData[planetKey].forEach((moonInfo, idx) => {
                    if (moonInfo.name.toLowerCase().includes(query)) {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left p-2 hover:bg-purple-900 rounded text-sm border-l-2 border-purple-500 pl-4';
                        btn.innerHTML = `üåô <strong>${moonInfo.name}</strong> <span class="text-xs text-gray-400">- Moon of ${planetData[planetKey].name}</span>`;
                        btn.addEventListener('click', () => { focusMoon(planetKey, idx); });
                        results.appendChild(btn);
                        foundCount++;
                    }
                });
            });

            if ('halley'.includes(query)) {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-2 hover:bg-cyan-900 rounded text-sm border-l-2 border-cyan-500';
                btn.innerHTML = `‚òÑÔ∏è <strong>Halley's Comet</strong> <span class="text-xs text-gray-400">- Famous comet with 76-year orbit</span>`;
                btn.addEventListener('click', () => { 
                    targetPlanet = null;
                    cameraDistance = 400;
                    showEvent("Following Halley's Comet");
                });
                results.appendChild(btn);
                foundCount++;
            }

            spaceProbes.forEach(probe => {
                if (probe.name.toLowerCase().includes(query)) {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-2 hover:bg-orange-900 rounded text-sm border-l-2 border-orange-500';
                    btn.innerHTML = `üöÄ <strong>${probe.name}</strong> <span class="text-xs text-gray-400">- Space mission</span>`;
                    btn.addEventListener('click', () => { 
                        showEvent(`Tracking ${probe.name}`);
                    });
                    results.appendChild(btn);
                    foundCount++;
                }
            });
            
            if (foundCount === 0) {
                results.innerHTML = '<p class="text-gray-500 text-xs p-2">No results found. Try: Earth, Mars, Titan, Jupiter, Halley...</p>';
            } else {
                const summary = document.createElement('p');
                summary.className = 'text-xs text-green-400 p-2 border-t border-gray-700 mt-2';
                summary.textContent = `‚úì Found ${foundCount} result${foundCount > 1 ? 's' : ''}`;
                results.appendChild(summary);
            }
        });

        function showEvent(text) {
            const notif = document.getElementById('event-notification');
            document.getElementById('event-text').textContent = text;
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', 3000);
        }

        function checkAchievement(type) {
            if (achievements.has(type)) return;
            achievements.add(type);
            const achievementNames = {
                first_click: 'First Contact - Clicked on a celestial body',
                explorer: 'Explorer - Visited a planet',
                moon_hunter: 'Moon Hunter - Visited a moon',
                tour_guide: 'Tour Guide - Started the grand tour',
                time_traveler: 'Time Traveler - Jumped through time',
                photographer: 'Photographer - Took a screenshot',
                speed_demon: 'Speed Demon - Reached 50x speed',
                astronomer: 'Astronomer - Visited all 8 planets',
                completionist: 'Completionist - Unlocked all features',
                master: 'Solar System Master - Spent 10 minutes exploring'
            };
            if (achievementNames[type]) {
                document.getElementById('achievement-text').textContent = achievementNames[type];
                document.getElementById('achievement-popup').style.display = 'block';
                setTimeout(() => document.getElementById('achievement-popup').style.display = 'none', 4000);
                document.getElementById('achievement-count').textContent = `${achievements.size}/10`;
                
                if (achievements.size >= 10) {
                    setTimeout(() => checkAchievement('completionist'), 500);
                }
            }
        }

        let animationSpeed = 1, time = 0, frameCount = 0, lastTime = performance.now();
        document.getElementById('speed-slider').addEventListener('input', e => { 
            animationSpeed = parseFloat(e.target.value); 
            document.getElementById('speed-display').textContent = `${animationSpeed.toFixed(1)}x`;
            if (Math.abs(animationSpeed) >= 50) checkAchievement('speed_demon');
        });

        function detectConjunctions() {
            const planets = ['mercury', 'venus', 'earth', 'mars', 'jupiter', 'saturn'];
            let nextConjunction = null;
            let minDiff = 360;
            
            for (let i = 0; i < planets.length - 1; i++) {
                for (let j = i + 1; j < planets.length; j++) {
                    const p1 = celestialBodies[planets[i]];
                    const p2 = celestialBodies[planets[j]];
                    if (!p1 || !p2) continue;
                    
                    const angle1 = Math.atan2(p1.mesh.position.z, p1.mesh.position.x);
                    const angle2 = Math.atan2(p2.mesh.position.z, p2.mesh.position.x);
                    let diff = Math.abs(angle1 - angle2) * 180 / Math.PI;
                    
                    if (diff > 180) diff = 360 - diff;
                    
                    if (diff < 5) {
                        showEvent(`üåü Conjunction: ${p1.data.name} & ${p2.data.name}!`);
                        return;
                    }
                    
                    if (diff < minDiff) {
                        minDiff = diff;
                        nextConjunction = `${p1.data.name} & ${p2.data.name} (${minDiff.toFixed(1)}¬∞)`;
                    }
                }
            }
            
            if (nextConjunction) {
                document.getElementById('conjunction-indicator').textContent = `Next: ${nextConjunction}`;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01; frameCount++;

            const now = performance.now();
            if (frameCount % 60 === 0) {
                const fps = Math.round(1000 / (now - lastTime) * 60);
                document.getElementById('fps-counter').textContent = fps;
                lastTime = now;
                
                // Check for master achievement
                if ((now - startTime) > 600000 && !achievements.has('master')) {
                    checkAchievement('master');
                }
            }

            if (frameCount % 30 === 0) {
                simulationDate.setHours(simulationDate.getHours() + Math.abs(animationSpeed) * 24);
                document.getElementById('current-date').textContent = simulationDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                document.getElementById('earth-time').textContent = `Earth Time: ${simulationDate.toLocaleTimeString('en-US', { hour12: false })}`;
                
                const yearsPassed = (simulationDate - startDate) / (1000 * 60 * 60 * 24 * 365);
                document.getElementById('elapsed-years').textContent = `Elapsed: ${yearsPassed.toFixed(2)} years`;
            }

            if (frameCount % 600 === 0) detectConjunctions();

            if (isTourActive && frameCount % 360 === 0) {
                const planets = Object.keys(planetData).filter(k => k !== 'sun');
                tourIndex = (tourIndex + 1) % planets.length;
                focusPlanet(planets[tourIndex]);
            }

            Object.keys(celestialBodies).forEach(key => {
                if (key === 'sun') { 
                    sun.rotation.y += 0.001 * animationSpeed; 
                    return; 
                }
                const body = celestialBodies[key];
                body.angle += body.data.speed * animationSpeed;
                body.mesh.position.x = Math.cos(body.angle) * body.data.distance;
                body.mesh.position.z = Math.sin(body.angle) * body.data.distance;
                body.mesh.rotation.y += body.data.rotationSpeed * animationSpeed;

                // Rotate clouds independently on Earth
                if (key === 'earth' && body.mesh.userData.clouds) {
                    body.mesh.userData.clouds.rotation.y += 0.005 * animationSpeed;
                }

                if (showTrails && frameCount % 3 === 0) {
                    const trail = planetTrails[key];
                    trail.positions.push(body.mesh.position.clone());
                    if (trail.positions.length > trail.maxLength) trail.positions.shift();
                    const positions = new Float32Array(trail.positions.flatMap(p => [p.x, p.y, p.z]));
                    trail.line.geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                }

                if (moons[key]) {
                    moons[key].forEach(moon => {
                        moon.angle += moon.speed * animationSpeed;
                        moon.mesh.position.x = Math.cos(moon.angle) * moon.distance;
                        moon.mesh.position.z = Math.sin(moon.angle) * moon.distance;
                    });
                }
            });

            if (issGroup) {
                issAngle += 0.05 * animationSpeed;
                const d = 8.4;
                issGroup.position.set(Math.cos(issAngle) * d, Math.sin(issAngle * 1.3) * 1.5, Math.sin(issAngle) * d);
            }

            // Halley's Comet with elliptical orbit
            cometAngle += 0.006 * animationSpeed;
            const a = 230, b = 160; // semi-major and semi-minor axes
            cometGroup.position.set(Math.cos(cometAngle) * a, Math.sin(cometAngle * 3.5) * 60, Math.sin(cometAngle) * b);
            cometGroup.lookAt(0, 0, 0);

            // Space probes
            spaceProbes.forEach(probe => {
                if (probe.solar) {
                    // Parker Solar Probe - close solar approaches
                    probe.angle += probe.speed * animationSpeed;
                    const dist = probe.distance + Math.sin(probe.angle * 3) * 15;
                    probe.mesh.position.set(Math.cos(probe.angle) * dist, Math.sin(probe.angle * 2) * 5, Math.sin(probe.angle) * dist);
                } else if (probe.target === 'pluto') {
                    // New Horizons heading to Pluto
                    probe.angle += probe.speed * animationSpeed;
                    probe.distance = Math.min(310, probe.distance + 0.1);
                    probe.mesh.position.set(Math.cos(probe.angle) * probe.distance, 0, Math.sin(probe.angle) * probe.distance);
                } else {
                    // Voyager 1 - interstellar trajectory
                    probe.angle += probe.speed * animationSpeed;
                    probe.distance += 0.05;
                    probe.mesh.position.set(Math.cos(probe.angle) * probe.distance, probe.distance * 0.3, Math.sin(probe.angle) * probe.distance);
                }
            });

            asteroids.forEach(a => {
                a.angle += a.speed * animationSpeed;
                a.mesh.position.x = Math.cos(a.angle) * a.distance;
                a.mesh.position.z = Math.sin(a.angle) * a.distance;
                a.mesh.rotation.x += a.rotSpeed.x * animationSpeed;
                a.mesh.rotation.y += a.rotSpeed.y * animationSpeed;
            });

            let targetPos = { x: 0, y: 0, z: 0 };
            if (targetPlanet && celestialBodies[targetPlanet]) targetPos = celestialBodies[targetPlanet].mesh.position;

            const camX = targetPos.x + Math.cos(cameraRotation.y) * Math.cos(cameraRotation.x) * cameraDistance;
            const camY = targetPos.y + Math.sin(cameraRotation.x) * cameraDistance;
            const camZ = targetPos.z + Math.sin(cameraRotation.y) * Math.cos(cameraRotation.x) * cameraDistance;

            camera.position.x += (camX - camera.position.x) * 0.08;
            camera.position.y += (camY - camera.position.y) * 0.08;
            camera.position.z += (camZ - camera.position.z) * 0.08;
            camera.lookAt(targetPos.x, targetPos.y, targetPos.z);

            if (targetPlanet && celestialBodies[targetPlanet]) {
                const d = celestialBodies[targetPlanet].data.distance;
                document.getElementById('distance-indicator').textContent = `Distance from Sun: ${(d * 1.5).toFixed(0)} million km`;
                document.getElementById('speed-indicator').textContent = `Orbital Speed: ${(celestialBodies[targetPlanet].data.speed * 1000).toFixed(2)} units/s`;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { 
            camera.aspect = window.innerWidth / window.innerHeight; 
            camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
        });

        setTimeout(() => { 
            const ls = document.getElementById('loading-screen'); 
            ls.style.opacity = '0'; 
            setTimeout(() => ls.style.display = 'none', 500); 
            checkAchievement('first_click');
        }, 2000);

        // Calculate total objects
        let totalObjects = Object.keys(celestialBodies).length + asteroidCount + 
                          Object.values(moons).reduce((s, a) => s + a.length, 0) + 
                          spaceProbes.length + 1; // +1 for comet
        document.getElementById('total-objects').textContent = totalObjects;

        function addTooltip(element, text) {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = text;
            document.body.appendChild(tooltip);
            
            element.addEventListener('mouseenter', (e) => {
                const rect = element.getBoundingClientRect();
                tooltip.classList.add('show');
                const tooltipRect = tooltip.getBoundingClientRect();
                
                let left = rect.left + (rect.width / 2);
                let top = rect.top - 35;
                let isBelow = false;
                
                if (left - (tooltipRect.width / 2) < 10) {
                    left = tooltipRect.width / 2 + 10;
                }
                
                if (left + (tooltipRect.width / 2) > window.innerWidth - 10) {
                    left = window.innerWidth - (tooltipRect.width / 2) - 10;
                }
                
                if (top < 10) {
                    top = rect.bottom + 10;
                    isBelow = true;
                    tooltip.classList.add('below');
                } else {
                    tooltip.classList.remove('below');
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                tooltip.style.transform = 'translateX(-50%)';
            });
            
            element.addEventListener('mouseleave', () => {
                tooltip.classList.remove('show');
            });
        }

        setTimeout(() => {
            Object.keys(planetData).forEach(key => {
                const btn = document.getElementById(`btn-${key}`);
                if (btn) addTooltip(btn, `Click to focus on ${planetData[key].name}. ${planetData[key].description}`);
            });

            const cameraButtons = document.querySelectorAll('.mb-4:nth-child(3) .toggle-btn');
            const cameraTooltips = [
                'Wide view of the entire solar system',
                'Bird\'s eye view from above',
                'Profile view from the side',
                'Automated tour of all celestial bodies',
                'Focus on inner solar system (Mercury to Mars)',
                'Focus on outer solar system (Jupiter to Neptune)'
            ];
            cameraButtons.forEach((btn, idx) => {
                if (cameraTooltips[idx]) addTooltip(btn, cameraTooltips[idx]);
            });

            addTooltip(document.getElementById('toggle-orbits'), 'Show/hide orbital paths around the Sun');
            addTooltip(document.getElementById('toggle-trails'), 'Show/hide planet movement trails');
            addTooltip(document.getElementById('toggle-labels'), 'Show/hide planet name labels');
            addTooltip(document.getElementById('toggle-moons'), 'Show/hide all 146+ moons orbiting planets');
            addTooltip(document.getElementById('toggle-asteroids'), 'Show/hide 3500+ asteroids in the belt');
            addTooltip(document.getElementById('toggle-dwarf'), 'Show/hide dwarf planets (Pluto, Ceres, Eris, Makemake, Haumea)');

            const advButtons = document.querySelectorAll('.mb-4:nth-child(5) .toggle-btn');
            const advTooltips = [
                'Highlight the green zone where liquid water can exist',
                'Show special gravitational equilibrium points (L1-L5)',
                'Display planets tilted at their actual angles',
                'Detect and highlight solar/lunar eclipse events'
            ];
            advButtons.forEach((btn, idx) => {
                if (advTooltips[idx]) addTooltip(btn, advTooltips[idx]);
            });

            const utilButtons = document.querySelectorAll('.space-y-2.text-xs .toggle-btn');
            const utilTooltips = [
                'Find any planet, moon, comet or mission by name',
                'Side-by-side comparison of all planets',
                'Calculate your weight, escape velocity and light travel time',
                'Capture and download current view as image',
                'Toggle sound effects on/off'
            ];
            utilButtons.forEach((btn, idx) => {
                if (utilTooltips[idx]) addTooltip(btn, utilTooltips[idx]);
            });

            const timeButtons = document.querySelectorAll('.grid.grid-cols-3 .toggle-btn');
            const timeTooltips = ['-1 Year', '-1 Month', '-1 Day', '+1 Day', '+1 Month', '+1 Year'];
            timeButtons.forEach((btn, idx) => {
                if (timeTooltips[idx]) addTooltip(btn, `Jump time ${timeTooltips[idx]}`);
            });

            addTooltip(document.getElementById('speed-slider'), 'Control simulation speed from -50x (reverse) to +100x (fast forward)');
        }, 2500);

        // Mission Planning Functions
        let missionTrajectoryLine = null;

        function toggleMissionPlanner() {
            const panel = document.getElementById('mission-panel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            const btn = document.querySelector('button[onclick="toggleMissionPlanner()"]');
            if (btn) btn.classList.toggle('active', !isVisible);
        }

        function calculateMission() {
            const from = document.getElementById('mission-from').value;
            const to = document.getElementById('mission-to').value;
            const mass = parseFloat(document.getElementById('spacecraft-mass').value);
            
            if (!planetData[from] || !planetData[to]) return;
            
            const fromPlanet = planetData[from];
            const toPlanet = planetData[to];
            
            // Calculate Hohmann transfer orbit
            const r1 = fromPlanet.distance * 1.5e6; // Convert to km
            const r2 = toPlanet.distance * 1.5e6;
            
            // Semi-major axis of transfer orbit
            const a = (r1 + r2) / 2;
            
            // Vis-viva equation to calculate delta-v
            const mu = 1.327e11; // Solar gravitational parameter km¬≥/s¬≤
            const v1 = Math.sqrt(mu / r1); // Current velocity at departure
            const v2 = Math.sqrt(mu / r2); // Target velocity at arrival
            
            // Transfer orbit velocities
            const vt1 = Math.sqrt(mu * (2/r1 - 1/a)); // Velocity at departure on transfer
            const vt2 = Math.sqrt(mu * (2/r2 - 1/a)); // Velocity at arrival on transfer
            
            // Delta-v requirements
            const deltaV1 = Math.abs(vt1 - v1); // Departure burn
            const deltaV2 = Math.abs(v2 - vt2); // Arrival burn
            const totalDeltaV = deltaV1 + deltaV2;
            
            // Transfer time (half period of transfer ellipse)
            const transferTime = Math.PI * Math.sqrt(Math.pow(a, 3) / mu) / (24 * 3600); // Convert to days
            
            // Fuel consumption (using Tsiolkovsky rocket equation)
            const isp = 300; // Specific impulse in seconds
            const g0 = 9.81; // Standard gravity m/s¬≤
            const deltaVTotal = totalDeltaV * 1000; // Convert to m/s
            const massRatio = Math.exp(deltaVTotal / (isp * g0));
            const fuelNeeded = mass * (massRatio - 1);
            
            // Check for gravity assists
            const useVenus = document.getElementById('assist-venus').checked;
            const useJupiter = document.getElementById('assist-jupiter').checked;
            let gravityAssistSavings = 0;
            let extraTime = 0;
            
            if (useVenus && to !== 'venus') {
                gravityAssistSavings += totalDeltaV * 0.15; // 15% savings
                extraTime += 150; // Add 150 days for Venus flyby
            }
            if (useJupiter && to !== 'jupiter') {
                gravityAssistSavings += totalDeltaV * 0.35; // 35% savings
                extraTime += 600; // Add 600 days for Jupiter flyby
            }
            
            const finalDeltaV = totalDeltaV - gravityAssistSavings;
            const finalTransferTime = transferTime + extraTime;
            const finalFuel = fuelNeeded * (1 - gravityAssistSavings / totalDeltaV);
            
            const resultsDiv = document.getElementById('mission-results');
            resultsDiv.innerHTML = `
                <p class=\"text-green-400 font-semibold\">‚úÖ Mission Calculated!</p>
                <p class=\"text-white\"><strong>Route:</strong> ${fromPlanet.name} ‚Üí ${toPlanet.name}</p>
                <p class=\"text-blue-400\"><strong>Total Œîv:</strong> ${finalDeltaV.toFixed(2)} km/s</p>
                <p class=\"text-yellow-400\"><strong>Departure Œîv:</strong> ${deltaV1.toFixed(2)} km/s</p>
                <p class=\"text-yellow-400\"><strong>Arrival Œîv:</strong> ${deltaV2.toFixed(2)} km/s</p>
                <p class=\"text-purple-400\"><strong>Transfer Time:</strong> ${Math.round(finalTransferTime)} days (${(finalTransferTime/365).toFixed(1)} years)</p>
                <p class=\"text-pink-300\"><strong>Fuel Required:</strong> ${Math.round(finalFuel)} kg</p>
                <p class=\"text-orange-300\"><strong>Total Mass:</strong> ${Math.round(mass + finalFuel)} kg</p>
                ${gravityAssistSavings > 0 ? `<p class=\"text-green-300\"><strong>‚ö° Gravity Assist Savings:</strong> ${gravityAssistSavings.toFixed(2)} km/s</p>` : ''}
            `;
            
            showEvent(`Mission to ${toPlanet.name} planned! ${Math.round(finalTransferTime)} days`);
            checkAchievement('mission_planner');
        }

        function visualizeMission() {
            const from = document.getElementById('mission-from').value;
            const to = document.getElementById('mission-to').value;
            
            if (!celestialBodies[from] || !celestialBodies[to]) return;
            
            // Remove old trajectory if exists
            if (missionTrajectoryLine) {
                scene.remove(missionTrajectoryLine);
            }
            
            const fromPos = celestialBodies[from].mesh.position;
            const toPos = celestialBodies[to].mesh.position;
            
            // Create elliptical transfer orbit (Hohmann transfer)
            const points = [];
            const fromDist = planetData[from].distance;
            const toDist = planetData[to].distance;
            const a = (fromDist + toDist) / 2; // Semi-major axis
            const c = (toDist - fromDist) / 2; // Distance from center to focus
            const b = Math.sqrt(a * a - c * c); // Semi-minor axis
            
            for (let i = 0; i <= 100; i++) {
                const theta = (i / 100) * Math.PI; // Half ellipse
                const r = (a * (1 - (c/a) * (c/a))) / (1 + (c/a) * Math.cos(theta));
                const x = (r * Math.cos(theta)) + (fromDist - c);
                const z = r * Math.sin(theta);
                points.push(new THREE.Vector3(x, 0, z));
            }
            
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ 
                color: 0xff6b6b, 
                linewidth: 3,
                opacity: 0.8,
                transparent: true
            });
            
            missionTrajectoryLine = new THREE.Line(geometry, material);
            scene.add(missionTrajectoryLine);
            
            showEvent(`Trajectory visualized! Pink line shows path.`);
            
            // Focus camera on the trajectory
            targetPlanet = null;
            cameraDistance = Math.max(fromDist, toDist) * 2.5;
        }

        animate();
    </script>
</body>
</html>
