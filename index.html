<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ultimate Solar System Explorer - Complete Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Space Mono', monospace; touch-action: none; }
        
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: linear-gradient(180deg, rgba(10, 10, 30, 0.8) 0%, rgba(20, 20, 50, 0.8) 100%); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(59, 130, 246, 0.8) 0%, rgba(139, 92, 246, 0.8) 100%); border-radius: 10px; border: 2px solid rgba(10, 10, 30, 0.5); }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, rgba(59, 130, 246, 1) 0%, rgba(139, 92, 246, 1) 100%); box-shadow: 0 0 10px rgba(59, 130, 246, 0.8); }
        * { scrollbar-width: thin; scrollbar-color: rgba(59, 130, 246, 0.8) rgba(10, 10, 30, 0.8); }
        
        #info-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 20, 40, 0.9) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6); max-height: 90vh; overflow-y: auto; }
        .planet-button { transition: all 0.3s ease; border-left: 3px solid transparent; }
        .planet-button:hover { transform: scale(1.05) translateX(5px); background: rgba(59, 130, 246, 0.3); border-left-color: #60a5fa; }
        .planet-button.active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.6) 0%, rgba(59, 130, 246, 0.2) 100%); border-left: 4px solid #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
        .title { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 15px rgba(59, 130, 246, 0.7); }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #000000 0%, #1a1a2e 50%, #0f3460 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.5s ease; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid rgba(59, 130, 246, 0.2); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .control-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 20, 40, 0.9) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); }
        .toggle-btn { padding: 8px 16px; border-radius: 6px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); transition: all 0.3s ease; cursor: pointer; }
        .toggle-btn:hover { background: rgba(59, 130, 246, 0.4); transform: scale(1.05); }
        .toggle-btn.active { background: rgba(59, 130, 246, 0.7); border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .fun-fact { background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2)); border-left: 3px solid #8b5cf6; padding: 12px; margin: 8px 0; border-radius: 4px; }
        .event-notification { position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(59, 130, 246, 0.95)); padding: 20px 40px; border-radius: 10px; box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); z-index: 100; display: none; animation: slideIn 0.5s ease; }
        @keyframes slideIn { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
        .search-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 40, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); }
        .comparison-view { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px); border: 2px solid rgba(100, 150, 255, 0.6); border-radius: 10px; padding: 20px; z-index: 200; display: none; max-width: 80vw; max-height: 80vh; overflow-y: auto; }
        .achievement-popup { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9)); color: #000; padding: 15px 25px; border-radius: 8px; box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); z-index: 150; display: none; animation: bounceIn 0.6s ease; }
        @keyframes bounceIn { 0% { transform: scale(0); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @media (max-width: 768px) { #info-panel { max-width: 90vw; font-size: 0.875rem; } .control-panel { font-size: 0.75rem; } }
        .eclipse-shadow { position: absolute; width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, rgba(0,0,0,0.8), transparent); pointer-events: none; }
        
        .tooltip { position: absolute; background: rgba(0, 0, 0, 0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; pointer-events: none; z-index: 10000; white-space: nowrap; opacity: 0; transition: opacity 0.2s ease; box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); border: 1px solid rgba(59, 130, 246, 0.5); max-width: 250px; white-space: normal; }
        .tooltip.show { opacity: 1; }
        .tooltip::before { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid rgba(0, 0, 0, 0.9); }
        .tooltip.below::before { bottom: auto; top: -6px; border-top: none; border-bottom: 6px solid rgba(0, 0, 0, 0.9); }
        
        .calculator-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 40, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); }
        
        /* Mission Planning Mode */
        .mission-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 40, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 100, 150, 0.4); }
        .mission-trajectory { stroke-dasharray: 5, 5; animation: dash 20s linear infinite; }
        @keyframes dash { to { stroke-dashoffset: -1000; } }
        .transfer-orbit { stroke: #ff6b6b; stroke-width: 2; fill: none; opacity: 0.7; }
        .gravity-assist-arrow { fill: #ffd93d; opacity: 0.8; }
        
        /* Physics Sandbox Mode */
        .sandbox-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 40, 20, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 255, 100, 0.4); }
        .sandbox-object { background: linear-gradient(135deg, rgba(50, 200, 50, 0.2), rgba(50, 150, 50, 0.2)); border: 1px solid rgba(100, 255, 100, 0.3); transition: all 0.3s ease; }
        .sandbox-object:hover { transform: scale(1.02); border-color: rgba(100, 255, 100, 0.8); box-shadow: 0 0 15px rgba(100, 255, 100, 0.5); }
        .slider-container { position: relative; }
        .slider-value { position: absolute; right: 0; top: -20px; font-size: 10px; color: #4ade80; }
        
        /* Exoplanet Explorer */
        .exoplanet-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(40, 20, 60, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(150, 100, 255, 0.4); }
        .exoplanet-card { background: linear-gradient(135deg, rgba(100, 50, 200, 0.2), rgba(50, 100, 200, 0.2)); border: 1px solid rgba(150, 100, 255, 0.3); transition: all 0.3s ease; cursor: pointer; }
        .exoplanet-card:hover { transform: scale(1.05); border-color: rgba(150, 100, 255, 0.8); box-shadow: 0 0 20px rgba(150, 100, 255, 0.5); }
        
        /* Historical Timeline */
        .timeline-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(30, 20, 10, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 200, 100, 0.4); }
        .timeline-event { background: linear-gradient(135deg, rgba(255, 200, 100, 0.2), rgba(255, 150, 50, 0.2)); border: 1px solid rgba(255, 200, 100, 0.3); transition: all 0.3s ease; cursor: pointer; }
        .timeline-event:hover { transform: scale(1.02); border-color: rgba(255, 200, 100, 0.8); box-shadow: 0 0 15px rgba(255, 200, 100, 0.5); }
        .timeline-marker { position: absolute; width: 20px; height: 20px; background: radial-gradient(circle, rgba(255, 200, 100, 1), rgba(255, 150, 50, 0.5)); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.8); z-index: 5; pointer-events: none; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } }
    </style>
</head>
<body class="bg-black">
    <div id="loading-screen">
        <div class="loading-spinner mb-4"></div>
        <h2 class="text-white text-2xl font-bold title">Loading Ultimate Solar System...</h2>
        <p class="text-blue-300 text-sm mt-2">Initializing 3,531+ Objects...</p>
        <div class="w-64 h-2 bg-gray-800 rounded-full mt-4 overflow-hidden">
            <div id="loading-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
        </div>
        <p class="text-gray-400 text-xs mt-2" id="loading-text">Loading stars...</p>
    </div>

    <div id="event-notification" class="event-notification">
        <h3 class="text-white text-xl font-bold title mb-2">🌟 Cosmic Event!</h3>
        <p class="text-white" id="event-text"></p>
    </div>

    <div id="achievement-popup" class="achievement-popup">
        <h3 class="font-bold text-lg mb-1">🏆 Achievement Unlocked!</h3>
        <p id="achievement-text"></p>
    </div>

    <div id="search-panel" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 transform text-white search-panel p-4 rounded-lg w-80 max-w-md z-40 shadow-2xl" style="display:none;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold title">🔍 Search Objects</h3>
            <button onclick="toggleSearch()" class="text-white text-xl hover:text-red-400">&times;</button>
        </div>
        <div class="mb-2 text-xs text-gray-300">Filters:</div>
        <div class="grid grid-cols-2 gap-2 text-xs mb-3">
            <button id="filter-planet" class="toggle-btn active w-full">🪐 Planets</button>
            <button id="filter-moon" class="toggle-btn active w-full">🌙 Moons</button>
            <button id="filter-comet" class="toggle-btn active w-full">☄️ Comets</button>
            <button id="filter-mission" class="toggle-btn active w-full">🚀 Missions</button>
        </div>
        <input type="text" id="search-input" placeholder="Type planet or moon name..." class="w-full p-2 rounded bg-gray-800 text-white border border-blue-500 mb-3 focus:border-purple-400 focus:outline-none" autocomplete="off">
        <div id="search-results" class="space-y-1 max-h-80 overflow-y-auto"></div>
        <div id="search-help" class="text-xs text-gray-400 mt-3 border-t border-gray-700 pt-2">
            <p class="mb-1">💡 Try searching for:</p>
            <div class="grid grid-cols-2 gap-1">
                <button onclick="searchFor('Earth')" class="text-left hover:text-blue-400">• Earth</button>
                <button onclick="searchFor('Jupiter')" class="text-left hover:text-blue-400">• Jupiter</button>
                <button onclick="searchFor('Titan')" class="text-left hover:text-blue-400">• Titan</button>
                <button onclick="searchFor('Halley')" class="text-left hover:text-blue-400">• Halley</button>
            </div>
        </div>
    </div>

    <div id="comparison-view" class="comparison-view">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold title text-white">📊 Planet Comparison</h2>
            <button onclick="closeComparison()" class="text-white text-2xl hover:text-red-400">&times;</button>
        </div>
        <div id="comparison-content" class="text-white"></div>
    </div>

    <div id="calculator-panel" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 transform text-white calculator-panel p-4 rounded-lg w-80 max-w-md z-40 shadow-2xl" style="display:none;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold title">🧮 Science Calculator</h3>
            <button onclick="toggleCalculator()" class="text-white text-xl hover:text-red-400">&times;</button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="text-xs text-gray-400">Your Weight (kg):</label>
                <input type="number" id="user-weight" value="70" class="w-full p-2 rounded bg-gray-800 text-white border border-blue-500 focus:outline-none" min="1" max="500">
            </div>
            <div id="calc-results" class="text-xs space-y-2 border-t border-gray-700 pt-2">
                <p class="text-gray-400">Select a planet to see calculations...</p>
            </div>
        </div>
    </div>

    <div id="mission-panel" class="absolute bottom-20 right-4 text-white mission-panel p-4 rounded-lg max-w-md z-10" style="display:none;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold title">🚀 Mission Planning</h3>
            <button onclick="toggleMissionPlanner()" class="text-white text-xl hover:text-red-400">&times;</button>
        </div>
        <div class="space-y-3">
            <div class="grid grid-cols-2 gap-2 text-xs">
                <div>
                    <label class="text-gray-400">From:</label>
                    <select id="mission-from" class="w-full p-2 rounded bg-gray-800 text-white border border-pink-500 focus:outline-none">
                        <option value="earth">Earth</option>
                        <option value="mars">Mars</option>
                        <option value="venus">Venus</option>
                        <option value="mercury">Mercury</option>
                        <option value="jupiter">Jupiter</option>
                        <option value="saturn">Saturn</option>
                    </select>
                </div>
                <div>
                    <label class="text-gray-400">To:</label>
                    <select id="mission-to" class="w-full p-2 rounded bg-gray-800 text-white border border-pink-500 focus:outline-none">
                        <option value="mars">Mars</option>
                        <option value="jupiter">Jupiter</option>
                        <option value="saturn">Saturn</option>
                        <option value="venus">Venus</option>
                        <option value="mercury">Mercury</option>
                        <option value="earth">Earth</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="text-xs text-gray-400">Spacecraft Mass (kg):</label>
                <input type="number" id="spacecraft-mass" value="1000" class="w-full p-2 rounded bg-gray-800 text-white border border-pink-500 focus:outline-none" min="100" max="100000">
            </div>

            <button onclick="calculateMission()" class="w-full toggle-btn text-sm bg-pink-600 hover:bg-pink-700">🎯 Calculate Transfer</button>
            
            <div id="mission-results" class="text-xs space-y-2 border-t border-pink-700 pt-2 mt-3">
                <p class="text-gray-400">Configure your mission above...</p>
            </div>

            <div class="border-t border-pink-700 pt-2 mt-2">
                <p class="text-xs font-semibold text-pink-300 mb-2">🎮 Gravity Assist Options:</p>
                <div class="space-y-1">
                    <label class="flex items-center text-xs">
                        <input type="checkbox" id="assist-venus" class="mr-2">
                        <span>Use Venus flyby</span>
                    </label>
                    <label class="flex items-center text-xs">
                        <input type="checkbox" id="assist-jupiter" class="mr-2">
                        <span>Use Jupiter flyby</span>
                    </label>
                </div>
            </div>

            <button onclick="visualizeMission()" class="w-full toggle-btn text-sm mt-2">👁️ Visualize Trajectory</button>
        </div>
    </div>

    <div id="info-panel" class="absolute top-4 left-4 text-white p-6 rounded-lg max-w-sm z-10">
        <h1 class="text-2xl font-bold mb-2 title">🌌 Solar System Ultimate</h1>
        <p class="text-sm text-gray-300 mb-4">🚀 Click | 🎮 Drag | 🔍 Scroll | ⏱️ Time Travel</p>
        
        <div class="mb-4 p-3 bg-gradient-to-r from-blue-900 to-purple-900 bg-opacity-40 rounded">
            <p class="text-xs text-gray-400">Simulation Date & Time</p>
            <p class="text-lg font-semibold" id="current-date">Jan 1, 2024</p>
            <p class="text-xs text-blue-300 mt-1" id="earth-time">Earth Time: 00:00:00</p>
            <p class="text-xs text-yellow-300 mt-1" id="elapsed-years">Elapsed: 0 years</p>
        </div>

        <div id="planet-info" class="mb-4">
            <h2 class="text-xl font-semibold mb-2" id="planet-name">The Sun</h2>
            <p class="text-sm" id="planet-description">The star at the center of our solar system.</p>
            <div class="mt-2 text-xs space-y-1" id="planet-stats"></div>
            <div class="mt-3 flex items-center gap-2">
                <button id="pin-btn" class="toggle-btn text-xs px-3 py-1">📌 Pin</button>
                <span class="text-[10px] text-gray-400">Save this object to quick pins</span>
            </div>
            <div id="fun-fact" class="fun-fact mt-3 hidden">
                <p class="text-xs font-semibold text-purple-300">💡 Fun Fact</p>
                <p class="text-xs mt-1" id="fact-text"></p>
            </div>
            <div id="mythology" class="fun-fact mt-3 hidden" style="border-left-color: #f59e0b;">
                <p class="text-xs font-semibold text-yellow-300">📜 Mythology</p>
                <p class="text-xs mt-1" id="mythology-text"></p>
            </div>
            <div id="discovery" class="fun-fact mt-3 hidden" style="border-left-color: #10b981;">
                <p class="text-xs font-semibold text-green-300">🔭 Discovery</p>
                <p class="text-xs mt-1" id="discovery-text"></p>
            </div>
        </div>

        <div id="pinned-container" class="mt-4 hidden">
            <h3 class="text-sm font-semibold text-gray-400 mb-2">📌 Pinned:</h3>
            <div id="pinned-cards" class="space-y-2"></div>
        </div>
        
        <div class="space-y-2">
            <h3 class="text-sm font-semibold text-gray-400">Celestial Bodies:</h3>
            <div id="planet-buttons" class="space-y-1"></div>
        </div>

        <div id="moon-buttons-container" class="mt-4 space-y-2" style="display:none;">
            <h3 class="text-sm font-semibold text-gray-400">Moons of <span id="moon-parent-name"></span>:</h3>
            <div id="moon-buttons" class="space-y-1 pl-2"></div>
        </div>

        <div class="mt-4 p-3 bg-gray-900 bg-opacity-50 rounded text-xs">
            <p class="font-semibold mb-1">🏆 Achievements: <span id="achievement-count">0/10</span></p>
            <p class="font-semibold mb-1">Quick Stats:</p>
            <p>📊 Total Objects: <span id="total-objects">-</span></p>
            <p>🌍 Planets: 8 | 🌙 Moons: 146+</p>
            <p>☄️ Asteroids: 3500 | 🪐 Dwarf: 5</p>
            <p>🚀 Missions: 3 | ☄️ Comets: 1</p>
            <p>🎯 FPS: <span id="fps-counter">60</span></p>
        </div>
    </div>

    <div class="absolute top-4 right-4 text-white control-panel p-4 rounded-lg z-10 max-w-xs max-h-screen overflow-y-auto" style="max-height: 95vh;">
        <div class="mb-4">
            <label class="text-sm font-semibold block mb-2">⚡ Speed: <span id="speed-display">1.0x</span></label>
            <input type="range" id="speed-slider" min="-50" max="100" step="1" value="1" class="w-full">
            <div class="flex justify-between text-xs mt-1">
                <span>⏪ -50x</span>
                <span>⏩ 100x</span>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">🕐 Time Jump</p>
            <div class="grid grid-cols-3 gap-1 text-xs">
                <button onclick="jumpTime(-365)" class="toggle-btn">-1 Year</button>
                <button onclick="jumpTime(-30)" class="toggle-btn">-1 Month</button>
                <button onclick="jumpTime(-1)" class="toggle-btn">-1 Day</button>
                <button onclick="jumpTime(1)" class="toggle-btn">+1 Day</button>
                <button onclick="jumpTime(30)" class="toggle-btn">+1 Month</button>
                <button onclick="jumpTime(365)" class="toggle-btn">+1 Year</button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">📷 Camera Views</p>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setCameraPreset('overview')" class="toggle-btn text-xs">🌌 Overview</button>
                <button onclick="setCameraPreset('top')" class="toggle-btn text-xs">⬆️ Top</button>
                <button onclick="setCameraPreset('side')" class="toggle-btn text-xs">➡️ Side</button>
                <button onclick="startTour()" class="toggle-btn text-xs">🚀 Tour</button>
                <button onclick="setCameraPreset('inner')" class="toggle-btn text-xs">🔍 Inner</button>
                <button onclick="setCameraPreset('outer')" class="toggle-btn text-xs">🌠 Outer</button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">🎨 Display Options</p>
            <div class="grid grid-cols-2 gap-2 text-xs">
                <button id="toggle-orbits" onclick="toggleOrbits()" class="toggle-btn active">Orbits</button>
                <button id="toggle-trails" onclick="toggleTrails()" class="toggle-btn active">Trails</button>
                <button id="toggle-labels" onclick="toggleLabels()" class="toggle-btn active">Labels</button>
                <button id="toggle-moons" onclick="toggleMoons()" class="toggle-btn active">Moons</button>
                <button id="toggle-asteroids" onclick="toggleAsteroids()" class="toggle-btn active">Asteroids</button>
                <button id="toggle-dwarf" onclick="toggleDwarfPlanets()" class="toggle-btn active">Dwarf</button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">🔬 Advanced</p>
            <div class="space-y-2 text-xs">
                <button onclick="toggleHabitableZone()" class="toggle-btn w-full">🟢 Habitable Zone</button>
                <button onclick="toggleLagrangePoints()" class="toggle-btn w-full">⭕ Lagrange Points</button>
                <button onclick="toggleAxialTilt()" class="toggle-btn w-full">🌍 Axial Tilt</button>
                <button onclick="toggleEclipses()" class="toggle-btn w-full">🌑 Eclipses</button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">🌈 Visual Effects</p>
            <div class="space-y-2 text-xs">
                <button onclick="toggleAuroras()" class="toggle-btn w-full">✨ Auroras</button>
                <button onclick="toggleMagnetosphere()" class="toggle-btn w-full">🧲 Magnetosphere</button>
                <button onclick="toggleSolarWind()" class="toggle-btn w-full">💨 Solar Wind</button>
                <button id="toggle-textures" onclick="toggleTextures()" class="toggle-btn w-full active">🖼️ Realistic Textures</button>
            </div>
        </div>

        <div class="space-y-2 text-xs">
            <button onclick="toggleSearch()" class="toggle-btn w-full">🔍 Search</button>
            <button onclick="showComparison()" class="toggle-btn w-full">📊 Compare</button>
            <button onclick="toggleCalculator()" class="toggle-btn w-full">🧮 Calculator</button>
            <button onclick="toggleMissionPlanner()" class="toggle-btn w-full">🚀 Mission Plan</button>
            <button onclick="toggleExoplanets()" class="toggle-btn w-full">🌍 Exoplanets</button>
            <button onclick="takeScreenshot()" class="toggle-btn w-full">📸 Screenshot</button>
            <button onclick="playSound()" class="toggle-btn w-full" id="sound-btn">🔇 Sound OFF</button>
        </div>
    </div>

    <div class="absolute bottom-4 left-4 text-white text-xs bg-black bg-opacity-80 p-4 rounded-lg backdrop-blur-sm">
        <p class="font-semibold mb-1">🎮 Controls:</p>
        <p>🖱️ Left Drag: Rotate | ⚙️ Scroll: Zoom</p>
        <p>📱 Touch: Pan & Pinch | 🖱️ Click: Select</p>
    </div>

    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white text-xs bg-black bg-opacity-80 p-4 rounded-lg backdrop-blur-sm text-center">
        <p id="distance-indicator" class="text-blue-300">Distance: -</p>
        <p id="speed-indicator" class="text-green-300">Orbital Speed: -</p>
        <p id="conjunction-indicator" class="text-purple-300">Next Conjunction: Calculating...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Loading progress simulation
        let loadProgress = 0;
        const loadInterval = setInterval(() => {
            loadProgress += Math.random() * 15;
            if (loadProgress >= 100) {
                loadProgress = 100;
                clearInterval(loadInterval);
            }
            document.getElementById('loading-bar').style.width = loadProgress + '%';
            const stages = ['Loading stars...', 'Creating planets...', 'Adding moons...', 'Populating asteroid belt...', 'Initializing missions...', 'Almost ready...'];
            const stage = Math.floor(loadProgress / 100 * stages.length);
            document.getElementById('loading-text').textContent = stages[Math.min(stage, stages.length - 1)];
        }, 200);

        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.00015);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 15000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        const textureLoader = new THREE.TextureLoader();
        const maxAniso = renderer.capabilities.getMaxAnisotropy();

        let showOrbits = true, showTrails = true, showLabels = true, showMoons = true, showAsteroids = true;
        let showDwarfPlanets = true, showHabitableZone = false, showLagrangePoints = false;
        let useRealisticTextures = true;
        let soundEnabled = false, isTourActive = false, tourIndex = 0, showAxialTilt = false, showEclipses = false, showExoplanets = false;
        let targetOverride = null; // allows focusing non-planet targets like comets
        let simulationDate = new Date(2024, 0, 1, 0, 0, 0);
        let startDate = new Date(2024, 0, 1, 0, 0, 0);
        let achievements = new Set();
        let audioContext = null;
        let visitedPlanets = new Set();
        let startTime = Date.now();
        let currentSelection = { type: 'planet', key: 'sun' };
        const pinnedItems = [];
        const maxPinnedItems = 4;
        
        // Aurora & Magnetosphere settings
        let showAuroras = false, showMagnetosphere = false, showSolarWind = false;
        let auroras = {}, magnetospheres = {}, solarWindParticles = null;

        const ambientLight = new THREE.AmbientLight(0x222222, 0.5);
        scene.add(ambientLight);
        const sunLight = new THREE.PointLight(0xffffff, 2.5, 5000);
        sunLight.castShadow = true;
        scene.add(sunLight);

        const starGeometry = new THREE.BufferGeometry();
        const starVertices = [], starColors = [];
        for (let i = 0; i < 25000; i++) {
            starVertices.push((Math.random() - 0.5) * 10000, (Math.random() - 0.5) * 10000, (Math.random() - 0.5) * 10000);
            const c = Math.random();
            starColors.push(c > 0.9 ? 0.5 : 1, c > 0.9 ? 0.7 : c > 0.7 ? 0.8 : c > 0.5 ? 0.6 : 1, c > 0.9 ? 1 : c > 0.7 ? 0.6 : c > 0.5 ? 0.4 : 1);
        }
        starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
        starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));
        scene.add(new THREE.Points(starGeometry, new THREE.PointsMaterial({ size: 3, vertexColors: true, transparent: true, opacity: 0.9 })));

        const planetData = {
            sun: { name: 'The Sun', radius: 20, color: 0xfdb813, distance: 0, speed: 0, tilt: 0, rotationSpeed: 0.001,
                description: 'The star at the center of our solar system.', stats: { diameter: '1,392,700 km', mass: '1.989 × 10³⁰ kg', temperature: '5,778 K' },
                funFact: 'The Sun converts 600 million tons of hydrogen into helium every second!', mythology: 'Helios drove a chariot across the sky.',
                discovery: 'Known since ancient times', escapeVelocity: 617.5, gravity: 274, orbitalPeriod: 0 },
            mercury: { name: 'Mercury', radius: 2.4, color: 0x8c7853, distance: 40, speed: 0.04, tilt: 0.034, rotationSpeed: 0.001,
                description: 'Smallest planet with extreme temperatures.', stats: { diameter: '4,879 km', 'orbital period': '88 days', moons: '0' },
                funFact: 'Mercury\'s day is longer than its year!', mythology: 'Named after the Roman messenger god.',
                discovery: 'Known since ancient times', escapeVelocity: 4.3, gravity: 3.7, orbitalPeriod: 88 },
            venus: { name: 'Venus', radius: 6, color: 0xffc649, distance: 60, speed: 0.015, tilt: 177.4, rotationSpeed: -0.0004,
                description: 'Earth\'s sister planet with toxic atmosphere.', stats: { diameter: '12,104 km', moons: '0' },
                funFact: 'Venus rotates backwards!', mythology: 'Roman goddess of love and beauty.',
                discovery: 'Known since ancient times', escapeVelocity: 10.4, gravity: 8.9, orbitalPeriod: 225 },
            earth: { name: 'Earth', radius: 6.4, color: 0x4a90e2, distance: 80, speed: 0.01, tilt: 23.5, rotationSpeed: 0.01,
                description: 'Our home planet.', stats: { diameter: '12,742 km', population: '8 billion+', moons: '1 (Moon)' },
                funFact: '71% covered in water!', mythology: 'Gaia, Greek goddess of Earth.',
                discovery: 'Our home planet', escapeVelocity: 11.2, gravity: 9.8, hasMoons: true, hasStation: true, orbitalPeriod: 365 },
            mars: { name: 'Mars', radius: 3.4, color: 0xdc4b3e, distance: 100, speed: 0.008, tilt: 25.2, rotationSpeed: 0.01,
                description: 'The Red Planet.', stats: { diameter: '6,779 km', moons: '2 (Phobos, Deimos)' },
                funFact: 'Olympus Mons is 21 km high!', mythology: 'Roman god of war.',
                discovery: 'Known since ancient times', escapeVelocity: 5.0, gravity: 3.7, hasMoons: true, orbitalPeriod: 687 },
            jupiter: { name: 'Jupiter', radius: 11, color: 0xd4a574, distance: 140, speed: 0.002, tilt: 3.1, rotationSpeed: 0.04,
                description: 'Largest planet with Great Red Spot.', stats: { diameter: '139,820 km', moons: '95+ (Io, Europa, Ganymede, Callisto + 91 more)' },
                funFact: 'Great Red Spot has raged for 400+ years!', mythology: 'King of Roman gods.',
                discovery: 'Known since ancient times', escapeVelocity: 59.5, gravity: 24.8, hasMoons: true, orbitalPeriod: 4333 },
            saturn: { name: 'Saturn', radius: 9.5, color: 0xe5c287, distance: 180, speed: 0.0009, tilt: 26.7, rotationSpeed: 0.038,
                description: 'Famous for its ring system.', stats: { diameter: '116,460 km', moons: '146+ (Titan, Rhea, Enceladus + 143 more)' },
                funFact: 'Saturn would float in water!', mythology: 'Roman god of agriculture.',
                discovery: 'Known since ancient times', escapeVelocity: 35.5, gravity: 10.4, hasMoons: true, orbitalPeriod: 10759 },
            uranus: { name: 'Uranus', radius: 4, color: 0x4fd0e7, distance: 220, speed: 0.0004, tilt: 97.8, rotationSpeed: -0.02,
                description: 'Ice giant rotating on its side.', stats: { diameter: '50,724 km', tilt: '97.8°', moons: '27 (Titania, Oberon + 25 more)' },
                funFact: 'Uranus rotates nearly on its side!', mythology: 'Greek god of the sky.',
                discovery: 'Discovered by William Herschel in 1781', escapeVelocity: 21.3, gravity: 8.9, hasMoons: true, orbitalPeriod: 30687 },
            neptune: { name: 'Neptune', radius: 3.9, color: 0x4166f5, distance: 260, speed: 0.0001, tilt: 28.3, rotationSpeed: 0.025,
                description: 'Furthest planet with supersonic winds.', stats: { diameter: '49,244 km', 'wind speed': '2,100 km/h', moons: '14 (Triton + 13 more)' },
                funFact: 'Fastest winds in the solar system!', mythology: 'Roman god of the sea.',
                discovery: 'Discovered by Johann Galle in 1846', escapeVelocity: 23.5, gravity: 11.2, hasMoons: true, orbitalPeriod: 60190 },
            pluto: { name: 'Pluto', radius: 1.2, color: 0xc9a687, distance: 310, speed: 0.00004, tilt: 122.5, rotationSpeed: -0.003,
                description: 'Dwarf planet with heart-shaped glacier.', stats: { diameter: '2,377 km', type: 'Dwarf Planet', moons: '5 (Charon + 4 more)' },
                funFact: 'Charon is so big they orbit each other!', mythology: 'Roman god of the underworld.',
                discovery: 'Discovered by Clyde Tombaugh in 1930', escapeVelocity: 1.2, gravity: 0.6, hasMoons: true, isDwarf: true, orbitalPeriod: 90560 },
            ceres: { name: 'Ceres', radius: 0.6, color: 0x8b8680, distance: 125, speed: 0.0035, tilt: 4, rotationSpeed: 0.02,
                description: 'Largest asteroid belt object.', stats: { diameter: '940 km', location: 'Asteroid Belt', moons: '0' },
                funFact: 'Contains 1/3 of asteroid belt mass!', mythology: 'Roman goddess of agriculture.',
                discovery: 'Discovered by Giuseppe Piazzi in 1801', escapeVelocity: 0.5, gravity: 0.3, isDwarf: true, orbitalPeriod: 1680 },
            eris: { name: 'Eris', radius: 1.2, color: 0xcccccc, distance: 350, speed: 0.00002, tilt: 44, rotationSpeed: 0.005,
                description: 'Most massive dwarf planet beyond Neptune.', stats: { diameter: '2,326 km', type: 'Dwarf Planet', moons: '1 (Dysnomia)' },
                funFact: 'Eris caused Pluto\'s demotion to dwarf planet!', mythology: 'Greek goddess of strife and discord.',
                discovery: 'Discovered by Mike Brown in 2005', escapeVelocity: 1.4, gravity: 0.8, isDwarf: true, orbitalPeriod: 203830 },
            makemake: { name: 'Makemake', radius: 0.75, color: 0xd4a574, distance: 330, speed: 0.000025, tilt: 28.96, rotationSpeed: 0.006,
                description: 'Third largest dwarf planet in Kuiper Belt.', stats: { diameter: '1,430 km', type: 'Dwarf Planet', moons: '1' },
                funFact: 'Named after Rapa Nui creation deity!', mythology: 'Rapa Nui (Easter Island) creator god.',
                discovery: 'Discovered by Mike Brown in 2005', escapeVelocity: 0.8, gravity: 0.5, isDwarf: true, orbitalPeriod: 111845 },
            haumea: { name: 'Haumea', radius: 1.0, color: 0xffeeee, distance: 320, speed: 0.000028, tilt: 28, rotationSpeed: 0.3,
                description: 'Elongated dwarf planet spinning rapidly.', stats: { diameter: '1,632 km', type: 'Dwarf Planet', shape: 'Ellipsoid', moons: '2' },
                funFact: 'Fastest rotating large object in solar system!', mythology: 'Hawaiian goddess of childbirth.',
                discovery: 'Discovered by Mike Brown in 2004', escapeVelocity: 0.84, gravity: 0.44, isDwarf: true, orbitalPeriod: 103410 }
        };

        const moonData = {
            earth: [{ name: 'Moon', distance: 10, radius: 1.7, speed: 0.08, color: 0xcccccc }],
            mars: [
                { name: 'Phobos', distance: 6, radius: 0.5, speed: 0.15, color: 0x999999 }, 
                { name: 'Deimos', distance: 8, radius: 0.4, speed: 0.1, color: 0xaaaaaa }
            ],
            jupiter: [
                { name: 'Io', distance: 18, radius: 1.8, speed: 0.1, color: 0xffcc00 }, 
                { name: 'Europa', distance: 24, radius: 1.6, speed: 0.08, color: 0xddddff }, 
                { name: 'Ganymede', distance: 30, radius: 2.6, speed: 0.06, color: 0x998877 }, 
                { name: 'Callisto', distance: 36, radius: 2.4, speed: 0.04, color: 0x776655 }
            ],
            saturn: [
                { name: 'Titan', distance: 26, radius: 2.6, speed: 0.05, color: 0xffaa66 }, 
                { name: 'Rhea', distance: 20, radius: 0.8, speed: 0.07, color: 0xcccccc },
                { name: 'Enceladus', distance: 16, radius: 0.6, speed: 0.09, color: 0xffffff }
            ],
            uranus: [
                { name: 'Titania', distance: 12, radius: 0.8, speed: 0.09, color: 0xaaccdd }, 
                { name: 'Oberon', distance: 15, radius: 0.7, speed: 0.07, color: 0x99bbcc }
            ],
            neptune: [
                { name: 'Triton', distance: 14, radius: 1.4, speed: 0.07, color: 0xbbccff }
            ],
            pluto: [
                { name: 'Charon', distance: 8, radius: 0.6, speed: 0.1, color: 0xaaaaaa }
            ]
        };

        function buildSearchIndex() {
            const entries = [];
            Object.keys(planetData).forEach(key => {
                if (key === 'sun') return;
                entries.push({ type: 'planet', key, name: planetData[key].name, description: planetData[key].description });
            });
            Object.keys(moonData).forEach(parent => {
                (moonData[parent] || []).forEach((moon, idx) => {
                    entries.push({ type: 'moon', parent, index: idx, name: moon.name, description: `Moon of ${planetData[parent].name}` });
                });
            });
            entries.push({ type: 'comet', key: 'halley', name: "Halley's Comet", description: 'Short-period comet (~76 years)' });
            (spaceProbes || []).forEach(probe => {
                entries.push({ type: 'mission', key: probe.name.toLowerCase(), name: probe.name, description: 'Space mission/probe' });
            });
            return entries;
        }
        let searchIndex = [];

        const celestialBodies = {}, orbits = {}, planetTrails = {}, labels = {}, moons = {}, planetTextures = {}, moonTextures = {};
        let asteroidTexture = null;
        const textureFiles = {
            sun: 'textures/sun.jpg',
            mercury: 'textures/mercury.jpg',
            venus: 'textures/venus.jpg',
            earth: 'textures/earth.jpg',
            mars: 'textures/mars.jpg',
            jupiter: 'textures/jupiter.jpg',
            saturn: 'textures/saturn.jpg',
            uranus: 'textures/uranus.jpg',
            neptune: 'textures/neptune.jpg',
            pluto: 'textures/pluto.jpg',
            moon: 'textures/moon.jpg'
        };
        let issGroup = null, cometAngle = 0, issAngle = 0;
        let spaceProbes = [];
        let sunGlare = null;
        const sunRotationSpeed = 0.01;

        function createPlanetTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 512;
            const ctx = canvas.getContext('2d');

            const rand = () => Math.random();
            const noise = (x, y, scale = 80) => {
                const nx = x / scale, ny = y / scale;
                return (Math.sin(nx * 2.1 + ny * 0.9) + Math.sin(nx * 1.3 - ny * 1.7) + Math.sin(nx * 3.5 + ny * 2.5)) * 0.33 + 0.5;
            };
            const addShading = () => {
                // Soft limb darkening for depth
                const shade = ctx.createRadialGradient(512, 256, 0, 512, 256, 520);
                shade.addColorStop(0, 'rgba(0,0,0,0)');
                shade.addColorStop(0.7, 'rgba(0,0,0,0)');
                shade.addColorStop(1, 'rgba(0,0,0,0.35)');
                ctx.globalCompositeOperation = 'multiply';
                ctx.fillStyle = shade;
                ctx.fillRect(0, 0, 1024, 512);
                ctx.globalCompositeOperation = 'source-over';
            };

            if (type === 'sun') {
                const grad = ctx.createRadialGradient(512, 256, 0, 512, 256, 512);
                grad.addColorStop(0, '#fff8e7');
                grad.addColorStop(0.3, '#ffd700');
                grad.addColorStop(0.6, '#ff9a1f');
                grad.addColorStop(1, '#ff4500');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, 1024, 512);
                for (let i = 0; i < 500; i++) {
                    ctx.fillStyle = `rgba(255, ${200 + rand() * 55}, 0, ${0.15 + rand() * 0.5})`;
                    ctx.beginPath();
                    ctx.arc(rand() * 1024, rand() * 512, rand() * 60, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (type === 'earth') {
                ctx.fillStyle = '#0f2f5f';
                ctx.fillRect(0, 0, 1024, 512);
                // Continents
                ctx.fillStyle = '#3aa35d';
                for (let i = 0; i < 35; i++) {
                    ctx.beginPath();
                    const sx = rand() * 1024, sy = rand() * 512;
                    ctx.moveTo(sx, sy);
                    for (let j = 0; j < 20; j++) ctx.lineTo(sx + (rand() - 0.5) * 280, sy + (rand() - 0.5) * 220);
                    ctx.closePath(); ctx.fill();
                }
                // Polar caps
                ctx.fillStyle = '#f7f7f7';
                ctx.beginPath(); ctx.arc(512, 90, 70, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(512, 422, 70, 0, Math.PI * 2); ctx.fill();
                // Cloudy wisps
                ctx.fillStyle = 'rgba(255,255,255,0.25)';
                for (let i = 0; i < 80; i++) {
                    ctx.beginPath();
                    ctx.ellipse(rand() * 1024, rand() * 512, 80 + rand() * 80, 20 + rand() * 20, rand() * Math.PI, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (['jupiter', 'saturn', 'uranus', 'neptune'].includes(type)) {
                const base = { jupiter: '#d8b48a', saturn: '#e6c99b', uranus: '#74d7e4', neptune: '#4c6df5' }[type];
                ctx.fillStyle = base;
                ctx.fillRect(0, 0, 1024, 512);
                const bandCount = type === 'jupiter' ? 24 : type === 'saturn' ? 20 : 16;
                for (let i = 0; i < bandCount; i++) {
                    const y = (i / bandCount) * 512;
                    const h = 10 + rand() * 16;
                    const hueShift = (rand() - 0.5) * 10;
                    ctx.fillStyle = type === 'neptune' ? `rgba(80,120,255,${0.35 + rand() * 0.4})` : `hsla(35,60%,${60 + hueShift}%,${0.4 + rand() * 0.35})`;
                    ctx.fillRect(0, y, 1024, h);
                }
                // Storms / spots
                for (let i = 0; i < 12; i++) {
                    const r = 10 + rand() * 30;
                    ctx.fillStyle = `rgba(200,120,80,${0.2 + rand() * 0.4})`;
                    ctx.beginPath();
                    ctx.ellipse(rand() * 1024, rand() * 512, r * 1.5, r, rand() * Math.PI, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else {
                const baseColors = { 
                    mercury: '#8c7a63', venus: '#d9b166', mars: '#c4523d', pluto: '#c9a687', 
                    ceres: '#8b8680', eris: '#cfcfcf', makemake: '#d4a574', haumea: '#f2eaea' 
                };
                ctx.fillStyle = baseColors[type] || '#888';
                ctx.fillRect(0, 0, 1024, 512);
                // Craters / noise
                for (let y = 0; y < 512; y += 4) {
                    for (let x = 0; x < 1024; x += 4) {
                        const n = noise(x, y, 55);
                        const shade = Math.floor(n * 25);
                        ctx.fillStyle = `rgba(0,0,0,${0.04 + shade / 255})`;
                        ctx.fillRect(x, y, 4, 4);
                    }
                }
                for (let i = 0; i < 120; i++) {
                    const r = 6 + rand() * 20;
                    ctx.strokeStyle = `rgba(0,0,0,${0.15 + rand() * 0.15})`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(rand() * 1024, rand() * 512, r, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
            addShading();
            return new THREE.CanvasTexture(canvas);
        }

        function getPlanetTexture(key) {
            if (planetTextures[key]) return planetTextures[key];
            let tex = null;
            if (textureFiles[key]) {
                tex = textureLoader.load(textureFiles[key]);
                tex.anisotropy = maxAniso;
            }
            if (!tex) tex = createPlanetTexture(key);
            planetTextures[key] = tex;
            return tex;
        }

        function createSunGlareTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(256, 256, 0, 256, 256, 256);
            grad.addColorStop(0, 'rgba(255,255,255,0.9)');
            grad.addColorStop(0.2, 'rgba(255,220,150,0.6)');
            grad.addColorStop(0.5, 'rgba(255,180,80,0.25)');
            grad.addColorStop(1, 'rgba(255,160,50,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, 512, 512);
            return new THREE.CanvasTexture(canvas);
        }

        function createMoonTexture(name = 'moon') {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            const base = name.toLowerCase().includes('titan') ? '#b5966d' : '#bfbfbf';
            ctx.fillStyle = base;
            ctx.fillRect(0, 0, 512, 512);

            const noise = () => (Math.random() - 0.5) * 0.4;
            for (let y = 0; y < 512; y++) {
                for (let x = 0; x < 512; x++) {
                    const n = (noise() + noise() + noise()) * 0.5;
                    const shade = Math.floor(n * 30);
                    ctx.fillStyle = `rgba(0,0,0,${0.15 + shade / 255})`;
                    ctx.fillRect(x, y, 1, 1);
                }
            }
            // Craters
            const craterCount = 120;
            for (let i = 0; i < craterCount; i++) {
                const r = 6 + Math.random() * 28;
                const x = Math.random() * 512;
                const y = Math.random() * 512;
                ctx.strokeStyle = 'rgba(0,0,0,0.35)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.stroke();
                ctx.strokeStyle = 'rgba(255,255,255,0.08)';
                ctx.beginPath();
                ctx.arc(x - r * 0.2, y - r * 0.2, r * 0.5, 0, Math.PI * 2);
                ctx.stroke();
            }
            const shade = ctx.createRadialGradient(256, 256, 0, 256, 256, 270);
            shade.addColorStop(0, 'rgba(0,0,0,0)');
            shade.addColorStop(0.7, 'rgba(0,0,0,0)');
            shade.addColorStop(1, 'rgba(0,0,0,0.35)');
            ctx.globalCompositeOperation = 'multiply';
            ctx.fillStyle = shade;
            ctx.fillRect(0, 0, 512, 512);
            ctx.globalCompositeOperation = 'source-over';

            return new THREE.CanvasTexture(canvas);
        }

        function createAsteroidTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#6b5d52';
            ctx.fillRect(0, 0, 512, 512);
            for (let i = 0; i < 4000; i++) {
                const size = Math.random() * 3;
                ctx.fillStyle = `rgba(0,0,0,${0.2 + Math.random() * 0.3})`;
                ctx.beginPath();
                ctx.arc(Math.random() * 512, Math.random() * 512, size, 0, Math.PI * 2);
                ctx.fill();
            }
            for (let i = 0; i < 40; i++) {
                const r = 8 + Math.random() * 24;
                ctx.strokeStyle = 'rgba(255,255,255,0.08)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(Math.random() * 512, Math.random() * 512, r, 0, Math.PI * 2);
                ctx.stroke();
            }
            return new THREE.CanvasTexture(canvas);
        }

        // Enhanced Sun with larger lens flare
        const sunGeo = new THREE.SphereGeometry(planetData.sun.radius, 64, 64);
        const sun = new THREE.Mesh(sunGeo, new THREE.MeshBasicMaterial({ map: getPlanetTexture('sun'), color: 0xfdb813 }));
        scene.add(sun);
        celestialBodies.sun = { mesh: sun, data: planetData.sun, angle: 0 };

        const glareTexture = createSunGlareTexture();
        sunGlare = new THREE.Sprite(new THREE.SpriteMaterial({ 
            map: glareTexture, 
            color: 0xffffff, 
            transparent: true, 
            blending: THREE.AdditiveBlending,
            depthWrite: false 
        }));
        sunGlare.scale.set(180, 180, 1);
        scene.add(sunGlare);

        for (let i = 0; i < 6; i++) {
            const glow = new THREE.Mesh(new THREE.SphereGeometry(planetData.sun.radius * (1.1 + i * 0.15), 32, 32),
                new THREE.MeshBasicMaterial({ color: i < 3 ? 0xfdb813 : 0xffffff, transparent: true, opacity: 0.1 / (i + 1), side: THREE.BackSide }));
            sun.add(glow);
        }

        const asteroidBelt = new THREE.Group();
        scene.add(asteroidBelt);
        const asteroids = [], asteroidCount = 3500;
        asteroidTexture = createAsteroidTexture();
        for (let i = 0; i < asteroidCount; i++) {
            const geo = new THREE.DodecahedronGeometry(0.3 + Math.random() * 0.6, 0);
            const baseColor = [0x8B7355, 0x6B5D52, 0x7A6A5A][Math.floor(Math.random() * 3)];
            const material = new THREE.MeshStandardMaterial({ 
                color: baseColor, 
                roughness: 0.95,
                map: useRealisticTextures ? asteroidTexture : null 
            });
            const asteroid = new THREE.Mesh(geo, material);
            const angle = Math.random() * Math.PI * 2, distance = 115 + Math.random() * 20;
            asteroid.position.set(Math.cos(angle) * distance, (Math.random() - 0.5) * 12, Math.sin(angle) * distance);
            asteroidBelt.add(asteroid);
            asteroids.push({ mesh: asteroid, angle, distance, speed: 0.003 + Math.random() * 0.002, rotSpeed: { x: (Math.random() - 0.5) * 0.02, y: (Math.random() - 0.5) * 0.02 }, baseColor });
        }

        // Halley's Comet with 76-year elliptical orbit
        const cometGroup = new THREE.Group();
        cometGroup.add(new THREE.Mesh(new THREE.SphereGeometry(1.8, 16, 16), new THREE.MeshStandardMaterial({ color: 0x88CCFF, emissive: 0x4488FF, emissiveIntensity: 0.6 })));
        const tail = new THREE.Mesh(new THREE.ConeGeometry(4, 50, 8), new THREE.MeshBasicMaterial({ color: 0x88CCFF, transparent: true, opacity: 0.5 }));
        tail.rotation.x = Math.PI / 2; tail.position.z = -25;
        cometGroup.add(tail);
        scene.add(cometGroup);

        // Space Missions
        const voyager1 = new THREE.Mesh(
            new THREE.BoxGeometry(1, 1, 2),
            new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8 })
        );
        scene.add(voyager1);
        
        const newHorizons = new THREE.Mesh(
            new THREE.ConeGeometry(0.8, 2, 8),
            new THREE.MeshStandardMaterial({ color: 0x4488ff, metalness: 0.7 })
        );
        scene.add(newHorizons);
        
        const parkerProbe = new THREE.Mesh(
            new THREE.OctahedronGeometry(0.8),
            new THREE.MeshStandardMaterial({ color: 0xff4444, metalness: 0.9, emissive: 0xff4444, emissiveIntensity: 0.3 })
        );
        scene.add(parkerProbe);

        spaceProbes = [
            { mesh: voyager1, name: 'Voyager 1', angle: 0, distance: 500, speed: 0.0001 },
            { mesh: newHorizons, name: 'New Horizons', angle: Math.PI, distance: 300, speed: 0.00005, target: 'pluto' },
            { mesh: parkerProbe, name: 'Parker Solar Probe', angle: 0, distance: 25, speed: 0.05, solar: true }
        ];
        searchIndex = buildSearchIndex();

        let habitableZoneInner, habitableZoneOuter, lagrangePoints = [];
        habitableZoneInner = new THREE.Mesh(new THREE.RingGeometry(75, 76, 128), new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide, transparent: true, opacity: 0.3 }));
        habitableZoneOuter = new THREE.Mesh(new THREE.RingGeometry(150, 151, 128), new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide, transparent: true, opacity: 0.3 }));
        habitableZoneInner.rotation.x = habitableZoneOuter.rotation.x = Math.PI / 2;
        habitableZoneInner.visible = habitableZoneOuter.visible = false;
        scene.add(habitableZoneInner, habitableZoneOuter);

        [{ x: 79.2, z: 0 }, { x: 80.8, z: 0 }, { x: -80, z: 0 }, { x: 40, z: 69.3 }, { x: 40, z: -69.3 }].forEach(pos => {
            const point = new THREE.Mesh(new THREE.SphereGeometry(1.5, 16, 16), new THREE.MeshBasicMaterial({ color: 0xff00ff, transparent: true, opacity: 0.7 }));
            point.position.set(pos.x, 0, pos.z); point.visible = false;
            scene.add(point); lagrangePoints.push(point);
        });

        Object.keys(planetData).forEach(key => {
            if (key === 'sun') return;
            const data = planetData[key];

            const orbitGeo = new THREE.BufferGeometry();
            const orbitPts = [];
            for (let i = 0; i <= 128; i++) {
                const angle = (i / 128) * Math.PI * 2;
                orbitPts.push(Math.cos(angle) * data.distance, 0, Math.sin(angle) * data.distance);
            }
            orbitGeo.setAttribute('position', new THREE.Float32BufferAttribute(orbitPts, 3));
            const orbit = new THREE.Line(orbitGeo, new THREE.LineBasicMaterial({ color: data.isDwarf ? 0x888888 : 0x4488ff, opacity: data.isDwarf ? 0.2 : 0.35, transparent: true }));
            scene.add(orbit);
            orbits[key] = orbit;

            const trailGeo = new THREE.BufferGeometry();
            trailGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(300), 3));
            const trail = new THREE.Line(trailGeo, new THREE.LineBasicMaterial({ color: data.color, opacity: 0.5, transparent: true }));
            scene.add(trail);
            planetTrails[key] = { line: trail, positions: [], maxLength: 100 };

            const texture = getPlanetTexture(key);
            const planet = new THREE.Mesh(new THREE.SphereGeometry(data.radius, 64, 64), 
                new THREE.MeshStandardMaterial({ map: texture, roughness: key.includes('jupiter') || key.includes('saturn') || key.includes('uranus') || key.includes('neptune') ? 0.3 : 0.85 }));
            planetTextures[key] = texture;
            planet.position.x = data.distance;
            if (showAxialTilt) planet.rotation.z = (data.tilt || 0) * Math.PI / 180;
            scene.add(planet);
            celestialBodies[key] = { mesh: planet, data: data, angle: Math.random() * Math.PI * 2 };

            const labelCanvas = document.createElement('canvas');
            labelCanvas.width = 256; labelCanvas.height = 64;
            const lctx = labelCanvas.getContext('2d');
            lctx.fillStyle = 'rgba(0,0,0,0.7)'; lctx.fillRect(0, 0, 256, 64);
            lctx.fillStyle = 'white'; lctx.font = 'bold 30px Arial'; lctx.textAlign = 'center';
            lctx.fillText(data.name, 128, 42);
            const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(labelCanvas), transparent: true }));
            label.scale.set(data.radius * 3.5, data.radius * 0.875, 1);
            label.position.set(0, data.radius + 4, 0);
            planet.add(label);
            labels[key] = label;

            if (key === 'earth') {
                const atm = new THREE.Mesh(new THREE.SphereGeometry(data.radius * 1.06, 64, 64), new THREE.MeshPhongMaterial({ color: '#87CEEB', transparent: true, opacity: 0.18, side: THREE.BackSide }));
                planet.add(atm);

                // City lights on night side
                const lightsCanvas = document.createElement('canvas');
                lightsCanvas.width = 1024; lightsCanvas.height = 512;
                const lctx2 = lightsCanvas.getContext('2d');
                lctx2.fillStyle = 'black'; lctx2.fillRect(0, 0, 1024, 512);
                lctx2.fillStyle = '#ffff99';
                for (let i = 0; i < 500; i++) {
                    lctx2.fillRect(Math.random() * 1024, Math.random() * 512, 2, 2);
                }
                const cityLights = new THREE.Mesh(
                    new THREE.SphereGeometry(data.radius * 1.01, 64, 64),
                    new THREE.MeshBasicMaterial({ 
                        map: new THREE.CanvasTexture(lightsCanvas), 
                        transparent: true, 
                        opacity: 0.4, 
                        blending: THREE.AdditiveBlending 
                    })
                );
                planet.add(cityLights);
                planet.userData.cityLights = cityLights;

                // Animated clouds
                const cloudsCanvas = document.createElement('canvas');
                cloudsCanvas.width = 1024; cloudsCanvas.height = 512;
                const cctx = cloudsCanvas.getContext('2d');
                cctx.fillStyle = 'rgba(255,255,255,0.5)';
                for (let i = 0; i < 150; i++) {
                    cctx.beginPath();
                    cctx.arc(Math.random() * 1024, Math.random() * 512, Math.random() * 50 + 20, 0, Math.PI * 2);
                    cctx.fill();
                }
                const clouds = new THREE.Mesh(
                    new THREE.SphereGeometry(data.radius * 1.02, 64, 64),
                    new THREE.MeshPhongMaterial({ 
                        map: new THREE.CanvasTexture(cloudsCanvas), 
                        transparent: true, 
                        opacity: 0.3 
                    })
                );
                planet.add(clouds);
                planet.userData.clouds = clouds;

                issGroup = new THREE.Group();
                issGroup.add(new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.3, 0.5), new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8 })));
                const sp = new THREE.Mesh(new THREE.BoxGeometry(2, 0.05, 0.6), new THREE.MeshStandardMaterial({ color: 0x1a3a5a }));
                sp.position.set(1.2, 0, 0); issGroup.add(sp);
                const sp2 = sp.clone(); sp2.position.set(-1.2, 0, 0); issGroup.add(sp2);
                issGroup.scale.set(0.3, 0.3, 0.3);
                planet.add(issGroup);
            }

            if (key === 'saturn') {
                const ringGeo = new THREE.RingGeometry(data.radius * 1.5, data.radius * 2.6, 128);
                const rings = new THREE.Mesh(ringGeo, new THREE.MeshStandardMaterial({ color: 0xe5c287, side: THREE.DoubleSide, transparent: true, opacity: 0.95 }));
                rings.rotation.x = Math.PI / 2;
                planet.add(rings);
            }

            if (data.hasMoons && moonData[key]) {
                moons[key] = [];
                moonData[key].forEach(moonInfo => {
                    const moonKey = moonInfo.name || `${key}-moon-${moonInfo.radius}`;
                    let moonTex = moonTextures[moonKey];
                    if (!moonTex) {
                        if (textureFiles.moon) {
                            moonTex = moonTextures.__file || textureLoader.load(textureFiles.moon);
                            moonTex.anisotropy = maxAniso;
                            moonTextures.__file = moonTex;
                        } else {
                            moonTex = createMoonTexture(moonKey);
                        }
                        moonTextures[moonKey] = moonTex;
                    }
                    const moonMesh = new THREE.Mesh(
                        new THREE.SphereGeometry(moonInfo.radius, 32, 32), 
                        new THREE.MeshStandardMaterial({ 
                            color: moonInfo.color, 
                            roughness: 0.95,
                            map: useRealisticTextures ? moonTex : null 
                        })
                    );
                    planet.add(moonMesh);
                    moons[key].push({ mesh: moonMesh, angle: Math.random() * Math.PI * 2, distance: moonInfo.distance, speed: moonInfo.speed, name: moonInfo.name, baseColor: moonInfo.color, texKey: moonInfo.name || `${key}-moon-${moonInfo.radius}` });
                });
            }
        });

        camera.position.set(150, 150, 250);
        camera.lookAt(0, 0, 0);

        let isDragging = false, previousMouse = { x: 0, y: 0 }, cameraRotation = { x: 0.5, y: 0.5 }, cameraDistance = 350, targetPlanet = null;

        // Touch controls
        let touchStartDistance = 0;
        renderer.domElement.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                touchStartDistance = Math.sqrt(dx * dx + dy * dy);
            } else if (e.touches.length === 1) {
                isDragging = true;
                previousMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        });

        renderer.domElement.addEventListener('touchmove', e => {
            e.preventDefault();
            if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const delta = touchStartDistance - distance;
                cameraDistance += delta * 0.5;
                cameraDistance = Math.max(30, Math.min(2000, cameraDistance));
                touchStartDistance = distance;
            } else if (e.touches.length === 1 && isDragging) {
                cameraRotation.y += (e.touches[0].clientX - previousMouse.x) * 0.005;
                cameraRotation.x += (e.touches[0].clientY - previousMouse.y) * 0.005;
                cameraRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraRotation.x));
                previousMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        });

        renderer.domElement.addEventListener('touchend', () => { isDragging = false; });

        renderer.domElement.addEventListener('mousedown', e => { isDragging = true; previousMouse = { x: e.clientX, y: e.clientY }; });
        renderer.domElement.addEventListener('mousemove', e => {
            if (!isDragging) return;
            cameraRotation.y += (e.clientX - previousMouse.x) * 0.005;
            cameraRotation.x += (e.clientY - previousMouse.y) * 0.005;
            cameraRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraRotation.x));
            previousMouse = { x: e.clientX, y: e.clientY };
        });
        renderer.domElement.addEventListener('mouseup', () => isDragging = false);
        renderer.domElement.addEventListener('wheel', e => {
            e.preventDefault();
            cameraDistance += e.deltaY * 0.15;
            cameraDistance = Math.max(30, Math.min(2000, cameraDistance));
        });

        renderer.domElement.addEventListener('click', e => {
            if (isDragging) return;
            const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const meshes = Object.keys(celestialBodies).map(k => celestialBodies[k].mesh);
            const intersects = raycaster.intersectObjects(meshes);
            if (intersects.length > 0) {
                const planetKey = Object.keys(celestialBodies).find(k => celestialBodies[k].mesh === intersects[0].object);
                if (planetKey) focusPlanet(planetKey);
            }
        });

        function focusPlanet(key) {
            targetPlanet = key;
            targetOverride = null;
            const bodyData = celestialBodies[key].data;
            const idealDistance = Math.max(bodyData.radius * 6, Math.min(450, bodyData.distance * 1.7));
            cameraDistance = idealDistance;
            const data = celestialBodies[key].data;
            
            if (key !== 'sun') {
                visitedPlanets.add(key);
                if (visitedPlanets.size >= 8 && !['pluto', 'ceres', 'eris', 'makemake', 'haumea'].includes(key)) {
                    checkAchievement('astronomer');
                }
            }
            
            document.getElementById('planet-name').textContent = data.name;
            document.getElementById('planet-description').textContent = data.description;
            const statsDiv = document.getElementById('planet-stats');
            statsDiv.innerHTML = '';
            Object.keys(data.stats).forEach(k => {
                const p = document.createElement('p');
                p.className = 'text-gray-400';
                p.innerHTML = `<strong>${k}:</strong> ${data.stats[k]}`;
                statsDiv.appendChild(p);
            });
            document.getElementById('fun-fact').classList.toggle('hidden', !data.funFact);
            if (data.funFact) document.getElementById('fact-text').textContent = data.funFact;
            document.getElementById('mythology').classList.toggle('hidden', !data.mythology);
            if (data.mythology) document.getElementById('mythology-text').textContent = data.mythology;
            document.getElementById('discovery').classList.toggle('hidden', !data.discovery);
            if (data.discovery) document.getElementById('discovery-text').textContent = data.discovery;
            currentSelection = { type: 'planet', key };
            updatePinButton();
            
            document.querySelectorAll('.planet-button').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById(`btn-${key}`);
            if (btn) btn.classList.add('active');
            
            const moonContainer = document.getElementById('moon-buttons-container');
            const moonButtonsDiv = document.getElementById('moon-buttons');
            moonButtonsDiv.innerHTML = '';
            
            if (moons[key] && moons[key].length > 0) {
                moonContainer.style.display = 'block';
                document.getElementById('moon-parent-name').textContent = data.name;
                
                moons[key].forEach((moon, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'planet-button w-full text-left px-3 py-2 rounded text-xs text-white';
                    btn.style.paddingLeft = '1.5rem';
                    btn.innerHTML = `↳ 🌙 ${moon.name}`;
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        focusMoon(key, idx);
                    });
                    moonButtonsDiv.appendChild(btn);
                });
            } else {
                moonContainer.style.display = 'none';
            }
            
            updateCalculator(data);
            checkAchievement('first_click');
            if (key !== 'sun') checkAchievement('explorer');
        }

        function focusMoon(planetKey, moonIndex) {
            if (!moons[planetKey] || !moons[planetKey][moonIndex]) return;
            
            const moon = moons[planetKey][moonIndex];
            const moonInfo = moonData[planetKey][moonIndex];
            const planet = celestialBodies[planetKey];
            
            targetPlanet = planetKey;
            targetOverride = null;
            cameraDistance = (moonInfo.radius || 1) * 20;
            
            document.getElementById('planet-name').textContent = moon.name;
            document.getElementById('planet-description').textContent = `A moon orbiting ${planet.data.name}`;
            
            const statsDiv = document.getElementById('planet-stats');
            statsDiv.innerHTML = '';
            const p = document.createElement('p');
            p.className = 'text-gray-400';
            p.innerHTML = `<strong>Radius:</strong> ${(moonInfo.radius || 1).toFixed(1)} units<br><strong>Orbital Distance:</strong> ${moon.distance.toFixed(1)} units<br><strong>Orbital Speed:</strong> ${moon.speed.toFixed(3)} units/s`;
            statsDiv.appendChild(p);
            
            document.getElementById('fun-fact').classList.add('hidden');
            document.getElementById('mythology').classList.add('hidden');
            document.getElementById('discovery').classList.add('hidden');
            
            document.querySelectorAll('#moon-buttons .planet-button').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === moonIndex);
            });
            currentSelection = { type: 'moon', parent: planetKey, index: moonIndex, name: moon.name };
            updatePinButton();
            
            checkAchievement('moon_hunter');
        }

        function focusComet() {
            targetPlanet = null;
            targetOverride = cometGroup.position;
            cameraDistance = 320;
            
            document.getElementById('planet-name').textContent = 'Halley\'s Comet';
            document.getElementById('planet-description').textContent = 'Iconic short-period comet that returns roughly every 76 years.';
            const statsDiv = document.getElementById('planet-stats');
            statsDiv.innerHTML = '';
            statsDiv.innerHTML += '<p class=\"text-gray-400\"><strong>Orbital period:</strong> ~76 years</p>';
            statsDiv.innerHTML += '<p class=\"text-gray-400\"><strong>Type:</strong> Short-period comet</p>';
            statsDiv.innerHTML += '<p class=\"text-gray-400\"><strong>Next perihelion:</strong> 2061 (approx)</p>';
            
            document.getElementById('fun-fact').classList.add('hidden');
            document.getElementById('mythology').classList.add('hidden');
            document.getElementById('discovery').classList.add('hidden');
            
            document.querySelectorAll('.planet-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#moon-buttons .planet-button').forEach(btn => btn.classList.remove('active'));
            currentSelection = { type: 'comet', key: 'halley' };
            updatePinButton();
            
            showEvent('Focusing on Halley\'s Comet');
        }

        function updateCalculator(planetData) {
            const weight = parseFloat(document.getElementById('user-weight').value) || 70;
            const resultsDiv = document.getElementById('calc-results');
            
            if (!planetData.gravity) {
                resultsDiv.innerHTML = '<p class="text-gray-400 text-xs">No gravity data available</p>';
                return;
            }
            
            const weightOnPlanet = (weight * planetData.gravity / 9.8).toFixed(1);
            const lightTime = (planetData.distance * 1.5 / 299792).toFixed(2); // distance in million km / speed of light
            
            resultsDiv.innerHTML = `
                <p class="text-green-400"><strong>Your weight:</strong> ${weightOnPlanet} kg</p>
                <p class="text-blue-400"><strong>Escape velocity:</strong> ${planetData.escapeVelocity} km/s</p>
                <p class="text-yellow-400"><strong>Light travel time:</strong> ${lightTime} s</p>
                <p class="text-purple-400"><strong>Surface gravity:</strong> ${planetData.gravity} m/s²</p>
            `;
        }

        document.getElementById('user-weight').addEventListener('input', () => {
            if (targetPlanet && celestialBodies[targetPlanet]) {
                updateCalculator(celestialBodies[targetPlanet].data);
            }
        });

        const buttonsContainer = document.getElementById('planet-buttons');
        Object.keys(planetData).forEach(key => {
            const btn = document.createElement('button');
            btn.id = `btn-${key}`;
            btn.className = 'planet-button w-full text-left px-3 py-2 rounded text-sm';
            const icon = planetData[key].isDwarf ? '🪨' : key === 'sun' ? '⭐' : '🪐';
            btn.textContent = `${icon} ${planetData[key].name}`;
            btn.addEventListener('click', () => focusPlanet(key));
            buttonsContainer.appendChild(btn);
        });

        focusPlanet('sun');

        function setCameraPreset(preset) {
            targetOverride = null;
            if (preset === 'overview') { cameraDistance = 600; cameraRotation = { x: Math.PI / 5, y: 0 }; targetPlanet = null; }
            else if (preset === 'top') { cameraDistance = 500; cameraRotation = { x: Math.PI / 2 - 0.1, y: 0 }; targetPlanet = null; }
            else if (preset === 'side') { cameraDistance = 500; cameraRotation = { x: 0, y: 0 }; targetPlanet = null; }
            else if (preset === 'inner') { cameraDistance = 200; targetPlanet = 'earth'; }
            else if (preset === 'outer') { cameraDistance = 800; targetPlanet = 'neptune'; }
        }

        function startTour() {
            isTourActive = true; tourIndex = 0;
            const planets = Object.keys(planetData).filter(k => k !== 'sun');
            focusPlanet(planets[tourIndex]);
            checkAchievement('tour_guide');
        }

        function jumpTime(days) {
            simulationDate.setDate(simulationDate.getDate() + days);
            showEvent(`Time jumped ${days > 0 ? '+' : ''}${days} days`);
            checkAchievement('time_traveler');
        }

        function toggleOrbits() { showOrbits = !showOrbits; Object.values(orbits).forEach(o => o.visible = showOrbits); document.getElementById('toggle-orbits').classList.toggle('active', showOrbits); }
        function toggleTrails() { showTrails = !showTrails; Object.values(planetTrails).forEach(t => t.line.visible = showTrails); document.getElementById('toggle-trails').classList.toggle('active', showTrails); }
        function toggleLabels() { showLabels = !showLabels; Object.values(labels).forEach(l => l.visible = showLabels); document.getElementById('toggle-labels').classList.toggle('active', showLabels); }
        function toggleMoons() { 
            showMoons = !showMoons; 
            Object.values(moons).forEach(ma => ma.forEach(m => m.mesh.visible = showMoons)); 
            if (issGroup) issGroup.visible = showMoons; 
            document.getElementById('toggle-moons').classList.toggle('active', showMoons); 
        }
        function toggleAsteroids() { showAsteroids = !showAsteroids; asteroidBelt.visible = showAsteroids; document.getElementById('toggle-asteroids').classList.toggle('active', showAsteroids); }
        function toggleDwarfPlanets() { 
            showDwarfPlanets = !showDwarfPlanets; 
            ['pluto', 'ceres', 'eris', 'makemake', 'haumea'].forEach(k => { 
                if (celestialBodies[k]) {
                    celestialBodies[k].mesh.visible = showDwarfPlanets; 
                    if (orbits[k]) orbits[k].visible = showDwarfPlanets && showOrbits;
                }
            }); 
            document.getElementById('toggle-dwarf').classList.toggle('active', showDwarfPlanets); 
        }
        function toggleHabitableZone() { 
            showHabitableZone = !showHabitableZone; 
            habitableZoneInner.visible = habitableZoneOuter.visible = showHabitableZone; 
            const btn = document.querySelector('button[onclick="toggleHabitableZone()"]');
            if (btn) btn.classList.toggle('active', showHabitableZone);
        }
        function toggleLagrangePoints() { 
            showLagrangePoints = !showLagrangePoints; 
            lagrangePoints.forEach(p => p.visible = showLagrangePoints); 
            const btn = document.querySelector('button[onclick="toggleLagrangePoints()"]');
            if (btn) btn.classList.toggle('active', showLagrangePoints);
        }
        function toggleAxialTilt() { 
            showAxialTilt = !showAxialTilt; 
            Object.keys(celestialBodies).forEach(k => {
                if (k !== 'sun') celestialBodies[k].mesh.rotation.z = showAxialTilt ? (celestialBodies[k].data.tilt || 0) * Math.PI / 180 : 0;
            });
            const btn = document.querySelector('button[onclick="toggleAxialTilt()"]');
            if (btn) btn.classList.toggle('active', showAxialTilt);
        }
        function toggleEclipses() {
            showEclipses = !showEclipses;
            const btn = document.querySelector('button[onclick="toggleEclipses()"]');
            if (btn) btn.classList.toggle('active', showEclipses);
            if (showEclipses) showEvent('Eclipse detection enabled');
        }
        function toggleAuroras() {
            showAuroras = !showAuroras;
            const btn = document.querySelector('button[onclick="toggleAuroras()"]');
            if (btn) btn.classList.toggle('active', showAuroras);
            Object.values(auroras).forEach(a => {
                if (a.mesh) a.mesh.visible = showAuroras;
            });
            if (showAuroras) showEvent('Aurora effects enabled');
        }
        function toggleMagnetosphere() {
            showMagnetosphere = !showMagnetosphere;
            const btn = document.querySelector('button[onclick="toggleMagnetosphere()"]');
            if (btn) btn.classList.toggle('active', showMagnetosphere);
            Object.values(magnetospheres).forEach(m => {
                if (m.mesh) m.mesh.visible = showMagnetosphere;
                if (m.lines) m.lines.visible = showMagnetosphere;
            });
            if (showMagnetosphere) showEvent('Magnetospheres enabled');
        }
        function toggleSolarWind() {
            showSolarWind = !showSolarWind;
            const btn = document.querySelector('button[onclick="toggleSolarWind()"]');
            if (btn) btn.classList.toggle('active', showSolarWind);
            if (solarWindParticles) solarWindParticles.visible = showSolarWind;
            if (showSolarWind) showEvent('Solar wind particles enabled');
        }
        function toggleTextures() {
            // Switch between procedural textures and flat color materials
            useRealisticTextures = !useRealisticTextures;
            const btn = document.getElementById('toggle-textures');
            if (btn) btn.classList.toggle('active', useRealisticTextures);

            Object.keys(celestialBodies).forEach(key => {
                const body = celestialBodies[key];
                if (!body || !body.mesh || !body.mesh.material) return;
                const mat = body.mesh.material;
                if (useRealisticTextures) {
                    if (planetTextures[key]) {
                        mat.map = planetTextures[key];
                        mat.color = new THREE.Color(0xffffff);
                    }
                } else {
                    mat.map = null;
                    mat.color = new THREE.Color(body.data.color || 0xffffff);
                }
                mat.needsUpdate = true;
            });

            Object.values(moons).forEach(moonArray => {
                moonArray.forEach(moon => {
                    if (!moon.mesh || !moon.mesh.material) return;
                    const mat = moon.mesh.material;
                    if (useRealisticTextures) {
                        const tex = moonTextures[moon.texKey] || moonTextures[moon.name];
                        if (tex) mat.map = tex;
                        mat.color = new THREE.Color(0xffffff);
                    } else {
                        mat.map = null;
                        mat.color = new THREE.Color(moon.baseColor || 0xffffff);
                    }
                    mat.needsUpdate = true;
                });
            });

            asteroids.forEach(a => {
                if (!a.mesh || !a.mesh.material) return;
                const mat = a.mesh.material;
                if (useRealisticTextures && asteroidTexture) {
                    mat.map = asteroidTexture;
                    mat.color = new THREE.Color(0xffffff);
                } else {
                    mat.map = null;
                    mat.color = new THREE.Color(a.baseColor || 0x777777);
                }
                mat.needsUpdate = true;
            });

            // Hide ancillary Earth layers when simplified
            if (celestialBodies.earth && celestialBodies.earth.mesh) {
                const earthMesh = celestialBodies.earth.mesh;
                if (earthMesh.userData.clouds) earthMesh.userData.clouds.visible = useRealisticTextures;
                if (earthMesh.userData.cityLights) earthMesh.userData.cityLights.visible = useRealisticTextures;
            }

            showEvent(useRealisticTextures ? 'Realistic textures enabled' : 'Simplified colors enabled');
        }
        function toggleSearch() {
            const panel = document.getElementById('search-panel');
            if (!panel) return;
            const input = document.getElementById('search-input');
            const isVisible = panel.style.display === 'block' || getComputedStyle(panel).display !== 'none';
            const show = !isVisible;
            panel.style.display = show ? 'block' : 'none';
            if (show && input) {
                input.focus();
                input.dispatchEvent(new Event('input'));
            }
            const buttons = document.querySelectorAll('.control-panel button[onclick="toggleSearch()"]');
            buttons.forEach(btn => btn.classList.toggle('active', show));
        }
        function toggleCalculator() {
            const panel = document.getElementById('calculator-panel');
            if (!panel) return;
            const isVisible = panel.style.display === 'block' || getComputedStyle(panel).display !== 'none';
            const show = !isVisible;
            panel.style.display = show ? 'block' : 'none';
            const buttons = document.querySelectorAll('.control-panel button[onclick="toggleCalculator()"]');
            buttons.forEach(btn => btn.classList.toggle('active', show));
            if (show) {
                const current = (targetPlanet && celestialBodies[targetPlanet]) ? celestialBodies[targetPlanet].data : planetData.earth;
                updateCalculator(current);
            }
        }
        function playSound() { 
            soundEnabled = !soundEnabled; 
            document.getElementById('sound-btn').textContent = soundEnabled ? '🔊 Sound ON' : '🔇 Sound OFF'; 
            document.getElementById('sound-btn').classList.toggle('active', soundEnabled);
            if (soundEnabled && !audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        function takeScreenshot() { 
            renderer.render(scene, camera); 
            const link = document.createElement('a'); 
            link.download = `solar-system-${Date.now()}.png`; 
            link.href = renderer.domElement.toDataURL('image/png'); 
            link.click();
            showEvent('Screenshot saved!');
            checkAchievement('photographer');
            const btn = document.querySelector('button[onclick="takeScreenshot()"]');
            if (btn) {
                btn.classList.add('active');
                setTimeout(() => btn.classList.remove('active'), 600);
            }
        }

        function showComparison() {
            const view = document.getElementById('comparison-view');
            view.style.display = 'block';
            const btn = document.querySelector('button[onclick="showComparison()"]');
            if (btn) btn.classList.add('active');
            const content = document.getElementById('comparison-content');
            const bodies = Object.keys(planetData)
                .filter(key => key !== 'sun')
                .map(key => planetData[key]);

            const rows = bodies.map(body => {
                const diameter = body.stats?.diameter || '-';
                const gravity = body.gravity != null ? `${body.gravity} m/s²` : '-';
                const escapeVel = body.escapeVelocity != null ? `${body.escapeVelocity} km/s` : '-';
                const period = body.orbitalPeriod != null ? `${body.orbitalPeriod} days` : (body.stats?.['orbital period'] || '-');
                return `<tr class="border-t border-blue-900 hover:bg-blue-900/20 transition-colors">
                    <td class="p-2 font-semibold">${body.name}</td>
                    <td class="p-2">${diameter}</td>
                    <td class="p-2">${gravity}</td>
                    <td class="p-2">${escapeVel}</td>
                    <td class="p-2">${period}</td>
                </tr>`;
            }).join('');

            content.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead>
                            <tr class="border-b border-blue-800 text-blue-200">
                                <th class="p-2">Planet</th>
                                <th class="p-2">Diameter</th>
                                <th class="p-2">Gravity</th>
                                <th class="p-2">Escape Vel.</th>
                                <th class="p-2">Orbital Period</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function closeComparison() {
            document.getElementById('comparison-view').style.display = 'none';
            const btn = document.querySelector('button[onclick="showComparison()"]');
            if (btn) btn.classList.remove('active');
        }

        function searchFor(query) {
            document.getElementById('search-input').value = query;
            document.getElementById('search-input').dispatchEvent(new Event('input'));
        }

        const searchFilters = { planet: true, moon: true, comet: true, mission: true };

        function buildPinId(sel) {
            if (!sel) return null;
            if (sel.type === 'planet') return `planet:${sel.key}`;
            if (sel.type === 'moon') return `moon:${sel.parent}:${sel.index}`;
            if (sel.type === 'comet') return `comet:${sel.key}`;
            if (sel.type === 'mission') return `mission:${sel.key}`;
            return null;
        }

        function isPinned(sel) {
            const id = buildPinId(sel);
            return !!id && pinnedItems.some(p => p.id === id);
        }

        function formatDistance(distance) {
            if (typeof distance !== 'number' || isNaN(distance)) return '-';
            return `${(distance * 1.5).toFixed(0)} million km`;
        }

        function getPinDisplay(item) {
            if (item.type === 'planet') {
                const data = planetData[item.key];
                if (!data) return null;
                return { name: data.name, subtitle: 'Planet', distance: formatDistance(data.distance) };
            }
            if (item.type === 'moon') {
                const parent = planetData[item.parent];
                const moonInfo = (moonData[item.parent] || [])[item.index];
                if (!parent || !moonInfo) return null;
                return { name: moonInfo.name, subtitle: `Moon of ${parent.name}`, distance: `${moonInfo.distance.toFixed(1)} units orbit` };
            }
            if (item.type === 'comet') {
                return { name: "Halley's Comet", subtitle: 'Comet', distance: 'Elliptical orbit' };
            }
            if (item.type === 'mission') {
                return { name: item.name || 'Mission', subtitle: 'Mission', distance: item.target ? `Target: ${item.target}` : '' };
            }
            return null;
        }

        function renderPinnedItems() {
            const container = document.getElementById('pinned-container');
            const cards = document.getElementById('pinned-cards');
            if (!container || !cards) return;
            if (pinnedItems.length === 0) {
                container.classList.add('hidden');
                cards.innerHTML = '';
                updatePinButton();
                return;
            }
            container.classList.remove('hidden');
            cards.innerHTML = pinnedItems.map(item => {
                const meta = getPinDisplay(item) || { name: 'Unknown', subtitle: '', distance: '' };
                return `<div class="bg-gray-900/80 border border-blue-900 rounded p-2 text-xs flex items-start justify-between gap-2">
                    <div>
                        <p class="font-semibold">${meta.name}</p>
                        <p class="text-gray-400">${meta.subtitle}</p>
                        <p class="text-blue-300">${meta.distance || ''}</p>
                    </div>
                    <div class="flex flex-col gap-1">
                        <button class="toggle-btn text-[10px] px-2 py-1" data-action="focus" data-id="${item.id}">Focus</button>
                        <button class="toggle-btn text-[10px] px-2 py-1" data-action="remove" data-id="${item.id}">Unpin</button>
                    </div>
                </div>`;
            }).join('');
            cards.querySelectorAll('button[data-action]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-id');
                    const item = pinnedItems.find(p => p.id === id);
                    if (!item) return;
                    if (btn.getAttribute('data-action') === 'remove') {
                        const idx = pinnedItems.findIndex(p => p.id === id);
                        if (idx !== -1) pinnedItems.splice(idx, 1);
                        renderPinnedItems();
                        updatePinButton();
                        return;
                    }
                    if (item.type === 'planet') focusPlanet(item.key);
                    else if (item.type === 'moon') focusMoon(item.parent, item.index);
                    else if (item.type === 'comet') focusComet();
                });
            });
            updatePinButton();
        }

        function updatePinButton() {
            const btn = document.getElementById('pin-btn');
            if (!btn || !currentSelection) return;
            const pinned = isPinned(currentSelection);
            btn.textContent = pinned ? '📍 Pinned' : '📌 Pin';
            btn.classList.toggle('active', pinned);
        }

        function togglePinCurrent() {
            if (!currentSelection) return;
            const id = buildPinId(currentSelection);
            if (!id) return;
            if (isPinned(currentSelection)) {
                const idx = pinnedItems.findIndex(p => p.id === id);
                if (idx !== -1) pinnedItems.splice(idx, 1);
                renderPinnedItems();
                return;
            }
            if (pinnedItems.length >= maxPinnedItems) {
                showEvent(`You can pin up to ${maxPinnedItems} items.`);
                return;
            }
            if (currentSelection.type === 'mission') return;
            pinnedItems.push({ ...currentSelection, id });
            renderPinnedItems();
        }

        const pinBtn = document.getElementById('pin-btn');
        if (pinBtn) pinBtn.addEventListener('click', togglePinCurrent);

        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'ig');
            return text.replace(regex, '<span class="text-yellow-300 font-semibold">$1</span>');
        }

        ['planet','moon','comet','mission'].forEach(type => {
            const btn = document.getElementById(`filter-${type}`);
            if (btn) {
                btn.addEventListener('click', () => {
                    searchFilters[type] = !searchFilters[type];
                    btn.classList.toggle('active', searchFilters[type]);
                    const input = document.getElementById('search-input');
                    if (input) input.dispatchEvent(new Event('input'));
                });
            }
        });

        document.getElementById('search-input').addEventListener('input', e => {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('search-results');
            results.innerHTML = '';
            
            if (query.length === 0) {
                results.innerHTML = '<p class="text-gray-500 text-xs p-2">Start typing to search...</p>';
                return;
            }
            
            if (query.length < 2) return;
            
            const matches = searchIndex.filter(item => 
                item.name.toLowerCase().includes(query) || (item.key && item.key.toLowerCase().includes(query))
            );

            if (matches.length === 0) {
                results.innerHTML = '<p class="text-gray-500 text-xs p-2">No results found. Try: Earth, Mars, Titan, Jupiter, Halley...</p>';
                return;
            }

            const handleSelection = (item) => {
                if (item.type === 'planet') focusPlanet(item.key);
                else if (item.type === 'moon') focusMoon(item.parent, item.index);
                else if (item.type === 'comet') focusComet();
                toggleSearch();
            };

            const filtered = matches.filter(item => searchFilters[item.type]);

            if (filtered.length === 0) {
                results.innerHTML = '<p class="text-gray-500 text-xs p-2">No results with current filters. Toggle categories above.</p>';
                return;
            }

            filtered
                .slice(0, 30)
                .forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-2 hover:bg-blue-900 rounded text-sm border-l-2 border-blue-500';
                    const icon = item.type === 'planet' 
                        ? (planetData[item.key].isDwarf ? '🪐' : item.key === 'sun' ? '☀️' : '🪐') 
                        : item.type === 'moon' ? '🌙' : item.type === 'mission' ? '🚀' : '☄️';
                    const description = item.description ? item.description.substring(0, 60) : 'Explore this object';
                    const nameHtml = highlightMatch(item.name, query);
                    const descHtml = highlightMatch(description, query);
                    btn.innerHTML = `${icon} <strong>${nameHtml}</strong> <span class="text-xs text-gray-400">- ${descHtml}...</span>`;
                    btn.addEventListener('click', () => handleSelection(item));
                    results.appendChild(btn);
                });

            const summary = document.createElement('p');
            summary.className = 'text-xs text-green-400 p-2 border-t border-gray-700 mt-2';
            summary.textContent = `✓ Found ${filtered.length} result${filtered.length > 1 ? 's' : ''}`;
            results.appendChild(summary);
        });

        function showEvent(text) {
            const notif = document.getElementById('event-notification');
            document.getElementById('event-text').textContent = text;
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', 3000);
        }

        function checkAchievement(type) {
            if (achievements.has(type)) return;
            achievements.add(type);
            const achievementNames = {
                first_click: 'First Contact - Clicked on a celestial body',
                explorer: 'Explorer - Visited a planet',
                moon_hunter: 'Moon Hunter - Visited a moon',
                tour_guide: 'Tour Guide - Started the grand tour',
                time_traveler: 'Time Traveler - Jumped through time',
                photographer: 'Photographer - Took a screenshot',
                speed_demon: 'Speed Demon - Reached 50x speed',
                astronomer: 'Astronomer - Visited all 8 planets',
                completionist: 'Completionist - Unlocked all features',
                master: 'Solar System Master - Spent 10 minutes exploring'
            };
            if (achievementNames[type]) {
                document.getElementById('achievement-text').textContent = achievementNames[type];
                document.getElementById('achievement-popup').style.display = 'block';
                setTimeout(() => document.getElementById('achievement-popup').style.display = 'none', 4000);
                document.getElementById('achievement-count').textContent = `${achievements.size}/10`;
                
                if (achievements.size >= 10) {
                    setTimeout(() => checkAchievement('completionist'), 500);
                }
            }
        }

        let animationSpeed = 1, time = 0, frameCount = 0, lastTime = performance.now();
        document.getElementById('speed-slider').addEventListener('input', e => { 
            animationSpeed = parseFloat(e.target.value); 
            document.getElementById('speed-display').textContent = `${animationSpeed.toFixed(1)}x`;
            if (Math.abs(animationSpeed) >= 50) checkAchievement('speed_demon');
        });

        function detectConjunctions() {
            const planets = ['mercury', 'venus', 'earth', 'mars', 'jupiter', 'saturn'];
            let nextConjunction = null;
            let minDiff = 360;
            
            for (let i = 0; i < planets.length - 1; i++) {
                for (let j = i + 1; j < planets.length; j++) {
                    const p1 = celestialBodies[planets[i]];
                    const p2 = celestialBodies[planets[j]];
                    if (!p1 || !p2) continue;
                    
                    const angle1 = Math.atan2(p1.mesh.position.z, p1.mesh.position.x);
                    const angle2 = Math.atan2(p2.mesh.position.z, p2.mesh.position.x);
                    let diff = Math.abs(angle1 - angle2) * 180 / Math.PI;
                    
                    if (diff > 180) diff = 360 - diff;
                    
                    if (diff < 5) {
                        showEvent(`🌟 Conjunction: ${p1.data.name} & ${p2.data.name}!`);
                        return;
                    }
                    
                    if (diff < minDiff) {
                        minDiff = diff;
                        nextConjunction = `${p1.data.name} & ${p2.data.name} (${minDiff.toFixed(1)}°)`;
                    }
                }
            }
            
            if (nextConjunction) {
                document.getElementById('conjunction-indicator').textContent = `Next: ${nextConjunction}`;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01; frameCount++;

            const now = performance.now();
            if (frameCount % 60 === 0) {
                const fps = Math.round(1000 / (now - lastTime) * 60);
                document.getElementById('fps-counter').textContent = fps;
                lastTime = now;
                
                // Check for master achievement
                if ((now - startTime) > 600000 && !achievements.has('master')) {
                    checkAchievement('master');
                }
            }

            if (frameCount % 30 === 0) {
                simulationDate.setHours(simulationDate.getHours() + Math.abs(animationSpeed) * 24);
                document.getElementById('current-date').textContent = simulationDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                document.getElementById('earth-time').textContent = `Earth Time: ${simulationDate.toLocaleTimeString('en-US', { hour12: false })}`;
                
                const yearsPassed = (simulationDate - startDate) / (1000 * 60 * 60 * 24 * 365);
                document.getElementById('elapsed-years').textContent = `Elapsed: ${yearsPassed.toFixed(2)} years`;
            }

            if (frameCount % 600 === 0) detectConjunctions();

            if (isTourActive && frameCount % 360 === 0) {
                const planets = Object.keys(planetData).filter(k => k !== 'sun');
                tourIndex = (tourIndex + 1) % planets.length;
                focusPlanet(planets[tourIndex]);
            }

            Object.keys(celestialBodies).forEach(key => {
                if (key === 'sun') { 
                    sun.rotation.y += sunRotationSpeed * animationSpeed; 
                    return; 
                }
                const body = celestialBodies[key];
                body.angle += body.data.speed * animationSpeed;
                body.mesh.position.x = Math.cos(body.angle) * body.data.distance;
                body.mesh.position.z = Math.sin(body.angle) * body.data.distance;
                body.mesh.rotation.y += body.data.rotationSpeed * animationSpeed;

            // Rotate clouds independently on Earth
            if (key === 'earth' && body.mesh.userData.clouds) {
                body.mesh.userData.clouds.rotation.y += 0.005 * animationSpeed;
            }

                if (showTrails && frameCount % 3 === 0) {
                    const trail = planetTrails[key];
                    trail.positions.push(body.mesh.position.clone());
                    if (trail.positions.length > trail.maxLength) trail.positions.shift();
                    const positions = new Float32Array(trail.positions.flatMap(p => [p.x, p.y, p.z]));
                    trail.line.geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                }

                if (moons[key]) {
                    moons[key].forEach(moon => {
                        moon.angle += moon.speed * animationSpeed;
                        moon.mesh.position.x = Math.cos(moon.angle) * moon.distance;
                        moon.mesh.position.z = Math.sin(moon.angle) * moon.distance;
                    });
                }
            });

            if (issGroup) {
                issAngle += 0.05 * animationSpeed;
                const d = 8.4;
                issGroup.position.set(Math.cos(issAngle) * d, Math.sin(issAngle * 1.3) * 1.5, Math.sin(issAngle) * d);
            }

            if (sunGlare && celestialBodies.sun) {
                sunGlare.position.copy(celestialBodies.sun.mesh.position);
                const dist = camera.position.distanceTo(sunGlare.position);
                const scale = Math.max(140, Math.min(320, dist * 0.4));
                sunGlare.scale.set(scale, scale, 1);
                sunGlare.material.rotation += 0.0015 * animationSpeed;
            }

            // Halley's Comet with elliptical orbit
            cometAngle += 0.006 * animationSpeed;
            const a = 230, b = 160; // semi-major and semi-minor axes
            cometGroup.position.set(Math.cos(cometAngle) * a, Math.sin(cometAngle * 3.5) * 60, Math.sin(cometAngle) * b);
            cometGroup.lookAt(0, 0, 0);

            // Space probes
            spaceProbes.forEach(probe => {
                if (probe.solar) {
                    // Parker Solar Probe - close solar approaches
                    probe.angle += probe.speed * animationSpeed;
                    const dist = probe.distance + Math.sin(probe.angle * 3) * 15;
                    probe.mesh.position.set(Math.cos(probe.angle) * dist, Math.sin(probe.angle * 2) * 5, Math.sin(probe.angle) * dist);
                } else if (probe.target === 'pluto') {
                    // New Horizons heading to Pluto
                    probe.angle += probe.speed * animationSpeed;
                    probe.distance = Math.min(310, probe.distance + 0.1);
                    probe.mesh.position.set(Math.cos(probe.angle) * probe.distance, 0, Math.sin(probe.angle) * probe.distance);
                } else {
                    // Voyager 1 - interstellar trajectory
                    probe.angle += probe.speed * animationSpeed;
                    probe.distance += 0.05;
                    probe.mesh.position.set(Math.cos(probe.angle) * probe.distance, probe.distance * 0.3, Math.sin(probe.angle) * probe.distance);
                }
            });

            asteroids.forEach(a => {
                a.angle += a.speed * animationSpeed;
                a.mesh.position.x = Math.cos(a.angle) * a.distance;
                a.mesh.position.z = Math.sin(a.angle) * a.distance;
                a.mesh.rotation.x += a.rotSpeed.x * animationSpeed;
                a.mesh.rotation.y += a.rotSpeed.y * animationSpeed;
            });

            let targetPos = targetOverride || { x: 0, y: 0, z: 0 };
            if (!targetOverride && targetPlanet && celestialBodies[targetPlanet]) targetPos = celestialBodies[targetPlanet].mesh.position;

            const camX = targetPos.x + Math.cos(cameraRotation.y) * Math.cos(cameraRotation.x) * cameraDistance;
            const camY = targetPos.y + Math.sin(cameraRotation.x) * cameraDistance;
            const camZ = targetPos.z + Math.sin(cameraRotation.y) * Math.cos(cameraRotation.x) * cameraDistance;

            camera.position.x += (camX - camera.position.x) * 0.08;
            camera.position.y += (camY - camera.position.y) * 0.08;
            camera.position.z += (camZ - camera.position.z) * 0.08;
            camera.lookAt(targetPos.x, targetPos.y, targetPos.z);

            if (targetPlanet && celestialBodies[targetPlanet]) {
                const d = celestialBodies[targetPlanet].data.distance;
                document.getElementById('distance-indicator').textContent = `Distance from Sun: ${(d * 1.5).toFixed(0)} million km`;
                document.getElementById('speed-indicator').textContent = `Orbital Speed: ${(celestialBodies[targetPlanet].data.speed * 1000).toFixed(2)} units/s`;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { 
            camera.aspect = window.innerWidth / window.innerHeight; 
            camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
        });

        setTimeout(() => { 
            const ls = document.getElementById('loading-screen'); 
            ls.style.opacity = '0'; 
            setTimeout(() => ls.style.display = 'none', 500); 
            checkAchievement('first_click');
        }, 2000);

        // Calculate total objects
        let totalObjects = Object.keys(celestialBodies).length + asteroidCount + 
                          Object.values(moons).reduce((s, a) => s + a.length, 0) + 
                          spaceProbes.length + 1; // +1 for comet
        document.getElementById('total-objects').textContent = totalObjects;

        function addTooltip(element, text) {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = text;
            document.body.appendChild(tooltip);
            
            element.addEventListener('mouseenter', (e) => {
                const rect = element.getBoundingClientRect();
                tooltip.classList.add('show');
                const tooltipRect = tooltip.getBoundingClientRect();
                
                let left = rect.left + (rect.width / 2);
                let top = rect.top - 35;
                let isBelow = false;
                
                if (left - (tooltipRect.width / 2) < 10) {
                    left = tooltipRect.width / 2 + 10;
                }
                
                if (left + (tooltipRect.width / 2) > window.innerWidth - 10) {
                    left = window.innerWidth - (tooltipRect.width / 2) - 10;
                }
                
                if (top < 10) {
                    top = rect.bottom + 10;
                    isBelow = true;
                    tooltip.classList.add('below');
                } else {
                    tooltip.classList.remove('below');
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                tooltip.style.transform = 'translateX(-50%)';
            });
            
            element.addEventListener('mouseleave', () => {
                tooltip.classList.remove('show');
            });
        }

        setTimeout(() => {
            Object.keys(planetData).forEach(key => {
                const btn = document.getElementById(`btn-${key}`);
                if (btn) addTooltip(btn, `Click to focus on ${planetData[key].name}. ${planetData[key].description}`);
            });

            const cameraButtons = document.querySelectorAll('.mb-4:nth-child(3) .toggle-btn');
            const cameraTooltips = [
                'Wide view of the entire solar system',
                'Bird\'s eye view from above',
                'Profile view from the side',
                'Automated tour of all celestial bodies',
                'Focus on inner solar system (Mercury to Mars)',
                'Focus on outer solar system (Jupiter to Neptune)'
            ];
            cameraButtons.forEach((btn, idx) => {
                if (cameraTooltips[idx]) addTooltip(btn, cameraTooltips[idx]);
            });

            addTooltip(document.getElementById('toggle-orbits'), 'Show/hide orbital paths around the Sun');
            addTooltip(document.getElementById('toggle-trails'), 'Show/hide planet movement trails');
            addTooltip(document.getElementById('toggle-labels'), 'Show/hide planet name labels');
            addTooltip(document.getElementById('toggle-moons'), 'Show/hide all 146+ moons orbiting planets');
            addTooltip(document.getElementById('toggle-asteroids'), 'Show/hide 3500+ asteroids in the belt');
            addTooltip(document.getElementById('toggle-dwarf'), 'Show/hide dwarf planets (Pluto, Ceres, Eris, Makemake, Haumea)');

            const advButtons = document.querySelectorAll('.mb-4:nth-child(5) .toggle-btn');
            const advTooltips = [
                'Highlight the green zone where liquid water can exist',
                'Show special gravitational equilibrium points (L1-L5)',
                'Display planets tilted at their actual angles',
                'Detect and highlight solar/lunar eclipse events'
            ];
            advButtons.forEach((btn, idx) => {
                if (advTooltips[idx]) addTooltip(btn, advTooltips[idx]);
            });

            const visualSection = Array.from(document.querySelectorAll('.control-panel .mb-4'))
                .find(section => section.querySelector('p')?.textContent?.includes('Visual Effects'));
            if (visualSection) {
                const visualButtons = visualSection.querySelectorAll('.toggle-btn');
                const visualTooltips = [
                    'Overlay aurora effects on magnetized planets',
                    'Render protective magnetic fields around planets that have them',
                    'Stream particles outward from the Sun to show solar wind activity'
                ];
                visualButtons.forEach((btn, idx) => {
                    if (visualTooltips[idx]) addTooltip(btn, visualTooltips[idx]);
                });
            }

            const utilButtonsContainer = document.querySelector('.control-panel > .space-y-2.text-xs');
            if (utilButtonsContainer) {
                const utilButtons = utilButtonsContainer.querySelectorAll('.toggle-btn');
                const utilTooltips = [
                    'Find any planet, moon, comet or mission by name',
                    'Side-by-side comparison of all planets',
                    'Calculate your weight, escape velocity and light travel time',
                    'Open the mission planner to estimate transfer burns',
                    'Browse a gallery of discovered exoplanets',
                    'Capture and download the current view as an image',
                    'Toggle all sound effects on or off'
                ];
                utilButtons.forEach((btn, idx) => {
                    if (utilTooltips[idx]) addTooltip(btn, utilTooltips[idx]);
                });
            }

            const timeButtons = document.querySelectorAll('.grid.grid-cols-3 .toggle-btn');
            const timeTooltips = ['-1 Year', '-1 Month', '-1 Day', '+1 Day', '+1 Month', '+1 Year'];
            timeButtons.forEach((btn, idx) => {
                if (timeTooltips[idx]) addTooltip(btn, `Jump time ${timeTooltips[idx]}`);
            });

            addTooltip(document.getElementById('speed-slider'), 'Control simulation speed from -50x (reverse) to +100x (fast forward)');
        }, 2500);

        // Mission Planning Functions
        let missionTrajectoryLine = null;

        function toggleMissionPlanner() {
            const panel = document.getElementById('mission-panel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            const btn = document.querySelector('button[onclick="toggleMissionPlanner()"]');
            if (btn) btn.classList.toggle('active', !isVisible);
        }

        function toggleExoplanets() {
            const panel = document.getElementById('exoplanet-panel');
            const hasPanel = !!panel;
            showExoplanets = hasPanel ? panel.style.display !== 'none' : showExoplanets;
            showExoplanets = !showExoplanets;

            if (hasPanel) panel.style.display = showExoplanets ? 'block' : 'none';
            const btn = document.querySelector('button[onclick="toggleExoplanets()"]');
            if (btn) btn.classList.toggle('active', showExoplanets);

            if (showExoplanets && !hasPanel) {
                showEvent('Exoplanet explorer coming soon.');
            }
        }

        function calculateMission() {
            const from = document.getElementById('mission-from').value;
            const to = document.getElementById('mission-to').value;
            const mass = parseFloat(document.getElementById('spacecraft-mass').value);
            
            if (!planetData[from] || !planetData[to]) return;
            
            const fromPlanet = planetData[from];
            const toPlanet = planetData[to];
            
            // Calculate Hohmann transfer orbit
            const r1 = fromPlanet.distance * 1.5e6; // Convert to km
            const r2 = toPlanet.distance * 1.5e6;
            
            // Semi-major axis of transfer orbit
            const a = (r1 + r2) / 2;
            
            // Vis-viva equation to calculate delta-v
            const mu = 1.327e11; // Solar gravitational parameter km³/s²
            const v1 = Math.sqrt(mu / r1); // Current velocity at departure
            const v2 = Math.sqrt(mu / r2); // Target velocity at arrival
            
            // Transfer orbit velocities
            const vt1 = Math.sqrt(mu * (2/r1 - 1/a)); // Velocity at departure on transfer
            const vt2 = Math.sqrt(mu * (2/r2 - 1/a)); // Velocity at arrival on transfer
            
            // Delta-v requirements
            const deltaV1 = Math.abs(vt1 - v1); // Departure burn
            const deltaV2 = Math.abs(v2 - vt2); // Arrival burn
            const totalDeltaV = deltaV1 + deltaV2;
            
            // Transfer time (half period of transfer ellipse)
            const transferTime = Math.PI * Math.sqrt(Math.pow(a, 3) / mu) / (24 * 3600); // Convert to days
            
            // Fuel consumption (using Tsiolkovsky rocket equation)
            const isp = 300; // Specific impulse in seconds
            const g0 = 9.81; // Standard gravity m/s²
            const deltaVTotal = totalDeltaV * 1000; // Convert to m/s
            const massRatio = Math.exp(deltaVTotal / (isp * g0));
            const fuelNeeded = mass * (massRatio - 1);
            
            // Check for gravity assists
            const useVenus = document.getElementById('assist-venus').checked;
            const useJupiter = document.getElementById('assist-jupiter').checked;
            let gravityAssistSavings = 0;
            let extraTime = 0;
            
            if (useVenus && to !== 'venus') {
                gravityAssistSavings += totalDeltaV * 0.15; // 15% savings
                extraTime += 150; // Add 150 days for Venus flyby
            }
            if (useJupiter && to !== 'jupiter') {
                gravityAssistSavings += totalDeltaV * 0.35; // 35% savings
                extraTime += 600; // Add 600 days for Jupiter flyby
            }
            
            const finalDeltaV = totalDeltaV - gravityAssistSavings;
            const finalTransferTime = transferTime + extraTime;
            const finalFuel = fuelNeeded * (1 - gravityAssistSavings / totalDeltaV);
            
            const resultsDiv = document.getElementById('mission-results');
            resultsDiv.innerHTML = `
                <p class=\"text-green-400 font-semibold\">✅ Mission Calculated!</p>
                <p class=\"text-white\"><strong>Route:</strong> ${fromPlanet.name} → ${toPlanet.name}</p>
                <p class=\"text-blue-400\"><strong>Total Δv:</strong> ${finalDeltaV.toFixed(2)} km/s</p>
                <p class=\"text-yellow-400\"><strong>Departure Δv:</strong> ${deltaV1.toFixed(2)} km/s</p>
                <p class=\"text-yellow-400\"><strong>Arrival Δv:</strong> ${deltaV2.toFixed(2)} km/s</p>
                <p class=\"text-purple-400\"><strong>Transfer Time:</strong> ${Math.round(finalTransferTime)} days (${(finalTransferTime/365).toFixed(1)} years)</p>
                <p class=\"text-pink-300\"><strong>Fuel Required:</strong> ${Math.round(finalFuel)} kg</p>
                <p class=\"text-orange-300\"><strong>Total Mass:</strong> ${Math.round(mass + finalFuel)} kg</p>
                ${gravityAssistSavings > 0 ? `<p class=\"text-green-300\"><strong>⚡ Gravity Assist Savings:</strong> ${gravityAssistSavings.toFixed(2)} km/s</p>` : ''}
            `;
            
            showEvent(`Mission to ${toPlanet.name} planned! ${Math.round(finalTransferTime)} days`);
            checkAchievement('mission_planner');
        }

        function visualizeMission() {
            const from = document.getElementById('mission-from').value;
            const to = document.getElementById('mission-to').value;
            
            if (!celestialBodies[from] || !celestialBodies[to]) return;
            
            // Remove old trajectory if exists
            if (missionTrajectoryLine) {
                scene.remove(missionTrajectoryLine);
            }
            
            const fromPos = celestialBodies[from].mesh.position;
            const toPos = celestialBodies[to].mesh.position;
            
            // Create elliptical transfer orbit (Hohmann transfer)
            const points = [];
            const fromDist = planetData[from].distance;
            const toDist = planetData[to].distance;
            const a = (fromDist + toDist) / 2; // Semi-major axis
            const c = (toDist - fromDist) / 2; // Distance from center to focus
            const b = Math.sqrt(a * a - c * c); // Semi-minor axis
            
            for (let i = 0; i <= 100; i++) {
                const theta = (i / 100) * Math.PI; // Half ellipse
                const r = (a * (1 - (c/a) * (c/a))) / (1 + (c/a) * Math.cos(theta));
                const x = (r * Math.cos(theta)) + (fromDist - c);
                const z = r * Math.sin(theta);
                points.push(new THREE.Vector3(x, 0, z));
            }
            
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ 
                color: 0xff6b6b, 
                linewidth: 3,
                opacity: 0.8,
                transparent: true
            });
            
            missionTrajectoryLine = new THREE.Line(geometry, material);
            scene.add(missionTrajectoryLine);
            
            showEvent(`Trajectory visualized! Pink line shows path.`);
            
            // Focus camera on the trajectory
            targetPlanet = null;
            cameraDistance = Math.max(fromDist, toDist) * 2.5;
        }

        animate();
    </script>
</body>
</html>


