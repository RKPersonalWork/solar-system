<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ultimate Solar System Explorer - Supreme Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Space Mono', monospace; touch-action: none; }
        
        /* Custom Scrollbar Styling */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: linear-gradient(180deg, rgba(10, 10, 30, 0.8) 0%, rgba(20, 20, 50, 0.8) 100%); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(59, 130, 246, 0.8) 0%, rgba(139, 92, 246, 0.8) 100%); border-radius: 10px; border: 2px solid rgba(10, 10, 30, 0.5); }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, rgba(59, 130, 246, 1) 0%, rgba(139, 92, 246, 1) 100%); box-shadow: 0 0 10px rgba(59, 130, 246, 0.8); }
        ::-webkit-scrollbar-corner { background: rgba(10, 10, 30, 0.8); }
        
        /* Firefox Scrollbar */
        * { scrollbar-width: thin; scrollbar-color: rgba(59, 130, 246, 0.8) rgba(10, 10, 30, 0.8); }
        
        #info-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 20, 40, 0.9) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6); max-height: 90vh; overflow-y: auto; }
        .planet-button { transition: all 0.3s ease; border-left: 3px solid transparent; }
        .planet-button:hover { transform: scale(1.05) translateX(5px); background: rgba(59, 130, 246, 0.3); border-left-color: #60a5fa; }
        .planet-button.active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.6) 0%, rgba(59, 130, 246, 0.2) 100%); border-left: 4px solid #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
        .title { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 15px rgba(59, 130, 246, 0.7); }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #000000 0%, #1a1a2e 50%, #0f3460 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.5s ease; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid rgba(59, 130, 246, 0.2); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .control-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 20, 40, 0.9) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(100, 150, 255, 0.4); }
        .toggle-btn { padding: 8px 16px; border-radius: 6px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); transition: all 0.3s ease; cursor: pointer; }
        .toggle-btn:hover { background: rgba(59, 130, 246, 0.4); transform: scale(1.05); }
        .toggle-btn.active { background: rgba(59, 130, 246, 0.7); border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .fun-fact { background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2)); border-left: 3px solid #8b5cf6; padding: 12px; margin: 8px 0; border-radius: 4px; }
        .event-notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(59, 130, 246, 0.95)); padding: 20px 40px; border-radius: 10px; box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); z-index: 100; display: none; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); } 50% { box-shadow: 0 0 60px rgba(139, 92, 246, 1); } }
        .mini-map { background: rgba(0, 0, 0, 0.8); border: 1px solid rgba(100, 150, 255, 0.4); border-radius: 8px; }
        .calculator-panel { background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(30, 20, 50, 0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(150, 100, 255, 0.5); }
        @media (max-width: 768px) { #info-panel { max-width: 90vw; font-size: 0.875rem; } .control-panel { font-size: 0.75rem; } }
    </style>
</head>
<body class="bg-black">
    <div id="loading-screen">
        <div class="loading-spinner mb-4"></div>
        <h2 class="text-white text-2xl font-bold title">Loading Ultimate Solar System...</h2>
        <p class="text-blue-300 text-sm mt-2">Initializing Universe...</p>
    </div>

    <div id="event-notification" class="event-notification">
        <h3 class="text-white text-xl font-bold title mb-2">üåü Event Alert!</h3>
        <p class="text-white" id="event-text"></p>
    </div>

    <div id="info-panel" class="absolute top-4 left-4 text-white p-6 rounded-lg max-w-sm z-10">
        <h1 class="text-2xl font-bold mb-2 title">üåå Solar System Supreme</h1>
        <p class="text-sm text-gray-300 mb-4">üöÄ Click | üéÆ Drag | üîç Scroll | ‚è±Ô∏è Time Travel</p>
        
        <div class="mb-4 p-3 bg-gradient-to-r from-blue-900 to-purple-900 bg-opacity-40 rounded">
            <p class="text-xs text-gray-400">Simulation Date & Time</p>
            <p class="text-lg font-semibold" id="current-date">Jan 1, 2024</p>
            <p class="text-xs text-blue-300 mt-1" id="earth-time">Earth Time: 00:00:00</p>
        </div>

        <div id="planet-info" class="mb-4">
            <h2 class="text-xl font-semibold mb-2" id="planet-name">The Sun</h2>
            <p class="text-sm" id="planet-description">The star at the center of our solar system.</p>
            <div class="mt-2 text-xs space-y-1" id="planet-stats"></div>
            <div id="fun-fact" class="fun-fact mt-3 hidden">
                <p class="text-xs font-semibold text-purple-300">üí° Fun Fact</p>
                <p class="text-xs mt-1" id="fact-text"></p>
            </div>
            <div id="mythology" class="fun-fact mt-3 hidden" style="border-left-color: #f59e0b;">
                <p class="text-xs font-semibold text-yellow-300">üìú Mythology</p>
                <p class="text-xs mt-1" id="mythology-text"></p>
            </div>
            <div id="science-info" class="fun-fact mt-3 hidden" style="border-left-color: #10b981;">
                <p class="text-xs font-semibold text-green-300">üî¨ Scientific Info</p>
                <p class="text-xs mt-1" id="science-text"></p>
            </div>
        </div>
        
        <div class="space-y-2">
            <h3 class="text-sm font-semibold text-gray-400">Celestial Bodies:</h3>
            <div id="planet-buttons" class="space-y-1"></div>
        </div>

        <div id="moon-buttons-container" class="mt-4 space-y-2" style="display:none;">
            <h3 class="text-sm font-semibold text-gray-400">Moons of <span id="moon-parent-name"></span>:</h3>
            <div id="moon-buttons" class="space-y-1 pl-2"></div>
        </div>

        <div class="mt-4 p-3 bg-gray-900 bg-opacity-50 rounded text-xs">
            <p class="font-semibold mb-1">Quick Stats:</p>
            <p>üìä Total Objects: <span id="total-objects">-</span></p>
            <p>üåç Planets: 8 | üåô Moons: 16</p>
            <p>‚òÑÔ∏è Asteroids: 3500 | ü™ê Dwarf: 2</p>
            <p>üéØ FPS: <span id="fps-counter">60</span></p>
        </div>
    </div>

    <div class="absolute top-4 right-4 text-white control-panel p-4 rounded-lg z-10 max-w-xs">
        <div class="mb-4">
            <label class="text-sm font-semibold block mb-2">‚ö° Speed: <span id="speed-display">1.0x</span></label>
            <input type="range" id="speed-slider" min="-10" max="20" step="0.5" value="1" class="w-full">
            <div class="flex justify-between text-xs mt-1">
                <span>‚è™ -10x</span>
                <span>‚è© 20x</span>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">üì∑ Camera Views</p>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setCameraPreset('overview')" class="toggle-btn text-xs">üåå Overview</button>
                <button onclick="setCameraPreset('top')" class="toggle-btn text-xs">‚¨ÜÔ∏è Top</button>
                <button onclick="setCameraPreset('side')" class="toggle-btn text-xs">‚û°Ô∏è Side</button>
                <button onclick="startTour()" class="toggle-btn text-xs">üöÄ Tour</button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">üé® Display Options</p>
            <div class="grid grid-cols-2 gap-2 text-xs">
                <button id="toggle-orbits" onclick="toggleOrbits()" class="toggle-btn active">Orbits</button>
                <button id="toggle-trails" onclick="toggleTrails()" class="toggle-btn active">Trails</button>
                <button id="toggle-labels" onclick="toggleLabels()" class="toggle-btn active">Labels</button>
                <button id="toggle-moons" onclick="toggleMoons()" class="toggle-btn active">Moons</button>
                <button id="toggle-asteroids" onclick="toggleAsteroids()" class="toggle-btn active">Asteroids</button>
                <button id="toggle-dwarf" onclick="toggleDwarfPlanets()" class="toggle-btn active">Dwarf</button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">üî¨ Advanced</p>
            <div class="space-y-2 text-xs">
                <button onclick="toggleHabitableZone()" class="toggle-btn w-full">üü¢ Habitable Zone</button>
                <button onclick="toggleLagrangePoints()" class="toggle-btn w-full">‚≠ï Lagrange Points</button>
                <button onclick="toggleDayNight()" class="toggle-btn w-full">üåì Day/Night</button>
                <button onclick="toggleAxialTilt()" class="toggle-btn w-full">üåç Axial Tilt</button>
            </div>
        </div>

        <div class="space-y-2 text-xs">
            <button onclick="takeScreenshot()" class="toggle-btn w-full">üì∏ Screenshot</button>
            <button onclick="toggleMiniMap()" class="toggle-btn w-full">üó∫Ô∏è Mini Map</button>
            <button onclick="toggleCalculator()" class="toggle-btn w-full">üßÆ Calculator</button>
            <button onclick="playSound()" class="toggle-btn w-full" id="sound-btn">üîá Sound OFF</button>
        </div>
    </div>

    <div id="calculator-panel" class="absolute bottom-4 right-4 calculator-panel p-4 rounded-lg z-10 max-w-xs" style="display:none;">
        <h3 class="text-lg font-bold mb-3 title">üßÆ Science Calculator</h3>
        <div class="space-y-3 text-xs">
            <div class="p-3 bg-black bg-opacity-40 rounded">
                <p class="font-semibold mb-1">‚öñÔ∏è Your Weight on <span id="calc-planet">Earth</span>:</p>
                <input type="number" id="earth-weight" placeholder="Enter weight (kg)" class="w-full p-2 rounded bg-gray-800 text-white">
                <p class="mt-2 text-green-300" id="weight-result">Weight: - kg</p>
            </div>
            <div class="p-3 bg-black bg-opacity-40 rounded">
                <p class="font-semibold mb-1">üí® Escape Velocity:</p>
                <p class="text-yellow-300" id="escape-velocity">- km/s</p>
            </div>
            <div class="p-3 bg-black bg-opacity-40 rounded">
                <p class="font-semibold mb-1">üí° Light Travel Time:</p>
                <p class="text-blue-300" id="light-time">- minutes</p>
            </div>
        </div>
    </div>

    <div id="mini-map" class="absolute bottom-4 right-4 mini-map p-3 z-10" style="display:none;">
        <canvas id="mini-map-canvas" width="200" height="200"></canvas>
    </div>

    <div class="absolute bottom-4 left-4 text-white text-xs bg-black bg-opacity-80 p-4 rounded-lg backdrop-blur-sm">
        <p class="font-semibold mb-1">üéÆ Controls:</p>
        <p>üñ±Ô∏è Left Drag: Rotate | ‚öôÔ∏è Scroll: Zoom</p>
        <p>üì± Touch: Pan & Pinch | üñ±Ô∏è Click: Select</p>
        <p id="distance-indicator" class="mt-2 text-blue-300">Distance: -</p>
        <p id="speed-indicator" class="text-green-300">Orbital Speed: -</p>
        <p id="axial-tilt-indicator" class="text-purple-300">Axial Tilt: -</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.00015);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 15000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        let showOrbits = true, showTrails = true, showLabels = true, showMoons = true, showAsteroids = true;
        let showDwarfPlanets = true, showHabitableZone = false, showLagrangePoints = false, showMiniMap = false;
        let soundEnabled = false, isTourActive = false, tourIndex = 0, showDayNight = false, showAxialTilt = false;
        let simulationDate = new Date(2024, 0, 1, 0, 0, 0);

        const ambientLight = new THREE.AmbientLight(0x222222, 0.5);
        scene.add(ambientLight);
        const sunLight = new THREE.PointLight(0xffffff, 2.5, 5000);
        sunLight.castShadow = true;
        scene.add(sunLight);

        const starGeometry = new THREE.BufferGeometry();
        const starVertices = [], starColors = [];
        for (let i = 0; i < 20000; i++) {
            starVertices.push((Math.random() - 0.5) * 8000, (Math.random() - 0.5) * 8000, (Math.random() - 0.5) * 8000);
            const c = Math.random();
            starColors.push(c > 0.9 ? 0.5 : 1, c > 0.9 ? 0.7 : c > 0.7 ? 0.8 : c > 0.5 ? 0.6 : 1, c > 0.9 ? 1 : c > 0.7 ? 0.6 : c > 0.5 ? 0.4 : 1);
        }
        starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
        starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));
        scene.add(new THREE.Points(starGeometry, new THREE.PointsMaterial({ size: 3, vertexColors: true, transparent: true, opacity: 0.8 })));

        const planetData = {
            sun: { name: 'The Sun', radius: 20, color: 0xfdb813, distance: 0, speed: 0, tilt: 0, rotationSpeed: 0.001,
                description: 'The star at the center of our solar system.', stats: { diameter: '1,392,700 km', mass: '1.989 √ó 10¬≥‚Å∞ kg', temperature: '5,778 K' },
                funFact: 'The Sun converts 600 million tons of hydrogen into helium every second!', mythology: 'Helios drove a chariot across the sky.', 
                escapeVelocity: 617.5, gravity: 274 },
            mercury: { name: 'Mercury', radius: 2.4, color: 0x8c7853, distance: 40, speed: 0.04, tilt: 0.034, rotationSpeed: 0.001,
                description: 'Smallest planet with extreme temperatures.', stats: { diameter: '4,879 km', 'orbital period': '88 days', moons: '0' },
                funFact: 'Mercury\'s day is longer than its year!', mythology: 'Named after the Roman messenger god.', escapeVelocity: 4.3, gravity: 3.7 },
            venus: { name: 'Venus', radius: 6, color: 0xffc649, distance: 60, speed: 0.015, tilt: 177.4, rotationSpeed: -0.0004,
                description: 'Earth\'s sister planet with toxic atmosphere.', stats: { diameter: '12,104 km', moons: '0' },
                funFact: 'Venus rotates backwards!', mythology: 'Roman goddess of love and beauty.', escapeVelocity: 10.4, gravity: 8.9, hasMoons: false },
            earth: { name: 'Earth', radius: 6.4, color: 0x4a90e2, distance: 80, speed: 0.01, tilt: 23.5, rotationSpeed: 0.01,
                description: 'Our home planet.', stats: { diameter: '12,742 km', population: '8 billion+', moons: '1 (Moon)' },
                funFact: '71% covered in water!', mythology: 'Gaia, Greek goddess of Earth.', escapeVelocity: 11.2, gravity: 9.8, hasMoons: true, hasStation: true },
            mars: { name: 'Mars', radius: 3.4, color: 0xdc4b3e, distance: 100, speed: 0.008, tilt: 25.2, rotationSpeed: 0.01,
                description: 'The Red Planet.', stats: { diameter: '6,779 km', moons: '2 (Phobos, Deimos)' },
                funFact: 'Olympus Mons is 21 km high!', mythology: 'Roman god of war.', escapeVelocity: 5.0, gravity: 3.7, hasMoons: true },
            jupiter: { name: 'Jupiter', radius: 11, color: 0xd4a574, distance: 140, speed: 0.002, tilt: 3.1, rotationSpeed: 0.04,
                description: 'Largest planet with Great Red Spot.', stats: { diameter: '139,820 km', moons: '95+ (Io, Europa, Ganymede, Callisto + 91 more)' },
                funFact: 'Great Red Spot has raged for 400+ years!', mythology: 'King of Roman gods.', escapeVelocity: 59.5, gravity: 24.8, hasMoons: true },
            saturn: { name: 'Saturn', radius: 9.5, color: 0xe5c287, distance: 180, speed: 0.0009, tilt: 26.7, rotationSpeed: 0.038,
                description: 'Famous for its ring system.', stats: { diameter: '116,460 km', moons: '146+ (Titan, Rhea, Enceladus + 143 more)' },
                funFact: 'Saturn would float in water!', mythology: 'Roman god of agriculture.', escapeVelocity: 35.5, gravity: 10.4, hasMoons: true },
            uranus: { name: 'Uranus', radius: 4, color: 0x4fd0e7, distance: 220, speed: 0.0004, tilt: 97.8, rotationSpeed: -0.02,
                description: 'Ice giant rotating on its side.', stats: { diameter: '50,724 km', tilt: '97.8¬∞', moons: '27 (Titania, Oberon + 25 more)' },
                funFact: 'Uranus rotates nearly on its side!', mythology: 'Greek god of the sky.', escapeVelocity: 21.3, gravity: 8.9, hasMoons: true },
            neptune: { name: 'Neptune', radius: 3.9, color: 0x4166f5, distance: 260, speed: 0.0001, tilt: 28.3, rotationSpeed: 0.025,
                description: 'Furthest planet with supersonic winds.', stats: { diameter: '49,244 km', 'wind speed': '2,100 km/h', moons: '14 (Triton + 13 more)' },
                funFact: 'Fastest winds in the solar system!', mythology: 'Roman god of the sea.', escapeVelocity: 23.5, gravity: 11.2, hasMoons: true },
            pluto: { name: 'Pluto', radius: 1.2, color: 0xc9a687, distance: 310, speed: 0.00004, tilt: 122.5, rotationSpeed: -0.003,
                description: 'Dwarf planet with heart-shaped glacier.', stats: { diameter: '2,377 km', type: 'Dwarf Planet', moons: '5 (Charon + 4 more)' },
                funFact: 'Charon is so big they orbit each other!', mythology: 'Roman god of the underworld.', escapeVelocity: 1.2, gravity: 0.6, hasMoons: true, isDwarf: true },
            ceres: { name: 'Ceres', radius: 0.6, color: 0x8b8680, distance: 125, speed: 0.0035, tilt: 4, rotationSpeed: 0.02,
                description: 'Largest asteroid belt object.', stats: { diameter: '940 km', location: 'Asteroid Belt', moons: '0' },
                funFact: 'Contains 1/3 of asteroid belt mass!', mythology: 'Roman goddess of agriculture.', escapeVelocity: 0.5, gravity: 0.3, isDwarf: true }
        };

        const moonData = {
            earth: [{ name: 'Moon', distance: 10, radius: 1.7, speed: 0.08, color: 0xcccccc }],
            mars: [{ name: 'Phobos', distance: 6, radius: 0.5, speed: 0.15, color: 0x999999 }, { name: 'Deimos', distance: 8, radius: 0.4, speed: 0.1, color: 0xaaaaaa }],
            jupiter: [{ name: 'Io', distance: 18, radius: 1.8, speed: 0.1, color: 0xffcc00 }, { name: 'Europa', distance: 24, radius: 1.6, speed: 0.08, color: 0xddddff }, 
                      { name: 'Ganymede', distance: 30, radius: 2.6, speed: 0.06, color: 0x998877 }, { name: 'Callisto', distance: 36, radius: 2.4, speed: 0.04, color: 0x776655 }],
            saturn: [{ name: 'Titan', distance: 26, radius: 2.6, speed: 0.05, color: 0xffaa66 }, { name: 'Rhea', distance: 20, radius: 0.8, speed: 0.07, color: 0xcccccc },
                     { name: 'Enceladus', distance: 16, radius: 0.6, speed: 0.09, color: 0xffffff }],
            uranus: [{ name: 'Titania', distance: 12, radius: 0.8, speed: 0.09, color: 0xaaccdd }, { name: 'Oberon', distance: 15, radius: 0.7, speed: 0.07, color: 0x99bbcc }],
            neptune: [{ name: 'Triton', distance: 14, radius: 1.4, speed: 0.07, color: 0xbbccff }],
            pluto: [{ name: 'Charon', distance: 8, radius: 0.6, speed: 0.1, color: 0xaaaaaa }]
        };

        const celestialBodies = {}, orbits = {}, planetTrails = {}, labels = {}, moons = {};
        let issGroup = null, cometAngle = 0, issAngle = 0;

        function createPlanetTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            if (type === 'sun') {
                const grad = ctx.createRadialGradient(512, 256, 0, 512, 256, 512);
                grad.addColorStop(0, '#FFF8E7'); grad.addColorStop(0.3, '#FFD700'); grad.addColorStop(0.6, '#FFA500'); grad.addColorStop(1, '#FF4500');
                ctx.fillStyle = grad; ctx.fillRect(0, 0, 1024, 512);
                for (let i = 0; i < 300; i++) {
                    ctx.fillStyle = `rgba(255, ${200 + Math.random() * 55}, 0, ${Math.random() * 0.4})`;
                    ctx.beginPath(); ctx.arc(Math.random() * 1024, Math.random() * 512, Math.random() * 40, 0, Math.PI * 2); ctx.fill();
                }
            } else if (type === 'earth') {
                ctx.fillStyle = '#1a4f8f'; ctx.fillRect(0, 0, 1024, 512);
                ctx.fillStyle = '#2a9d4e';
                for (let i = 0; i < 20; i++) {
                    ctx.beginPath();
                    const sx = Math.random() * 1024, sy = Math.random() * 512;
                    ctx.moveTo(sx, sy);
                    for (let j = 0; j < 12; j++) ctx.lineTo(sx + (Math.random() - 0.5) * 250, sy + (Math.random() - 0.5) * 250);
                    ctx.closePath(); ctx.fill();
                }
            } else {
                const colors = { mercury: '#8C7853', venus: '#ffc649', mars: '#cd5c5c', jupiter: '#d4a574', saturn: '#e5c287', uranus: '#4fd0e7', neptune: '#4166f5', pluto: '#c9a687', ceres: '#8b8680' };
                ctx.fillStyle = colors[type] || '#888'; ctx.fillRect(0, 0, 1024, 512);
            }
            return new THREE.CanvasTexture(canvas);
        }

        const sunGeo = new THREE.SphereGeometry(planetData.sun.radius, 64, 64);
        const sun = new THREE.Mesh(sunGeo, new THREE.MeshBasicMaterial({ map: createPlanetTexture('sun'), color: 0xfdb813 }));
        scene.add(sun);
        celestialBodies.sun = { mesh: sun, data: planetData.sun, angle: 0 };

        for (let i = 0; i < 3; i++) {
            const glow = new THREE.Mesh(new THREE.SphereGeometry(planetData.sun.radius * (1.1 + i * 0.1), 32, 32),
                new THREE.MeshBasicMaterial({ color: 0xfdb813, transparent: true, opacity: 0.1 / (i + 1), side: THREE.BackSide }));
            sun.add(glow);
        }

        const asteroidBelt = new THREE.Group();
        scene.add(asteroidBelt);
        const asteroids = [], asteroidCount = 3500;
        for (let i = 0; i < asteroidCount; i++) {
            const geo = new THREE.DodecahedronGeometry(0.3 + Math.random() * 0.5, 0);
            const asteroid = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: [0x8B7355, 0x6B5D52, 0x7A6A5A][Math.floor(Math.random() * 3)], roughness: 0.95 }));
            const angle = Math.random() * Math.PI * 2, distance = 115 + Math.random() * 20;
            asteroid.position.set(Math.cos(angle) * distance, (Math.random() - 0.5) * 10, Math.sin(angle) * distance);
            asteroidBelt.add(asteroid);
            asteroids.push({ mesh: asteroid, angle, distance, speed: 0.003 + Math.random() * 0.002, rotSpeed: { x: (Math.random() - 0.5) * 0.02, y: (Math.random() - 0.5) * 0.02 } });
        }

        const cometGroup = new THREE.Group();
        cometGroup.add(new THREE.Mesh(new THREE.SphereGeometry(1.8, 16, 16), new THREE.MeshStandardMaterial({ color: 0x88CCFF, emissive: 0x4488FF, emissiveIntensity: 0.6 })));
        const tail = new THREE.Mesh(new THREE.ConeGeometry(4, 50, 8), new THREE.MeshBasicMaterial({ color: 0x88CCFF, transparent: true, opacity: 0.5 }));
        tail.rotation.x = Math.PI / 2; tail.position.z = -25;
        cometGroup.add(tail);
        scene.add(cometGroup);

        let habitableZoneInner, habitableZoneOuter, lagrangePoints = [];
        habitableZoneInner = new THREE.Mesh(new THREE.RingGeometry(75, 76, 128), new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide, transparent: true, opacity: 0.3 }));
        habitableZoneOuter = new THREE.Mesh(new THREE.RingGeometry(150, 151, 128), new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide, transparent: true, opacity: 0.3 }));
        habitableZoneInner.rotation.x = habitableZoneOuter.rotation.x = Math.PI / 2;
        habitableZoneInner.visible = habitableZoneOuter.visible = false;
        scene.add(habitableZoneInner, habitableZoneOuter);

        [{ x: 79.2, z: 0 }, { x: 80.8, z: 0 }, { x: -80, z: 0 }, { x: 40, z: 69.3 }, { x: 40, z: -69.3 }].forEach(pos => {
            const point = new THREE.Mesh(new THREE.SphereGeometry(1.5, 16, 16), new THREE.MeshBasicMaterial({ color: 0xff00ff, transparent: true, opacity: 0.7 }));
            point.position.set(pos.x, 0, pos.z); point.visible = false;
            scene.add(point); lagrangePoints.push(point);
        });

        Object.keys(planetData).forEach(key => {
            if (key === 'sun') return;
            const data = planetData[key];

            const orbitGeo = new THREE.BufferGeometry();
            const orbitPts = [];
            for (let i = 0; i <= 128; i++) {
                const angle = (i / 128) * Math.PI * 2;
                orbitPts.push(Math.cos(angle) * data.distance, 0, Math.sin(angle) * data.distance);
            }
            orbitGeo.setAttribute('position', new THREE.Float32BufferAttribute(orbitPts, 3));
            const orbit = new THREE.Line(orbitGeo, new THREE.LineBasicMaterial({ color: data.isDwarf ? 0x888888 : 0x4488ff, opacity: data.isDwarf ? 0.2 : 0.35, transparent: true }));
            scene.add(orbit);
            orbits[key] = orbit;

            const trailGeo = new THREE.BufferGeometry();
            trailGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(300), 3));
            const trail = new THREE.Line(trailGeo, new THREE.LineBasicMaterial({ color: data.color, opacity: 0.5, transparent: true }));
            scene.add(trail);
            planetTrails[key] = { line: trail, positions: [], maxLength: 100 };

            const planet = new THREE.Mesh(new THREE.SphereGeometry(data.radius, 64, 64), 
                new THREE.MeshStandardMaterial({ map: createPlanetTexture(key), roughness: key.includes('jupiter') || key.includes('saturn') || key.includes('uranus') || key.includes('neptune') ? 0.3 : 0.85 }));
            planet.position.x = data.distance;
            if (showAxialTilt) planet.rotation.z = (data.tilt || 0) * Math.PI / 180;
            scene.add(planet);
            celestialBodies[key] = { mesh: planet, data: data, angle: Math.random() * Math.PI * 2 };

            const labelCanvas = document.createElement('canvas');
            labelCanvas.width = 256; labelCanvas.height = 64;
            const lctx = labelCanvas.getContext('2d');
            lctx.fillStyle = 'rgba(0,0,0,0.7)'; lctx.fillRect(0, 0, 256, 64);
            lctx.fillStyle = 'white'; lctx.font = 'bold 30px Arial'; lctx.textAlign = 'center';
            lctx.fillText(data.name, 128, 42);
            const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(labelCanvas), transparent: true }));
            label.scale.set(data.radius * 3.5, data.radius * 0.875, 1);
            label.position.set(0, data.radius + 4, 0);
            planet.add(label);
            labels[key] = label;

            if (key === 'earth') {
                const atm = new THREE.Mesh(new THREE.SphereGeometry(data.radius * 1.06, 64, 64), new THREE.MeshPhongMaterial({ color: '#87CEEB', transparent: true, opacity: 0.18, side: THREE.BackSide }));
                planet.add(atm);

                issGroup = new THREE.Group();
                issGroup.add(new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.3, 0.5), new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8 })));
                const sp = new THREE.Mesh(new THREE.BoxGeometry(2, 0.05, 0.6), new THREE.MeshStandardMaterial({ color: 0x1a3a5a }));
                sp.position.set(1.2, 0, 0); issGroup.add(sp);
                const sp2 = sp.clone(); sp2.position.set(-1.2, 0, 0); issGroup.add(sp2);
                issGroup.scale.set(0.3, 0.3, 0.3);
                planet.add(issGroup);
            }

            if (key === 'saturn') {
                const ringGeo = new THREE.RingGeometry(data.radius * 1.5, data.radius * 2.6, 128);
                const rings = new THREE.Mesh(ringGeo, new THREE.MeshStandardMaterial({ color: 0xe5c287, side: THREE.DoubleSide, transparent: true, opacity: 0.95 }));
                rings.rotation.x = Math.PI / 2;
                planet.add(rings);
            }

            if (data.hasMoons && moonData[key]) {
                moons[key] = [];
                moonData[key].forEach(moonInfo => {
                    const moonMesh = new THREE.Mesh(new THREE.SphereGeometry(moonInfo.radius, 32, 32), new THREE.MeshStandardMaterial({ color: moonInfo.color, roughness: 0.95 }));
                    planet.add(moonMesh);
                    moons[key].push({ mesh: moonMesh, angle: Math.random() * Math.PI * 2, distance: moonInfo.distance, speed: moonInfo.speed, name: moonInfo.name });
                });
            }
        });

        camera.position.set(150, 150, 250);
        camera.lookAt(0, 0, 0);

        let isDragging = false, previousMouse = { x: 0, y: 0 }, cameraRotation = { x: 0.5, y: 0.5 }, cameraDistance = 350, targetPlanet = null;

        renderer.domElement.addEventListener('mousedown', e => { isDragging = true; previousMouse = { x: e.clientX, y: e.clientY }; });
        renderer.domElement.addEventListener('mousemove', e => {
            if (!isDragging) return;
            cameraRotation.y += (e.clientX - previousMouse.x) * 0.005;
            cameraRotation.x += (e.clientY - previousMouse.y) * 0.005;
            cameraRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraRotation.x));
            previousMouse = { x: e.clientX, y: e.clientY };
        });
        renderer.domElement.addEventListener('mouseup', () => isDragging = false);
        renderer.domElement.addEventListener('wheel', e => {
            e.preventDefault();
            cameraDistance += e.deltaY * 0.15;
            cameraDistance = Math.max(50, Math.min(1000, cameraDistance));
        });

        renderer.domElement.addEventListener('click', e => {
            if (isDragging) return;
            const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const meshes = Object.keys(celestialBodies).map(k => celestialBodies[k].mesh);
            const intersects = raycaster.intersectObjects(meshes);
            if (intersects.length > 0) {
                const planetKey = Object.keys(celestialBodies).find(k => celestialBodies[k].mesh === intersects[0].object);
                if (planetKey) focusPlanet(planetKey);
            }
        });

        function focusPlanet(key) {
            targetPlanet = key;
            const data = celestialBodies[key].data;
            document.getElementById('planet-name').textContent = data.name;
            document.getElementById('planet-description').textContent = data.description;
            const statsDiv = document.getElementById('planet-stats');
            statsDiv.innerHTML = '';
            Object.keys(data.stats).forEach(k => {
                const p = document.createElement('p');
                p.className = 'text-gray-400';
                p.innerHTML = `<strong>${k}:</strong> ${data.stats[k]}`;
                statsDiv.appendChild(p);
            });
            document.getElementById('fun-fact').classList.toggle('hidden', !data.funFact);
            if (data.funFact) document.getElementById('fact-text').textContent = data.funFact;
            document.getElementById('mythology').classList.toggle('hidden', !data.mythology);
            if (data.mythology) document.getElementById('mythology-text').textContent = data.mythology;
            
            document.getElementById('science-info').classList.remove('hidden');
            document.getElementById('science-text').textContent = `Gravity: ${data.gravity} m/s¬≤ | Escape Velocity: ${data.escapeVelocity} km/s | Rotation: ${(data.rotationSpeed * 1000).toFixed(2)}`;
            
            document.getElementById('calc-planet').textContent = data.name;
            document.getElementById('escape-velocity').textContent = `${data.escapeVelocity} km/s`;
            document.getElementById('light-time').textContent = `${((data.distance * 1.5) / 18).toFixed(2)} minutes`;
            document.getElementById('axial-tilt-indicator').textContent = `Axial Tilt: ${(data.tilt || 0).toFixed(1)}¬∞`;
            
            document.querySelectorAll('.planet-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${key}`).classList.add('active');
            
            // Show moon buttons if this planet has moons
            const moonContainer = document.getElementById('moon-buttons-container');
            const moonButtonsDiv = document.getElementById('moon-buttons');
            moonButtonsDiv.innerHTML = '';
            
            if (moons[key] && moons[key].length > 0) {
                moonContainer.style.display = 'block';
                document.getElementById('moon-parent-name').textContent = data.name;
                
                moons[key].forEach((moon, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'planet-button w-full text-left px-3 py-2 rounded text-xs text-white';
                    btn.style.paddingLeft = '1.5rem';
                    btn.innerHTML = `‚Ü≥ üåô ${moon.name}`;
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        focusMoon(key, idx);
                    });
                    moonButtonsDiv.appendChild(btn);
                });
            } else {
                moonContainer.style.display = 'none';
            }
        }

        function focusMoon(planetKey, moonIndex) {
            if (!moons[planetKey] || !moons[planetKey][moonIndex]) return;
            
            const moon = moons[planetKey][moonIndex];
            const planet = celestialBodies[planetKey];
            
            // Set target to follow the moon
            targetPlanet = planetKey;
            
            // Adjust camera distance to focus on moon
            cameraDistance = moon.radius * 20;
            
            // Update info panel
            document.getElementById('planet-name').textContent = moon.name;
            document.getElementById('planet-description').textContent = `A moon orbiting ${planet.data.name}`;
            
            const statsDiv = document.getElementById('planet-stats');
            statsDiv.innerHTML = '';
            const p = document.createElement('p');
            p.className = 'text-gray-400';
            p.innerHTML = `<strong>Radius:</strong> ${moon.radius.toFixed(1)} units<br><strong>Orbital Distance:</strong> ${moon.distance.toFixed(1)} units<br><strong>Orbital Speed:</strong> ${moon.speed.toFixed(3)} units/s`;
            statsDiv.appendChild(p);
            
            document.getElementById('fun-fact').classList.add('hidden');
            document.getElementById('mythology').classList.add('hidden');
            document.getElementById('science-info').classList.add('hidden');
            
            // Highlight the moon button
            document.querySelectorAll('#moon-buttons .planet-button').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === moonIndex);
            });
        }

        const buttonsContainer = document.getElementById('planet-buttons');
        Object.keys(planetData).forEach(key => {
            const btn = document.createElement('button');
            btn.id = `btn-${key}`;
            btn.className = 'planet-button w-full text-left px-3 py-2 rounded text-sm';
            btn.textContent = `${planetData[key].isDwarf ? 'ü™®' : key === 'sun' ? '‚≠ê' : 'ü™ê'} ${planetData[key].name}`;
            btn.addEventListener('click', () => focusPlanet(key));
            buttonsContainer.appendChild(btn);
        });

        focusPlanet('sun');

        document.getElementById('earth-weight').addEventListener('input', e => {
            const weight = parseFloat(e.target.value);
            if (targetPlanet && celestialBodies[targetPlanet]) {
                const planetWeight = weight * (celestialBodies[targetPlanet].data.gravity / 9.8);
                document.getElementById('weight-result').textContent = `Weight: ${planetWeight.toFixed(2)} kg`;
            }
        });

        function setCameraPreset(preset) {
            if (preset === 'overview') { cameraDistance = 600; cameraRotation = { x: Math.PI / 5, y: 0 }; targetPlanet = null; }
            else if (preset === 'top') { cameraDistance = 500; cameraRotation = { x: Math.PI / 2 - 0.1, y: 0 }; targetPlanet = null; }
            else if (preset === 'side') { cameraDistance = 500; cameraRotation = { x: 0, y: 0 }; targetPlanet = null; }
        }

        function startTour() {
            isTourActive = true; tourIndex = 0;
            focusPlanet(Object.keys(planetData)[tourIndex]);
        }

        function toggleOrbits() { showOrbits = !showOrbits; Object.values(orbits).forEach(o => o.visible = showOrbits); document.getElementById('toggle-orbits').classList.toggle('active', showOrbits); }
        function toggleTrails() { showTrails = !showTrails; Object.values(planetTrails).forEach(t => t.line.visible = showTrails); document.getElementById('toggle-trails').classList.toggle('active', showTrails); }
        function toggleLabels() { showLabels = !showLabels; Object.values(labels).forEach(l => l.visible = showLabels); document.getElementById('toggle-labels').classList.toggle('active', showLabels); }
        function toggleMoons() { showMoons = !showMoons; Object.values(moons).forEach(ma => ma.forEach(m => m.mesh.visible = showMoons)); if (issGroup) issGroup.visible = showMoons; document.getElementById('toggle-moons').classList.toggle('active', showMoons); }
        function toggleAsteroids() { showAsteroids = !showAsteroids; asteroidBelt.visible = showAsteroids; document.getElementById('toggle-asteroids').classList.toggle('active', showAsteroids); }
        function toggleDwarfPlanets() { showDwarfPlanets = !showDwarfPlanets; ['pluto', 'ceres'].forEach(k => { if (celestialBodies[k]) celestialBodies[k].mesh.visible = showDwarfPlanets; }); document.getElementById('toggle-dwarf').classList.toggle('active', showDwarfPlanets); }
        function toggleHabitableZone() { showHabitableZone = !showHabitableZone; habitableZoneInner.visible = habitableZoneOuter.visible = showHabitableZone; }
        function toggleLagrangePoints() { showLagrangePoints = !showLagrangePoints; lagrangePoints.forEach(p => p.visible = showLagrangePoints); }
        function toggleDayNight() { showDayNight = !showDayNight; }
        function toggleAxialTilt() { 
            showAxialTilt = !showAxialTilt; 
            Object.keys(celestialBodies).forEach(k => {
                if (k !== 'sun') celestialBodies[k].mesh.rotation.z = showAxialTilt ? (celestialBodies[k].data.tilt || 0) * Math.PI / 180 : 0;
            });
        }
        function toggleMiniMap() { showMiniMap = !showMiniMap; document.getElementById('mini-map').style.display = showMiniMap ? 'block' : 'none'; }
        function toggleCalculator() { const panel = document.getElementById('calculator-panel'); panel.style.display = panel.style.display === 'none' ? 'block' : 'none'; }
        function playSound() { soundEnabled = !soundEnabled; document.getElementById('sound-btn').textContent = soundEnabled ? 'üîä Sound ON' : 'üîá Sound OFF'; }
        function takeScreenshot() { renderer.render(scene, camera); const link = document.createElement('a'); link.download = 'solar-system.png'; link.href = renderer.domElement.toDataURL('image/png'); link.click(); }

        let animationSpeed = 1, time = 0, frameCount = 0, lastTime = performance.now();
        document.getElementById('speed-slider').addEventListener('input', e => { animationSpeed = parseFloat(e.target.value); document.getElementById('speed-display').textContent = `${animationSpeed.toFixed(1)}x`; });

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01; frameCount++;

            const now = performance.now();
            if (frameCount % 60 === 0) {
                const fps = Math.round(1000 / (now - lastTime) * 60);
                document.getElementById('fps-counter').textContent = fps;
                lastTime = now;
            }

            if (frameCount % 30 === 0) {
                simulationDate.setHours(simulationDate.getHours() + Math.abs(animationSpeed));
                document.getElementById('current-date').textContent = simulationDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                document.getElementById('earth-time').textContent = `Earth Time: ${simulationDate.toLocaleTimeString('en-US', { hour12: false })}`;
            }

            if (isTourActive && frameCount % 360 === 0) {
                tourIndex = (tourIndex + 1) % Object.keys(planetData).length;
                focusPlanet(Object.keys(planetData)[tourIndex]);
            }

            Object.keys(celestialBodies).forEach(key => {
                if (key === 'sun') { sun.rotation.y += 0.001 * animationSpeed; return; }
                const body = celestialBodies[key];
                body.angle += body.data.speed * animationSpeed;
                body.mesh.position.x = Math.cos(body.angle) * body.data.distance;
                body.mesh.position.z = Math.sin(body.angle) * body.data.distance;
                body.mesh.rotation.y += body.data.rotationSpeed * animationSpeed;

                if (moons[key]) {
                    moons[key].forEach(moon => {
                        moon.angle += moon.speed * animationSpeed;
                        moon.mesh.position.x = Math.cos(moon.angle) * moon.distance;
                        moon.mesh.position.z = Math.sin(moon.angle) * moon.distance;
                    });
                }
            });

            if (issGroup) {
                issAngle += 0.05 * animationSpeed;
                const d = 8.4;
                issGroup.position.set(Math.cos(issAngle) * d, Math.sin(issAngle * 1.3) * 1.5, Math.sin(issAngle) * d);
            }

            cometAngle += 0.006 * animationSpeed;
            cometGroup.position.set(Math.cos(cometAngle) * 230, Math.sin(cometAngle * 3.5) * 60, Math.sin(cometAngle) * 230);
            cometGroup.lookAt(0, 0, 0);

            asteroids.forEach(a => {
                a.angle += a.speed * animationSpeed;
                a.mesh.position.x = Math.cos(a.angle) * a.distance;
                a.mesh.position.z = Math.sin(a.angle) * a.distance;
                a.mesh.rotation.x += a.rotSpeed.x * animationSpeed;
                a.mesh.rotation.y += a.rotSpeed.y * animationSpeed;
            });

            let targetPos = { x: 0, y: 0, z: 0 };
            if (targetPlanet && celestialBodies[targetPlanet]) targetPos = celestialBodies[targetPlanet].mesh.position;

            const camX = targetPos.x + Math.cos(cameraRotation.y) * Math.cos(cameraRotation.x) * cameraDistance;
            const camY = targetPos.y + Math.sin(cameraRotation.x) * cameraDistance;
            const camZ = targetPos.z + Math.sin(cameraRotation.y) * Math.cos(cameraRotation.x) * cameraDistance;

            camera.position.x += (camX - camera.position.x) * 0.08;
            camera.position.y += (camY - camera.position.y) * 0.08;
            camera.position.z += (camZ - camera.position.z) * 0.08;
            camera.lookAt(targetPos.x, targetPos.y, targetPos.z);

            if (targetPlanet && celestialBodies[targetPlanet]) {
                const d = celestialBodies[targetPlanet].data.distance;
                document.getElementById('distance-indicator').textContent = `Distance from Sun: ${(d * 1.5).toFixed(0)} million km`;
                document.getElementById('speed-indicator').textContent = `Orbital Speed: ${(celestialBodies[targetPlanet].data.speed * 1000).toFixed(2)} units/s`;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        setTimeout(() => { const ls = document.getElementById('loading-screen'); ls.style.opacity = '0'; setTimeout(() => ls.style.display = 'none', 500); }, 1500);

        document.getElementById('total-objects').textContent = Object.keys(celestialBodies).length + asteroidCount + Object.values(moons).reduce((s, a) => s + a.length, 0);

        animate();
    </script>
</body>
</html>